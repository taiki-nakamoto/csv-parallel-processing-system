# æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼å¯¾å¿œ - JSONPathä¸æ•´åˆå•é¡Œ

## ğŸ“‹ åŸºæœ¬æƒ…å ±

- **å®Ÿæ–½æ—¥**: 2025å¹´8æœˆ7æ—¥
- **ãƒ†ã‚¹ãƒˆç¨®åˆ¥**: CSVä¸¦åˆ—å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆ
- **ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿå ´æ‰€**: Step Functions `CsvValidation`ã‚¹ãƒ†ãƒƒãƒ—
- **ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥**: `States.Runtime` - JSONPathè§£æã‚¨ãƒ©ãƒ¼
- **å¯¾å¿œæ‹…å½“**: ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ 

## ğŸš¨ ã‚¨ãƒ©ãƒ¼æ¦‚è¦

### ç™ºç”ŸçŠ¶æ³
- ãƒ†ã‚¹ãƒˆç”¨CSVãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ100ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰ã‚’S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†
- EventBridgeçµŒç”±ã§Step Functionsè‡ªå‹•å®Ÿè¡Œ
- **`CsvValidation`ã‚¹ãƒ†ãƒƒãƒ—ã§JSONPathã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹å³åº§å¤±æ•—**
- å®Ÿè¡Œæ™‚é–“: ã‚ãšã‹77msï¼ˆ22:59:52.704 â†’ 22:59:52.781ï¼‰

### å½±éŸ¿ç¯„å›²
- Step Functionså®Ÿè¡ŒãŒé–‹å§‹ç›´å¾Œã«åœæ­¢
- Lambdaé–¢æ•°ã¯å‘¼ã³å‡ºã•ã‚Œã¦ãŠã‚‰ãšã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†æœªå®Ÿè¡Œ
- Auroraãƒ»DynamoDBã¸ã®å½±éŸ¿ãªã—

## ğŸ” ã‚¨ãƒ©ãƒ¼èª¿æŸ»çµæœ

### 1. Step Functionså®Ÿè¡ŒçŠ¶æ³

**StateMachineæƒ…å ±:**
- **åå‰**: `csv-parallel-processing-csv-processing-dev`
- **å®Ÿè¡ŒARN**: `arn:aws:states:ap-northeast-1:526636471122:execution:csv-parallel-processing-csv-processing-dev:de12dc2c-eff5-8168-32d2-048ce2ed9cf7_12af6714-c3e9-f9a1-671e-f9cab3e6206f`
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: `FAILED`
- **å®Ÿè¡Œæ™‚é–“**: 77msï¼ˆå³åº§å¤±æ•—ï¼‰

### 2. ã‚¨ãƒ©ãƒ¼è©³ç´°

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
States.Runtime
An error occurred while executing the state 'CsvValidation' (entered at the event id #4). 
The JSONPath '$.bucketName' specified for the field 'bucketName.$' could not be found in the input
```

**æœŸå¾…ã•ã‚ŒãŸJSONPath:**
```json
"bucketName.$": "$.bucketName"
```

**å®Ÿéš›ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿:**
```json
{
  "bucket": "csv-processing-526636471122-dev",          // â† bucketNameã§ã¯ãªãbucket
  "key": "test-user-stats-20250807-100records.csv",
  "size": 1309,
  "eventTime": "$.time",
  "eventSource": "s3.amazonaws.com",
  "processingStatus": {
    "status": "started",
    "timestamp": "$$.State.EnteredTime"
  }
}
```

### 3. æ ¹æœ¬åŸå› åˆ†æ

**å•é¡Œ**: EventBridge â†’ Step Functionsã®ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°ä¸æ•´åˆ
- **EventBridgeé€ä¿¡ãƒ‡ãƒ¼ã‚¿**: `bucket`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
- **Step FunctionsæœŸå¾…å€¤**: `bucketName`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰  
- **çµæœ**: JSONPath `$.bucketName`ãŒè§£æã§ããšãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼

## ğŸ› ï¸ ä¿®æ­£å¯¾å¿œ

### Phase 1: Step Functionså®šç¾©ä¿®æ­£

**ä¿®æ­£ç®‡æ‰€**: `sam/statemachine/csv-processing-workflow.asl.json`

**ä¿®æ­£å‰:**
```json
"Parameters": {
  "eventType": "csv-validation",
  "bucketName.$": "$.bucketName",           // â† å­˜åœ¨ã—ãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‚ç…§
  "objectKey.$": "$.objectKey",
  "processingId.$": "$$.Execution.Name"
}
```

**ä¿®æ­£å¾Œ:**
```json
"Parameters": {
  "eventType": "csv-validation", 
  "bucketName.$": "$.bucket",               // â† å®Ÿéš›ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«ä¿®æ­£
  "objectKey.$": "$.key",                   // â† ã“ã¡ã‚‰ã‚‚ä¿®æ­£å¿…è¦
  "processingId.$": "$$.Execution.Name"
}
```

### Phase 2: å…¨JSONPathå‚ç…§ã®ä¿®æ­£

**ä»–ã®ä¿®æ­£å¿…è¦ç®‡æ‰€:**
1. **SingleChunkProcessing**ã‚¹ãƒ†ãƒƒãƒ—
2. **DistributedMapProcessing**ã‚¹ãƒ†ãƒƒãƒ—å†…
3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**ã‚¹ãƒ†ãƒƒãƒ—ç¾¤

**çµ±ä¸€ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³:**
- `$.bucketName` â†’ `$.bucket`
- `$.objectKey` â†’ `$.key`

### Phase 3: SAMå†ãƒ‡ãƒ—ãƒ­ã‚¤

**å®Ÿè¡Œæ‰‹é †:**
```bash
cd sam
sam build
sam deploy --no-confirm-changeset
```

## ğŸ“ ä¿®æ­£å®Ÿæ–½è¨˜éŒ²

### å®Ÿè¡Œæ™‚åˆ»
- **ãƒ†ã‚¹ãƒˆé–‹å§‹**: 2025-08-07 22:59:52
- **ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ**: 2025-08-07 22:59:52 (77mså¾Œ)
- **ã‚¨ãƒ©ãƒ¼èª¿æŸ»é–‹å§‹**: 2025-08-07 23:05:00
- **æ ¹æœ¬åŸå› ç‰¹å®š**: 2025-08-07 23:10:00

### ã‚¨ãƒ©ãƒ¼è©³ç´°
**Step Functionså®Ÿè¡ŒARN:**
```
arn:aws:states:ap-northeast-1:526636471122:execution:csv-parallel-processing-csv-processing-dev:de12dc2c-eff5-8168-32d2-048ce2ed9cf7_12af6714-c3e9-f9a1-671e-f9cab3e6206f
```

**å®Œå…¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
States.Runtime: An error occurred while executing the state 'CsvValidation' (entered at the event id #4). The JSONPath '$.bucketName' specified for the field 'bucketName.$' could not be found in the input '{"bucket":"csv-processing-526636471122-dev","key":"test-user-stats-20250807-100records.csv","size":1309,"eventTime":"$.time","eventSource":"s3.amazonaws.com","processingStatus":{"status":"started","timestamp":"$$.State.EnteredTime"}}'
```

**EventBridgeå…¥åŠ›ãƒ‡ãƒ¼ã‚¿:**
```json
{
  "bucket": "csv-processing-526636471122-dev",
  "key": "test-user-stats-20250807-100records.csv", 
  "size": 1309,
  "eventTime": "$.time",
  "eventSource": "s3.amazonaws.com"
}
```

## ğŸ”§ ä¿®æ­£å†…å®¹è©³ç´°

### ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `sam/statemachine/csv-processing-workflow.asl.json`

### ä¿®æ­£ç®‡æ‰€ä¸€è¦§

#### 1. CsvValidationã‚¹ãƒ†ãƒƒãƒ—
```json
// ä¿®æ­£å‰
"Parameters": {
  "eventType": "csv-validation",
  "bucketName.$": "$.bucketName",
  "objectKey.$": "$.objectKey", 
  "processingId.$": "$$.Execution.Name"
}

// ä¿®æ­£å¾Œ
"Parameters": {
  "eventType": "csv-validation",
  "bucketName.$": "$.bucket",
  "objectKey.$": "$.key",
  "processingId.$": "$$.Execution.Name"  
}
```

#### 2. SingleChunkProcessingã‚¹ãƒ†ãƒƒãƒ—
```json
// ä¿®æ­£å‰
"Parameters": {
  "eventType": "csv-chunk-processing",
  "bucketName.$": "$.originalInput.bucketName",
  "objectKey.$": "$.originalInput.objectKey",
  // ...
}

// ä¿®æ­£å¾Œ  
"Parameters": {
  "eventType": "csv-chunk-processing", 
  "bucketName.$": "$.originalInput.bucket",
  "objectKey.$": "$.originalInput.key",
  // ...
}
```

#### 3. åˆ†æ•£ãƒãƒƒãƒ—å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—
```json
// ä¿®æ­£å‰
"Parameters": {
  "bucketName.$": "$.originalInput.bucketName",
  "objectKey.$": "$.originalInput.objectKey",
  // ...
}

// ä¿®æ­£å¾Œ
"Parameters": {
  "bucketName.$": "$.originalInput.bucket", 
  "objectKey.$": "$.originalInput.key",
  // ...
}
```

### æ¤œè¨¼çµæœ

**ä¿®æ­£å®Œäº†å¾Œã®å†ãƒ†ã‚¹ãƒˆ:**
- [ ] Step Functionsæ­£å¸¸å®Ÿè¡Œç¢ºèª
- [ ] Lambdaé–¢æ•°å‘¼ã³å‡ºã—ç¢ºèª  
- [ ] Auroraçµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°ç¢ºèª
- [ ] DynamoDBç›£æŸ»ãƒ­ã‚°è¨˜éŒ²ç¢ºèª

## ğŸ”„ å†ç™ºé˜²æ­¢ç­–

### 1. ãƒ‡ãƒ¼ã‚¿å¥‘ç´„ã®æ˜æ–‡åŒ–
- EventBridge â†’ Step Functionså…¥åŠ›ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®ä»•æ§˜æ›¸ä½œæˆ
- JSONPathå‚ç…§ã®æ¨™æº–åŒ–

### 2. ãƒ†ã‚¹ãƒˆæ®µéšã§ã®ç¢ºèªå¼·åŒ–  
- Step Functionså®šç¾©ã®å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè£…
- EventBridgeå…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

### 3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™
- EventBridgeå…¥åŠ›å¤‰æ›è¨­å®šã®æ–‡æ›¸åŒ–
- Step Functions JSONPathå‚ç…§ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ä½œæˆ

## ğŸ“Š å¯¾å¿œå®Œäº†ãƒã‚§ãƒƒã‚¯

### ã‚¨ãƒ©ãƒ¼å¯¾å¿œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
- [x] **èª¿æŸ»å®Œäº†**: JSONPathä¸æ•´åˆå•é¡Œã®ç‰¹å®šå®Œäº†
- [ ] **ä¿®æ­£å®Œäº†**: Step Functionså®šç¾©ä¿®æ­£ãƒ»SAMå†ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
- [ ] **æ¤œè¨¼å®Œäº†**: ä¿®æ­£ç‰ˆã§ã®æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆæˆåŠŸç¢ºèª
- [ ] **æ–‡æ›¸åŒ–å®Œäº†**: å¯¾å¿œå†…å®¹ãƒ»å†ç™ºé˜²æ­¢ç­–è¨˜éŒ²å®Œäº†

### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. **å³åº§å®Ÿæ–½**: Step Functionså®šç¾©ã®JSONPathä¿®æ­£
2. **SAMå†ãƒ‡ãƒ—ãƒ­ã‚¤**: ä¿®æ­£ç‰ˆã®é©ç”¨
3. **å†ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**: CSVãƒ•ã‚¡ã‚¤ãƒ«å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ã®å‹•ä½œç¢ºèª

---

**çµè«–**: EventBridgeã¨Step Functionsã®ãƒ‡ãƒ¼ã‚¿å¥‘ç´„ä¸æ•´åˆãŒåŸå› ã€‚JSONPathå‚ç…§ã‚’ `$.bucketName` â†’ `$.bucket`ã€`$.objectKey` â†’ `$.key` ã«ä¿®æ­£ã™ã‚‹ã“ã¨ã§è§£æ±ºå¯èƒ½ã€‚