# 正常系テストエラー対応 - JSONPath不整合問題

## 📋 基本情報

- **実施日**: 2025年8月7日
- **テスト種別**: CSV並列処理システム正常系テスト
- **エラー発生場所**: Step Functions `CsvValidation`ステップ
- **エラー種別**: `States.Runtime` - JSONPath解析エラー
- **対応担当**: システム開発チーム

## 🚨 エラー概要

### 発生状況
- テスト用CSVファイル（100レコード）をS3にアップロード完了
- EventBridge経由でStep Functions自動実行
- **`CsvValidation`ステップでJSONPathエラーによる即座失敗**
- 実行時間: わずか77ms（22:59:52.704 → 22:59:52.781）

### 影響範囲
- Step Functions実行が開始直後に停止
- Lambda関数は呼び出されておらず、データ処理未実行
- Aurora・DynamoDBへの影響なし

## 🔍 エラー調査結果

### 1. Step Functions実行状況

**StateMachine情報:**
- **名前**: `csv-parallel-processing-csv-processing-dev`
- **実行ARN**: `arn:aws:states:ap-northeast-1:526636471122:execution:csv-parallel-processing-csv-processing-dev:de12dc2c-eff5-8168-32d2-048ce2ed9cf7_12af6714-c3e9-f9a1-671e-f9cab3e6206f`
- **ステータス**: `FAILED`
- **実行時間**: 77ms（即座失敗）

### 2. エラー詳細

**エラーメッセージ:**
```
States.Runtime
An error occurred while executing the state 'CsvValidation' (entered at the event id #4). 
The JSONPath '$.bucketName' specified for the field 'bucketName.$' could not be found in the input
```

**期待されたJSONPath:**
```json
"bucketName.$": "$.bucketName"
```

**実際の入力データ:**
```json
{
  "bucket": "csv-processing-526636471122-dev",          // ← bucketNameではなくbucket
  "key": "test-user-stats-20250807-100records.csv",
  "size": 1309,
  "eventTime": "$.time",
  "eventSource": "s3.amazonaws.com",
  "processingStatus": {
    "status": "started",
    "timestamp": "$$.State.EnteredTime"
  }
}
```

### 3. 根本原因分析

**問題**: EventBridge → Step Functionsのデータマッピング不整合
- **EventBridge送信データ**: `bucket`フィールド
- **Step Functions期待値**: `bucketName`フィールド  
- **結果**: JSONPath `$.bucketName`が解析できずランタイムエラー

## 🛠️ 修正対応

### Phase 1: Step Functions定義修正

**修正箇所**: `sam/statemachine/csv-processing-workflow.asl.json`

**修正前:**
```json
"Parameters": {
  "eventType": "csv-validation",
  "bucketName.$": "$.bucketName",           // ← 存在しないフィールド参照
  "objectKey.$": "$.objectKey",
  "processingId.$": "$$.Execution.Name"
}
```

**修正後:**
```json
"Parameters": {
  "eventType": "csv-validation", 
  "bucketName.$": "$.bucket",               // ← 実際のフィールド名に修正
  "objectKey.$": "$.key",                   // ← こちらも修正必要
  "processingId.$": "$$.Execution.Name"
}
```

### Phase 2: 全JSONPath参照の修正

**他の修正必要箇所:**
1. **SingleChunkProcessing**ステップ
2. **DistributedMapProcessing**ステップ内
3. **エラーハンドリング**ステップ群

**統一修正パターン:**
- `$.bucketName` → `$.bucket`
- `$.objectKey` → `$.key`

### Phase 3: SAM再デプロイ

**実行手順:**
```bash
cd sam
sam build
sam deploy --no-confirm-changeset
```

## 📝 修正実施記録

### 実行時刻
- **テスト開始**: 2025-08-07 22:59:52
- **エラー発生**: 2025-08-07 22:59:52 (77ms後)
- **エラー調査開始**: 2025-08-07 23:05:00
- **根本原因特定**: 2025-08-07 23:10:00

### エラー詳細
**Step Functions実行ARN:**
```
arn:aws:states:ap-northeast-1:526636471122:execution:csv-parallel-processing-csv-processing-dev:de12dc2c-eff5-8168-32d2-048ce2ed9cf7_12af6714-c3e9-f9a1-671e-f9cab3e6206f
```

**完全エラーメッセージ:**
```
States.Runtime: An error occurred while executing the state 'CsvValidation' (entered at the event id #4). The JSONPath '$.bucketName' specified for the field 'bucketName.$' could not be found in the input '{"bucket":"csv-processing-526636471122-dev","key":"test-user-stats-20250807-100records.csv","size":1309,"eventTime":"$.time","eventSource":"s3.amazonaws.com","processingStatus":{"status":"started","timestamp":"$$.State.EnteredTime"}}'
```

**EventBridge入力データ:**
```json
{
  "bucket": "csv-processing-526636471122-dev",
  "key": "test-user-stats-20250807-100records.csv", 
  "size": 1309,
  "eventTime": "$.time",
  "eventSource": "s3.amazonaws.com"
}
```

## 🔧 修正内容詳細

### 修正対象ファイル
- `sam/statemachine/csv-processing-workflow.asl.json`

### 修正箇所一覧

#### 1. CsvValidationステップ
```json
// 修正前
"Parameters": {
  "eventType": "csv-validation",
  "bucketName.$": "$.bucketName",
  "objectKey.$": "$.objectKey", 
  "processingId.$": "$$.Execution.Name"
}

// 修正後
"Parameters": {
  "eventType": "csv-validation",
  "bucketName.$": "$.bucket",
  "objectKey.$": "$.key",
  "processingId.$": "$$.Execution.Name"  
}
```

#### 2. SingleChunkProcessingステップ
```json
// 修正前
"Parameters": {
  "eventType": "csv-chunk-processing",
  "bucketName.$": "$.originalInput.bucketName",
  "objectKey.$": "$.originalInput.objectKey",
  // ...
}

// 修正後  
"Parameters": {
  "eventType": "csv-chunk-processing", 
  "bucketName.$": "$.originalInput.bucket",
  "objectKey.$": "$.originalInput.key",
  // ...
}
```

#### 3. 分散マップ処理ステップ
```json
// 修正前
"Parameters": {
  "bucketName.$": "$.originalInput.bucketName",
  "objectKey.$": "$.originalInput.objectKey",
  // ...
}

// 修正後
"Parameters": {
  "bucketName.$": "$.originalInput.bucket", 
  "objectKey.$": "$.originalInput.key",
  // ...
}
```

### 検証結果

**修正完了後の再テスト:**
- [ ] Step Functions正常実行確認
- [ ] Lambda関数呼び出し確認  
- [ ] Aurora統計データ更新確認
- [ ] DynamoDB監査ログ記録確認

## 🔄 再発防止策

### 1. データ契約の明文化
- EventBridge → Step Functions入力データ形式の仕様書作成
- JSONPath参照の標準化

### 2. テスト段階での確認強化  
- Step Functions定義の単体テスト実装
- EventBridge入力データでのテスト実行

### 3. ドキュメント整備
- EventBridge入力変換設定の文書化
- Step Functions JSONPath参照ガイドライン作成

## 📊 対応完了チェック

### エラー対応ステータス
- [x] **調査完了**: JSONPath不整合問題の特定完了
- [ ] **修正完了**: Step Functions定義修正・SAM再デプロイ完了
- [ ] **検証完了**: 修正版での正常系テスト成功確認
- [ ] **文書化完了**: 対応内容・再発防止策記録完了

### 次のアクション
1. **即座実施**: Step Functions定義のJSONPath修正
2. **SAM再デプロイ**: 修正版の適用
3. **再テスト実行**: CSVファイル再アップロードでの動作確認

---

**結論**: EventBridgeとStep Functionsのデータ契約不整合が原因。JSONPath参照を `$.bucketName` → `$.bucket`、`$.objectKey` → `$.key` に修正することで解決可能。