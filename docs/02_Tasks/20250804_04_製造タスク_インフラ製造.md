# CSVファイル並列処理システム 製造タスク_インフラ製造

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| ドキュメント名 | 製造タスク_インフラ製造 |
| バージョン | 1.0 |
| 作成日 | 2025-08-04 |
| 作成者 | システム開発チーム |
| 更新日 | 2025-08-04 |
| 分割元 | 20250804_01_製造タスク管理.md |

## 2. インフラ製造概要

### 2.1 インフラ製造の位置付け
製造準備フェーズ完了後の第二段階として、以下のインフラ製造を実施します：

1. **Terraform基盤構築**: プロバイダー設定、Backend設定、共通モジュール作成 ✅完了
2. **ネットワークインフラ構築**: VPC、サブネット、セキュリティグループ ✅完了
3. **データベースインフラ構築**: Aurora PostgreSQL、DynamoDB ✅完了
4. **ストレージインフラ構築**: S3バケット、ライフサイクルポリシー ✅完了
5. **監視・ログインフラ構築**: CloudWatch Logs（個人開発向け） ✅完了
6. **IAMロール・ポリシー構築**: Step Functions用、Lambda用ロール ✅完了

### 2.2 参照ドキュメント
- **AWS環境準備完了**: `20250804_11_製造タスク_AWS環境準備.md`
- **GitHub環境準備**: `20250804_12_製造タスク_GitHub環境準備.md`
- **詳細設計**: `03-01_詳細設計書_インフラ詳細設計.md`
- **S3バケット設計**: `02-05_基本設計書_S3バケット設計.md`

## 3. インフラ製造フェーズ ⏳進行中

### 3.1 Terraform基盤構築 ✅完了

#### プロジェクト初期化 ✅完了
- [x] **Terraformプロジェクト初期化**
  - [x] プロバイダー設定（AWS Provider）
  - [x] Backend設定（S3）
  - [x] Variables定義ファイル作成
  - [x] Output定義ファイル作成

#### Backend設定詳細
```hcl
terraform {
  required_version = ">= 1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "5.31.0"
    }
  }
  
  backend "s3" {
    bucket  = "naka-enginner-tfstate"
    key     = "05_csv-batch/dev/terraform.tfstate"
    region  = "ap-northeast-1"
    encrypt = true
    # DynamoDB State Lockは使用しない
  }
}

provider "aws" {
  region = var.aws_region
  
  default_tags {
    tags = {
      Project     = "csv-batch"
      Environment = var.environment
      ManagedBy   = "terraform"
    }
  }
}
```

#### 共通モジュール作成 ✅完了
- [x] **ネットワークモジュール**（VPC、Subnet、Security Group）
  - [x] VPCモジュール作成 (`modules/network/main.tf`)
  - [x] サブネットモジュール作成（パブリック・プライベート・Aurora用）
  - [x] セキュリティグループモジュール（Lambda・Aurora・VPCエンドポイント用）
  - [x] ルートテーブルモジュール（パブリック・プライベート）

- [x] **IAMモジュール**（ロール、ポリシー）
  - [x] Lambda実行ロール (`modules/iam/main.tf`)
  - [x] Step Functions実行ロール（分散マップ対応）
  - [x] カスタムポリシー（VPC・S3・DynamoDB・RDS・CloudWatch・X-Ray）

- [x] **S3モジュール**（バケットポリシー、CORS設定）
  - [x] 統合S3バケット作成 (`modules/s3/main.tf`)
  - [x] バケットポリシー設定（最小権限の原則）
  - [x] ライフサイクルポリシー（30日保存、7日でStandard IA移行）

- [x] **DynamoDBモジュール**（テーブル定義）
  - [x] DynamoDBテーブル作成 (`modules/dynamodb/main.tf`)
  - [x] グローバルセカンダリインデックス（FileNameIndex・StatusIndex）
  - [x] TTL設定（90日後自動削除）

- [x] **CloudWatchモジュール**（ログ、メトリクス、アラーム）
  - [x] ロググループ作成 (`modules/cloudwatch/main.tf`)
  - [x] アラーム設定（Lambda・StepFunctions・DynamoDB）
  - [x] ダッシュボード・X-Rayサンプリングルール

### 3.2 ネットワークインフラ構築 ✅完了

#### VPC構築 ✅完了
**参照**: 03-11_詳細設計書_セキュリティ詳細設計.md (セキュリティ詳細設計書準拠)

- [x] **VPC作成** (10.0.1.0/24) - 設計書通りに実装
  ```hcl
  resource "aws_vpc" "csv_batch_vpc" {
    cidr_block           = "10.0.1.0/24"
    enable_dns_hostnames = true
    enable_dns_support   = true
    
    tags = {
      Name = "csv-batch-vpc-${var.environment}"
    }
  }
  ```

- [x] **サブネット作成** - 2AZ構成で実装
  - [x] パブリックサブネット作成 (10.0.1.192/26) - NAT Gateway用
  ```hcl
  resource "aws_subnet" "public_subnet" {
    vpc_id                  = aws_vpc.csv_batch_vpc.id
    cidr_block              = "10.0.1.192/26"
    availability_zone       = "${var.aws_region}a"
    map_public_ip_on_launch = true
    
    tags = {
      Name = "csv-batch-public-subnet-${var.environment}"
      Type = "Public"
      AZ   = "1a"
    }
  }
  ```
  
  - [x] プライベートサブネット1作成 (10.0.1.0/26) - AZ-1a: Lambda, Aurora Primary
  ```hcl
  resource "aws_subnet" "private_subnet" {
    vpc_id            = aws_vpc.csv_batch_vpc.id
    cidr_block        = "10.0.1.0/26"
    availability_zone = "${var.aws_region}a"
    
    tags = {
      Name = "csv-batch-private-subnet-1a-${var.environment}"
      Type = "Private"
      AZ   = "1a"
    }
  }
  ```

  - [x] プライベートサブネット2作成 (10.0.1.64/26) - AZ-1c: Aurora Replica
  ```hcl
  resource "aws_subnet" "private_subnet_2" {
    vpc_id            = aws_vpc.csv_batch_vpc.id
    cidr_block        = "10.0.1.64/26"
    availability_zone = "${var.aws_region}c"
    
    tags = {
      Name = "csv-batch-private-subnet-1c-${var.environment}"
      Type = "Private"
      AZ   = "1c"
    }
  }
  ```

- [x] **ゲートウェイ構築**
  - [x] インターネットゲートウェイ作成
  ```hcl
  resource "aws_internet_gateway" "csv_batch_igw" {
    vpc_id = aws_vpc.csv_batch_vpc.id
    
    tags = {
      Name = "csv-batch-igw-${var.environment}"
    }
  }
  ```
  
  - [x] NATゲートウェイ作成
  ```hcl
  resource "aws_nat_gateway" "csv_batch_nat" {
    allocation_id = aws_eip.nat_eip.id
    subnet_id     = aws_subnet.public_subnet.id
    
    tags = {
      Name = "csv-batch-nat-${var.environment}"
    }
  }
  ```

- [x] **ルートテーブル作成・関連付け**
  - [x] パブリックルートテーブル - IGW経由のインターネット接続
  - [x] プライベートルートテーブル - NAT Gateway経由のアウトバウンド接続
  - [x] サブネットとの関連付け（3つのサブネット全て）

#### セキュリティグループ構築 ✅完了
- [x] **Lambda用セキュリティグループ** - 詳細設計書準拠
  ```hcl
  resource "aws_security_group" "lambda_sg" {
    name        = "csv-lambda-sg-${var.environment}"
    description = "Security group for Lambda functions"
    vpc_id      = aws_vpc.csv_batch_vpc.id
    
    # Aurora PostgreSQLへのアクセス許可（5432）
    egress {
      from_port   = 5432
      to_port     = 5432
      protocol    = "tcp"
      cidr_blocks = [
        var.private_subnet_cidr, 
        var.private_subnet_2_cidr
      ]
    }
    
    # HTTPSアウトバウンド（AWS APIアクセス用）
    egress {
      from_port   = 443
      to_port     = 443
      protocol    = "tcp"
      cidr_blocks = ["0.0.0.0/0"]
    }
    
    # HTTPアウトバウンド（パッケージダウンロード等）
    egress {
      from_port   = 80
      to_port     = 80
      protocol    = "tcp"
      cidr_blocks = ["0.0.0.0/0"]
    }
  }
  ```

- [x] **Aurora用セキュリティグループ** - 詳細設計書準拠
  ```hcl
  resource "aws_security_group" "aurora_sg" {
    name        = "csv-aurora-sg-${var.environment}"
    description = "Security group for Aurora PostgreSQL cluster"
    vpc_id      = aws_vpc.csv_batch_vpc.id
    
    # Lambdaからのアクセス許可
    ingress {
      from_port       = 5432
      to_port         = 5432
      protocol        = "tcp"
      security_groups = [aws_security_group.lambda_sg.id]
    }
  }
  ```

- [x] **VPCエンドポイント用セキュリティグループ**
  ```hcl
  resource "aws_security_group" "vpc_endpoint_sg" {
    name        = "csv-vpce-sg-${var.environment}"
    description = "Security group for VPC Endpoints"
    vpc_id      = aws_vpc.csv_batch_vpc.id
    
    # Lambdaからのアクセス許可
    ingress {
      from_port       = 443
      to_port         = 443
      protocol        = "tcp"
      security_groups = [aws_security_group.lambda_sg.id]
    }
  }
  ```

#### VPCエンドポイント構築 ✅完了
- [x] **S3 Gateway Endpoint** - プライベートサブネットからのS3アクセス
- [x] **DynamoDB Gateway Endpoint** - プライベートサブネットからのDynamoDBアクセス

### 3.3 データベースインフラ構築 ✅完了

#### Aurora PostgreSQL構築 ✅完了
**参照**: 03-14_詳細設計書_データモデル詳細設計.md

- [x] **DBサブネットグループ作成**
  ```hcl
  resource "aws_db_subnet_group" "aurora_subnet_group" {
    name       = "csv-batch-aurora-subnet-group-${var.environment}"
    subnet_ids = [aws_subnet.private_subnet.id, aws_subnet.private_subnet_2.id]
    
    tags = {
      Name = "Aurora DB Subnet Group"
    }
  }
  ```

- [x] **DBパラメータグループ作成** (PostgreSQL 17対応)
  ```hcl
  resource "aws_db_parameter_group" "aurora_pg" {
    family = "aurora-postgresql17"
    name   = "csv-batch-aurora-pg-${var.environment}"
    
    parameter {
      name  = "shared_preload_libraries"
      value = "pg_stat_statements"
    }
    parameter {
      name  = "log_statement"
      value = "all"
    }
    parameter {
      name  = "log_min_duration_statement"
      value = "1000"
    }
  }
  ```

- [x] **Aurora Serverless v2クラスター作成** (PostgreSQL 17.5)
  ```hcl
  resource "aws_rds_cluster" "csv_batch_cluster" {
    cluster_identifier     = "${var.project_name}-aurora-${var.environment}"
    engine                = "aurora-postgresql"
    engine_version        = "17.5"
    database_name         = "csvbatch"
    master_username       = "postgres"
    manage_master_user_password = true
    
    vpc_security_group_ids = [module.network.aurora_security_group_id]
    db_subnet_group_name   = aws_db_subnet_group.aurora_subnet_group.name
    
    serverlessv2_scaling_configuration {
      max_capacity = var.environment == "prod" ? 4.0 : 2.0
      min_capacity = var.environment == "prod" ? 1.0 : 0.5
    }
    
    backup_retention_period = var.environment == "prod" ? 14 : 7
    backup_window          = "03:00-04:00"
    maintenance_window     = "sun:04:00-sun:05:00"
    
    storage_encrypted = true
    enabled_cloudwatch_logs_exports = ["postgresql"]
    
    skip_final_snapshot = var.environment == "dev" ? true : false
  }
  ```

- [x] **データベース・テーブル作成** (設計書完全準拠)
  - [x] 初期スキーマ作成SQLスクリプト (terraform/modules/aurora/init-schema.sql)
  - [x] テーブル作成（users, user_statistics, processing_executions, file_processing_results, batch_processing_logs, system_configurations）
  - [x] インデックス作成（性能最適化、GINインデックス含む）
  - [x] 制約・トリガー・関数作成
  - [x] ビュー作成（v_execution_statistics, v_user_statistics_ranking）

- [x] **初期データ投入**
  - [x] システム設定データ投入（max_parallel_executions等）
  - [x] 設定値取得・統計更新関数作成

#### DynamoDB構築 ✅完了
- [x] **監査ログテーブル作成** (`audit_logs`) - 設計書準拠
  ```hcl
  resource "aws_dynamodb_table" "audit_logs" {
    name           = "${var.project_name}-audit-logs-${var.environment}"
    billing_mode   = "PAY_PER_REQUEST"
    hash_key       = "execution_id"
    range_key      = "timestamp"
    
    # LogLevelIndex, EventTypeIndex GSI
    # TTL設定（90日後自動削除）
    # ポイントインタイムリカバリ・暗号化有効
  }
  ```

- [x] **処理メタデータテーブル作成** (`processing_metadata`) - 設計書準拠
  ```hcl
  resource "aws_dynamodb_table" "processing_metadata" {
    name           = "${var.project_name}-processing-metadata-${var.environment}"
    billing_mode   = "PAY_PER_REQUEST"
    hash_key       = "file_id"
    range_key      = "processing_stage"
    
    # ProcessingStageIndex GSI
    # TTL設定（30日後自動削除）
  }
  ```

- [x] **バッチジョブ管理テーブル更新** (`batch_jobs`)
- [x] **ジョブロック管理テーブル更新** (`job_locks`)

- [x] **グローバルセカンダリインデックス作成**
  - [x] LogLevelIndex (log_level + timestamp)
  - [x] EventTypeIndex (event_type + timestamp)  
  - [x] ProcessingStageIndex (processing_stage + created_at)
  - [x] status-created_at-index (batch_jobs用)
  - [x] file_name-created_at-index (batch_jobs用)

- [x] **TTL設定**（ログ自動削除）
  - [x] 監査ログ: 90日後自動削除
  - [x] 処理メタデータ: 30日後自動削除
  - [x] バッチジョブ: 90日後自動削除
  - [x] ジョブロック: expires_at属性で自動解除

- [x] **セキュリティ設定**
  - [x] 全テーブルでポイントインタイムリカバリ有効
  - [x] 全テーブルでサーバーサイド暗号化有効
  - [x] KMS暗号化対応（オプション）

### 3.4 ストレージインフラ構築 ✅完了

#### S3バケット構築 ✅完了
**参照**: 02-05_基本設計書_S3バケット設計.md

- [x] **統合バケット** (`csv-processing-{account-id}`) - 設計書準拠
  ```hcl
  resource "aws_s3_bucket" "processing" {
    bucket = "csv-processing-${data.aws_caller_identity.current.account_id}-${var.environment}"
    
    # 設計書準拠のタグ設定
    tags = {
      DataClassification = "Internal"
      Project           = "CSV-Processing"
      CostCenter        = "IT-Operations"
      Owner             = "data-platform-team"
    }
  }
  ```

- [x] **バケット基本設定**
  - [x] バージョニング有効化
  - [x] SSE-S3暗号化（バケットキー有効）
  - [x] 公開アクセス完全ブロック
  - [x] EventBridge通知設定

- [x] **バケットポリシー・CORS設定** - セキュリティ強化
  ```hcl
  resource "aws_s3_bucket_policy" "processing" {
    # DenyInsecureConnections: HTTPS必須
    # AllowStepFunctionsAccess: Step Functions許可
    # AllowLambdaAccess: Lambda関数許可
  }
  
  resource "aws_s3_bucket_cors_configuration" "processing" {
    # 外部システムアップロード対応
    allowed_methods = ["PUT", "POST"]
    allowed_origins = var.cors_allowed_origins
  }
  ```

- [x] **統一ライフサイクルポリシー設定** - 設計書準拠
  ```hcl
  # UnifiedLifecycle: 7日後Standard-IA、30日後削除
  # DeleteFailedFiles: input/failed/ 30日後削除
  # DeleteProcessedFiles: input/processed/ 7日後削除
  # 未完了マルチパートアップロード: 7日後削除
  ```

- [x] **監視・メトリクス設定**
  - [x] CloudWatchメトリクス（EntireBucket, IncomingFiles, ProcessingFiles）
  - [x] インテリジェントティアリング設定
  - [x] ディレクトリ構造サポート（input/, output/）

### 3.5 監視・ログインフラ構築 ✅完了

#### CloudWatch構築 ✅完了
**参照**: 03-12_詳細設計書_監視・ログ詳細設計.md
**注意**: 個人開発のため、CloudWatch Logsのみ実装（アラート・通知・ダッシュボード・X-Ray等は実装しない）

- [x] **ロググループ作成** - 個人開発向けに簡素化（4つのロググループ）
  ```hcl
  # Lambda関数ログ
  resource "aws_cloudwatch_log_group" "lambda_logs" {
    name              = "/aws/lambda/csv-processor-${var.environment}"
    retention_in_days = 30  # 個人開発用に30日間
  }
  
  # Step Functionsログ
  resource "aws_cloudwatch_log_group" "stepfunctions_logs" {
    name              = "/aws/stepfunctions/csv-processing-${var.environment}"
    retention_in_days = 30
  }
  
  # アプリケーションログ
  resource "aws_cloudwatch_log_group" "application_logs" {
    name              = "/csv-processing/application-${var.environment}"
    retention_in_days = 30
  }
  
  # システムログ（デバッグ用）
  resource "aws_cloudwatch_log_group" "system_logs" {
    name              = "/csv-processing/system-${var.environment}"
    retention_in_days = 30
  }
  ```

- [x] **個人開発方針確定**
  - [x] CloudWatch Logsのみ実装
  - [x] アラート・通知・ダッシュボード・X-Rayは実装しない
  - [x] コスト重視の30日間ログ保存
  - [x] デバッグ・トラブルシューティング支援に特化

#### 実装対象外（個人開発）
以下は設計書に記載されていますが、個人開発では実装しません：
- **CloudWatchアラーム**: エラー率・実行時間・スロットリング監視
- **SNSトピック**: アラート通知設定
- **CloudWatchダッシュボード**: メトリクス可視化
- **X-Ray設定**: 分散トレーシング・サービスマップ

### 3.6 IAMロール・ポリシー構築 ✅完了

#### Step Functions用IAMロール ✅完了
**参照**: 03-01_詳細設計書_インフラ詳細設計.md

- [x] **Step Functions実行ロール作成** - 設計書準拠で実装
  ```hcl
  resource "aws_iam_role" "step_functions_execution_role" {
    name = "csv-stepfunctions-execution-role-${var.environment}"
    
    assume_role_policy = jsonencode({
      Version = "2012-10-17"
      Statement = [
        {
          Action = "sts:AssumeRole"
          Effect = "Allow"
          Principal = {
            Service = "states.amazonaws.com"
          }
        }
      ]
    })
  }
  ```

- [x] **Step Functions実行ポリシー作成** - 設計書の全権限を実装
  ```hcl
  resource "aws_iam_role_policy" "step_functions_execution_policy" {
    name = "csv-stepfunctions-execution-policy-${var.environment}"
    
    policy = jsonencode({
      Version = "2012-10-17"
      Statement = [
        {
          Sid = "InvokeLambdaFunctions"
          Effect = "Allow"
          Action = ["lambda:InvokeFunction"]
          Resource = ["arn:aws:lambda:*:*:function:csv-processor-${var.environment}"]
        },
        {
          Sid = "CloudWatchLogsAccess"
          Effect = "Allow"
          Action = [
            "logs:CreateLogGroup", "logs:CreateLogStream", "logs:PutLogEvents",
            "logs:DescribeLogGroups", "logs:DescribeLogStreams"
          ]
          Resource = ["arn:aws:logs:*:*:log-group:/aws/stepfunctions/*"]
        },
        {
          Sid = "DistributedMapAccess"
          Effect = "Allow"
          Action = [
            "states:DescribeExecution", "states:StartExecution", "states:StopExecution"
          ]
          Resource = [
            "arn:aws:states:*:*:stateMachine:csv-processing-workflow-${var.environment}",
            "arn:aws:states:*:*:execution:csv-processing-workflow-${var.environment}:*"
          ]
        },
        {
          Sid = "S3ResultWriterAccess"
          Effect = "Allow"
          Action = ["s3:PutObject", "s3:PutObjectAcl"]
          Resource = ["arn:aws:s3:::csv-processing-*-${var.environment}/output/results/*"]
        }
      ]
    })
  }
  ```

#### Lambda用IAMロール ✅完了
- [x] **統合Lambda関数（csv-processor）用ロール作成** - 設計書準拠で実装
  ```hcl
  resource "aws_iam_role" "lambda_processor_role" {
    name = "csv-lambda-processor-role-${var.environment}"
    
    assume_role_policy = jsonencode({
      Version = "2012-10-17"
      Statement = [
        {
          Action = "sts:AssumeRole"
          Effect = "Allow"
          Principal = {
            Service = "lambda.amazonaws.com"
          }
        }
      ]
    })
  }
  ```

- [x] **統合Lambda関数用包括的ポリシー作成** - 設計書の全権限を実装
  ```hcl
  resource "aws_iam_role_policy" "lambda_processor_policy" {
    name = "csv-lambda-processor-policy-${var.environment}"
    
    policy = jsonencode({
      Version = "2012-10-17"
      Statement = [
        # S3 Input/Output/File Movement権限
        {
          Sid = "S3InputBucketAccess"
          Effect = "Allow"
          Action = ["s3:GetObject", "s3:GetObjectVersion"]
          Resource = [
            "arn:aws:s3:::csv-processing-*-${var.environment}/input/incoming/*",
            "arn:aws:s3:::csv-processing-*-${var.environment}/input/processing/*"
          ]
        },
        {
          Sid = "S3OutputBucketAccess"
          Effect = "Allow"
          Action = ["s3:PutObject", "s3:PutObjectAcl"]
          Resource = [
            "arn:aws:s3:::csv-processing-*-${var.environment}/output/results/*",
            "arn:aws:s3:::csv-processing-*-${var.environment}/output/reports/*",
            "arn:aws:s3:::csv-processing-*-${var.environment}/output/errors/*"
          ]
        },
        # DynamoDB全テーブルアクセス
        {
          Sid = "DynamoDBFullAccess"
          Effect = "Allow"
          Action = [
            "dynamodb:GetItem", "dynamodb:PutItem", "dynamodb:UpdateItem", 
            "dynamodb:DeleteItem", "dynamodb:Query", "dynamodb:Scan"
          ]
          Resource = [
            "arn:aws:dynamodb:*:*:table/*-audit-logs-${var.environment}",
            "arn:aws:dynamodb:*:*:table/*-processing-metadata-${var.environment}",
            "arn:aws:dynamodb:*:*:table/*-batch-jobs-${var.environment}",
            "arn:aws:dynamodb:*:*:table/*-job-locks-${var.environment}"
          ]
        },
        # Aurora接続・Secrets Manager権限
        {
          Sid = "AuroraDBAccess"
          Effect = "Allow"
          Action = ["rds-db:connect"]
          Resource = "arn:aws:rds-db:*:*:dbuser:*-aurora-${var.environment}/lambda_user"
        },
        {
          Sid = "SecretsManagerAccess"
          Effect = "Allow"
          Action = ["secretsmanager:GetSecretValue"]
          Resource = "arn:aws:secretsmanager:*:*:secret:*/aurora-credentials-*"
        }
      ]
    })
  }
  ```

- [x] **VPC実行権限追加** - Lambda VPC実行ポリシーをアタッチ

## 4. インフラ製造実行順序

### 4.1 Phase 1: 基盤構築（推定時間: 3時間）
1. **Terraformプロジェクト初期化** (30分)
   - プロバイダー設定
   - Backend設定
   - Variables定義

2. **共通モジュール作成** (120分)
   - ネットワークモジュール
   - IAMモジュール
   - S3モジュール
   - DynamoDBモジュール
   - CloudWatchモジュール

3. **初期検証** (30分)
   - terraform init
   - terraform validate
   - terraform plan

### 4.2 Phase 2: ネットワーク・セキュリティ（推定時間: 2時間） ✅完了
1. **VPC・サブネット構築** (60分) ✅完了
2. **セキュリティグループ構築** (30分) ✅完了
3. **ルートテーブル・ゲートウェイ** (30分) ✅完了

### 4.3 Phase 3: データベース・ストレージ（推定時間: 2時間） ✅完了
1. **Aurora PostgreSQL構築** (60分) ✅完了
2. **DynamoDB構築** (30分) ✅完了  
3. **S3バケット構築** (30分) ✅完了

### 4.4 Phase 4: 監視・ログ・IAM（推定時間: 1.5時間）
1. **CloudWatch・X-Ray設定** (45分)
2. **IAMロール・ポリシー構築** (45分)

### 4.5 Phase 5: 総合テスト（推定時間: 1時間）
1. **インフラ全体検証** (30分)
2. **接続テスト** (30分)

**合計推定時間**: **9.5時間**

## 5. 完了確認項目

### 5.1 Terraform基盤確認
- [ ] terraform init が正常完了
- [ ] terraform validate が正常完了
- [ ] terraform plan でエラーなし
- [ ] terraform apply が正常完了

### 5.2 ネットワーク確認
- [x] VPCが正常作成されている (10.0.1.0/24)
- [x] サブネットが適切に作成・関連付けされている (2AZ構成)
- [x] セキュリティグループが適切に設定されている (Lambda・Aurora・VPCエンドポイント用)
- [x] インターネット接続が正常 (IGW・NAT Gateway経由)

### 5.3 データベース確認
- [x] Aurora PostgreSQLクラスターが起動している (Serverless v2, PostgreSQL 17.5)
- [x] DynamoDBテーブルが作成されている (audit_logs, processing_metadata, batch_jobs, job_locks)
- [x] データベーススキーマが作成されている (初期テーブル・インデックス・関数)
- [ ] データベース接続が正常 (デプロイ後テスト)

### 5.4 ストレージ確認
- [ ] 必要なS3バケットが全て作成されている
- [ ] バケットポリシーが適切に設定されている
- [ ] ライフサイクルポリシーが動作している

### 5.5 監視・ログ確認
- [ ] CloudWatchロググループが作成されている
- [ ] アラームが適切に設定されている
- [ ] X-Rayトレーシングが有効化されている

### 5.6 IAM確認
- [ ] 必要なIAMロールが全て作成されている
- [ ] ポリシーが適切にアタッチされている
- [ ] 最小権限の原則が適用されている

## 6. 次のステップ

### 6.1 インフラ製造完了後
✅ Terraform基盤構築完了  
✅ ネットワークインフラ構築完了  
✅ データベースインフラ構築完了 (Aurora PostgreSQL + DynamoDB)  
⏳ ストレージインフラ構築 (未着手)  
⏳ 監視・ログインフラ構築 (未着手)  
⏳ IAMロール・ポリシー構築 (未着手)  

### 6.2 次の製造項目
1. **開発環境構築**（次のタスク）
   - SAMプロジェクト初期化
   - ローカル開発環境設定
   - CI/CDパイプライン構築

2. **ソースコード製造開始**
   - Lambda関数実装
   - Step Functions実装
   - API実装

### 6.3 開発開始準備
インフラ製造完了により、以下が可能になります：
- SAMアプリケーションのデプロイ
- Lambda関数の実行テスト
- データベース接続テスト
- CI/CDパイプラインの実行

## 7. リスク・注意事項

### 7.1 技術的リスク
- **Aurora Serverless起動時間**: 初回起動時の遅延対策
- **VPC内Lambda実行**: ENI作成による初回実行遅延
- **DynamoDB制限**: 同時実行数による制限

### 7.2 コスト管理
- **Aurora Serverless**: 最小キャパシティでの課金
- **DynamoDB**: オンデマンド課金での使用量監視
- **CloudWatch**: ログ保存期間の適切な設定

### 7.3 セキュリティ注意点
- **IAMロール**: 最小権限の原則適用
- **セキュリティグループ**: 必要最小限のポート開放
- **S3バケット**: パブリックアクセス完全ブロック

## 8. 関連ドキュメント

### 8.1 前段階ドキュメント
- `20250804_11_製造タスク_AWS環境準備.md` - AWS環境準備（完了済み）
- `20250804_12_製造タスク_GitHub環境準備.md` - GitHub環境準備

### 8.2 次段階ドキュメント
- `20250804_14_製造タスク_開発環境構築.md` - 開発環境構築フェーズ
- `20250804_15_製造タスク_後続フェーズ.md` - その他フェーズ

### 8.3 参照設計書
- `03-01_詳細設計書_インフラ詳細設計.md` - インフラ設計詳細
- `02-05_基本設計書_S3バケット設計.md` - S3バケット設計
- `03-12_詳細設計書_監視・ログ詳細設計.md` - 監視設計
- `03-14_詳細設計書_データモデル詳細設計.md` - データモデル設計

---

**最終更新**: 2025-08-05  
**ステータス**: ⏳インフラ製造進行中 (Phase 1-3データベース完了、Phase 3S3・Phase 4-6未着手)  
**完了項目**: Terraform基盤構築、ネットワークインフラ構築、データベースインフラ構築(Aurora PostgreSQL + DynamoDB)、文字化け修正  
**次のアクション**: ストレージインフラ構築継続 (S3バケット)、監視・ログインフラ構築、IAMロール・ポリシー構築  
**推定残り時間**: 4時間 (Phase 3S3部分 + Phase 4-6)