# CSVファイル並列処理システム 製造タスク_後続フェーズ

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| ドキュメント名 | 製造タスク_後続フェーズ |
| バージョン | 1.0 |
| 作成日 | 2025-08-04 |
| 作成者 | システム開発チーム |
| 更新日 | 2025-08-04 |
| 分割元 | 20250804_01_製造タスク管理.md |

## 2. 後続フェーズ概要

### 2.1 後続フェーズの位置付け
開発環境構築フェーズ完了後の段階として、以下の後続フェーズを実施します：

1. **ソースコード製造フェーズ**: Lambda関数・Step Functions・API実装
2. **テスト製造フェーズ**: 単体・統合・E2Eテスト実装
3. **デプロイ・リリースフェーズ**: 開発・本番環境デプロイ
4. **運用準備フェーズ**: 運用手順書・利用者向けドキュメント作成

### 2.2 参照ドキュメント
- **開発環境構築完了**: `20250804_14_製造タスク_開発環境構築.md`
- **Lambda開発標準**: `02-01_基本設計書_Lambda開発標準仕様書.md`
- **詳細設計書**: `03-06_詳細設計書_CSV統合処理関数.md`
- **Step Functions設計**: `03-02_詳細設計書_Step Functions詳細設計.md`
- **API設計**: `03-13_詳細設計書_API詳細設計.md`

## 3. ソースコード製造フェーズ ⏳未着手

### 3.1 統合Lambda関数実装 ⏳未着手

#### csv-processor関数基盤実装 ⏳未着手
**参照**: 03-06_詳細設計書_CSV統合処理関数.md

- [ ] **メインハンドラー実装**（イベント種別ルーティング）
  ```typescript
  // src/index.ts
  export const handler = async (event: any, context: Context): Promise<any> => {
    const container = new DIContainer();
    const eventRouter = container.get<EventRouter>('EventRouter');
    
    try {
      return await eventRouter.route(event, context);
    } catch (error) {
      logger.error('Handler execution failed', { error, event });
      throw error;
    }
  };
  ```

- [ ] **イベントパーサー実装**
  ```typescript
  // src/controllers/EventParser.ts
  export class EventParser {
    public parseEvent(event: any): ProcessingEvent {
      if (this.isS3Event(event)) {
        return this.parseS3Event(event);
      } else if (this.isStepFunctionsEvent(event)) {
        return this.parseStepFunctionsEvent(event);
      }
      throw new Error('Unsupported event type');
    }
  }
  ```

- [ ] **DI コンテナ設定**
  ```typescript
  // src/infrastructure/config/DIContainer.ts
  export class DIContainer {
    private container: Container;
    
    constructor() {
      this.container = new Container();
      this.registerServices();
    }
    
    private registerServices(): void {
      // Service登録
      this.container.bind<ICsvValidationService>('CsvValidationService')
        .to(CsvValidationService);
    }
  }
  ```

- [ ] **ログ設定**（構造化ログ）
  ```typescript
  // src/infrastructure/config/Logger.ts
  export class StructuredLogger {
    public info(message: string, meta?: object): void {
      console.log(JSON.stringify({
        timestamp: new Date().toISOString(),
        level: 'INFO',
        message,
        ...meta
      }));
    }
  }
  ```

- [ ] **エラーハンドリング基盤**
  ```typescript
  // src/infrastructure/error/ErrorHandler.ts
  export class GlobalErrorHandler {
    public handleError(error: Error, context: any): ProcessingResult {
      if (error instanceof ValidationError) {
        return this.handleValidationError(error, context);
      } else if (error instanceof DatabaseError) {
        return this.handleDatabaseError(error, context);
      }
      return this.handleUnknownError(error, context);
    }
  }
  ```

#### CSV検証機能実装 (CSV_VALIDATION) ⏳未着手
- [ ] **CSVValidationController実装**
  ```typescript
  // src/controllers/CsvValidationController.ts
  export class CsvValidationController {
    constructor(
      private csvValidationService: ICsvValidationService
    ) {}
    
    public async validate(event: S3Event): Promise<ValidationResult> {
      const s3Object = this.extractS3Object(event);
      return await this.csvValidationService.validateCsv(s3Object);
    }
  }
  ```

- [ ] **CSVValidationService実装**（アプリケーション層）
  ```typescript
  // src/application/services/CsvValidationService.ts
  export class CsvValidationService implements ICsvValidationService {
    constructor(
      private csvValidator: ICsvValidator,
      private validationRepository: IValidationRepository
    ) {}
    
    public async validateCsv(s3Object: S3Object): Promise<ValidationResult> {
      const csvData = await this.validationRepository.getCsvData(s3Object);
      return await this.csvValidator.validate(csvData);
    }
  }
  ```

- [ ] **CSVValidator実装**（ドメイン層）
  ```typescript
  // src/domain/validators/CsvValidator.ts
  export class CsvValidator implements ICsvValidator {
    public async validate(csvData: CsvData): Promise<ValidationResult> {
      const errors: ValidationError[] = [];
      
      // ヘッダー検証
      errors.push(...this.validateHeaders(csvData.headers));
      
      // データ行検証
      errors.push(...this.validateDataRows(csvData.rows));
      
      return new ValidationResult(errors.length === 0, errors);
    }
  }
  ```

- [ ] **ValidationRepository実装**（インフラ層）
  ```typescript
  // src/infrastructure/repositories/S3ValidationRepository.ts
  export class S3ValidationRepository implements IValidationRepository {
    constructor(private s3Client: S3Client) {}
    
    public async getCsvData(s3Object: S3Object): Promise<CsvData> {
      const response = await this.s3Client.getObject({
        Bucket: s3Object.bucket,
        Key: s3Object.key
      });
      
      return this.parseCsvStream(response.Body);
    }
  }
  ```

#### チャンク処理機能実装 (CSV_CHUNK_PROCESSING) ⏳未着手
- [ ] **ChunkProcessingController実装**
- [ ] **ChunkProcessingService実装**
- [ ] **ChunkProcessor実装**（ドメイン層）
- [ ] **DataRepository実装**（Aurora接続）

#### 監査ログ機能実装 (AUDIT_LOGGING) ⏳未着手
- [ ] **AuditLoggingController実装**
- [ ] **AuditLoggingService実装**
- [ ] **AuditLogger実装**（ドメイン層）
- [ ] **AuditRepository実装**（DynamoDB接続）

#### 結果集約機能実装 (RESULT_AGGREGATION) ⏳未着手
- [ ] **ResultAggregationController実装**
- [ ] **ResultAggregationService実装**
- [ ] **ResultAggregator実装**（ドメイン層）
- [ ] **ResultRepository実装**

#### エラーハンドリング機能実装 (ERROR_HANDLING) ⏳未着手
- [ ] **ErrorHandlingController実装**
- [ ] **ErrorHandlingService実装**
- [ ] **ErrorHandler実装**（ドメイン層）
- [ ] **ErrorRepository実装**

### 3.2 Lambda Layers実装 ⏳未着手

#### 共通ライブラリLayer ⏳未着手
- [ ] **共通ユーティリティ関数**
  ```typescript
  // layers/common-layer/src/utils/DateUtils.ts
  export class DateUtils {
    public static toISOString(date: Date): string {
      return date.toISOString();
    }
    
    public static addDays(date: Date, days: number): Date {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }
  }
  ```

- [ ] **AWS SDK Wrapper**
  ```typescript
  // layers/common-layer/src/aws/S3ClientWrapper.ts
  export class S3ClientWrapper {
    private s3Client: S3Client;
    
    constructor() {
      this.s3Client = new S3Client({ region: process.env.AWS_REGION });
    }
    
    public async getObject(bucket: string, key: string): Promise<GetObjectCommandOutput> {
      return await this.s3Client.send(new GetObjectCommand({ Bucket: bucket, Key: key }));
    }
  }
  ```

- [ ] **ログライブラリ**
- [ ] **メトリクス送信ライブラリ**

#### ビジネスロジックLayer ⏳未着手
- [ ] **CSV処理共通ロジック**
- [ ] **バリデーション共通ロジック**
- [ ] **データ変換共通ロジック**

### 3.3 Step Functions実装 ⏳未着手

#### メインワークフロー実装 ⏳未着手
**参照**: 03-02_詳細設計書_Step Functions詳細設計.md

- [ ] **ASL（Amazon States Language）定義作成**
  ```json
  {
    "Comment": "CSV Parallel Processing Workflow",
    "StartAt": "ValidateCSV",
    "States": {
      "ValidateCSV": {
        "Type": "Task",
        "Resource": "arn:aws:lambda:ap-northeast-1:526636471122:function:csv-processor",
        "Parameters": {
          "operation": "CSV_VALIDATION",
          "input.$": "$"
        },
        "Next": "IsValidationSuccessful"
      },
      "IsValidationSuccessful": {
        "Type": "Choice",
        "Choices": [{
          "Variable": "$.validation.isValid",
          "BooleanEquals": true,
          "Next": "ProcessCSVInParallel"
        }],
        "Default": "HandleValidationError"
      },
      "ProcessCSVInParallel": {
        "Type": "Map",
        "ItemProcessor": {
          "ProcessorConfig": {
            "Mode": "DISTRIBUTED",
            "ExecutionType": "STANDARD"
          },
          "StartAt": "ProcessChunk",
          "States": {
            "ProcessChunk": {
              "Type": "Task",
              "Resource": "arn:aws:lambda:ap-northeast-1:526636471122:function:csv-processor",
              "Parameters": {
                "operation": "CSV_CHUNK_PROCESSING",
                "chunk.$": "$"
              },
              "End": true
            }
          }
        },
        "Next": "AggregateResults"
      }
    }
  }
  ```

- [ ] **分散マップ設定**
- [ ] **エラーハンドリング設定**
- [ ] **再試行ポリシー設定**

### 3.4 API実装 ⏳未着手

#### 管理API実装 ⏳未着手
**参照**: 03-13_詳細設計書_API詳細設計.md

- [ ] **Step Functions実行管理API**
  ```typescript
  // src/controllers/StepFunctionsController.ts
  export class StepFunctionsController {
    public async startExecution(request: StartExecutionRequest): Promise<ExecutionResponse> {
      const input = {
        bucket: request.bucket,
        key: request.key,
        executionId: uuidv4()
      };
      
      const result = await this.stepFunctionsClient.startExecution({
        stateMachineArn: process.env.STATE_MACHINE_ARN,
        input: JSON.stringify(input)
      });
      
      return new ExecutionResponse(result.executionArn, input.executionId);
    }
  }
  ```

- [ ] **実行状況監視API**
- [ ] **ファイル管理API**
- [ ] **ヘルスチェックAPI**

### 3.5 ソースコード製造実行順序（推定時間: 20時間）

#### Phase 1: 基盤実装（6時間）
1. **DIコンテナ・ログ・エラーハンドリング基盤** (3時間)
2. **メインハンドラー・イベントパーサー** (3時間)

#### Phase 2: 機能実装（10時間）
1. **CSV検証機能** (3時間)
2. **チャンク処理機能** (3時間)
3. **監査ログ機能** (2時間)
4. **結果集約・エラーハンドリング機能** (2時間)

#### Phase 3: Layer・Step Functions・API（4時間）
1. **Lambda Layers実装** (2時間)
2. **Step Functions ASL定義** (1時間)
3. **管理API実装** (1時間)

## 4. テスト製造フェーズ ⏳未着手

### 4.1 単体テスト実装 ⏳未着手

#### Lambda関数単体テスト ⏳未着手
- [ ] **Controller層テスト**
  ```typescript
  // tests/unit/controllers/CsvValidationController.test.ts
  describe('CsvValidationController', () => {
    let controller: CsvValidationController;
    let mockService: jest.Mocked<ICsvValidationService>;
    
    beforeEach(() => {
      mockService = createMockCsvValidationService();
      controller = new CsvValidationController(mockService);
    });
    
    it('should validate CSV successfully', async () => {
      // テスト実装
    });
  });
  ```

- [ ] **Service層テスト**
- [ ] **Domain層テスト**
- [ ] **Repository層テスト**（モック使用）

#### テストユーティリティ作成 ⏳未着手
- [ ] **テストデータ作成ヘルパー**
  ```typescript
  // tests/helpers/TestDataBuilder.ts
  export class TestDataBuilder {
    public static createS3Event(bucket: string, key: string): S3Event {
      return {
        Records: [{
          s3: {
            bucket: { name: bucket },
            object: { key: key }
          }
        }]
      };
    }
  }
  ```

- [ ] **モック作成ヘルパー**
- [ ] **テスト環境セットアップ**

### 4.2 統合テスト実装 ⏳未着手

#### AWS サービス統合テスト ⏳未着手
- [ ] **S3連携テスト**
  ```typescript
  // tests/integration/s3-integration.test.ts
  describe('S3 Integration', () => {
    it('should read CSV file from S3', async () => {
      // 実際のS3バケットを使用した統合テスト
    });
  });
  ```

- [ ] **DynamoDB連携テスト**
- [ ] **Aurora連携テスト**
- [ ] **Step Functions連携テスト**

### 4.3 E2Eテスト実装 ⏳未着手

#### エンド・ツー・エンドテスト ⏳未着手
- [ ] **CSVアップロード → 処理完了までの全体テスト**
- [ ] **エラーケーステスト**
- [ ] **性能テスト**
- [ ] **負荷テスト**（並列処理）

### 4.4 テスト製造実行順序（推定時間: 8時間）

#### Phase 1: 単体テスト（4時間）
1. **テストヘルパー・ユーティリティ作成** (1時間)
2. **Controller・Service層テスト** (2時間)
3. **Domain・Repository層テスト** (1時間)

#### Phase 2: 統合テスト（3時間）
1. **AWS サービス統合テスト** (2時間)
2. **データベース連携テスト** (1時間)

#### Phase 3: E2Eテスト（1時間）
1. **エンド・ツー・エンドシナリオテスト** (1時間)

## 5. デプロイ・リリースフェーズ ⏳未着手

### 5.1 開発環境デプロイ ⏳未着手

#### 開発環境構築 ⏳未着手
- [ ] **Terraform Apply**（開発環境）
  ```bash
  cd terraform/environments/dev
  terraform init
  terraform plan -out=tfplan
  terraform apply tfplan
  ```

- [ ] **SAM Deploy**（開発環境）
  ```bash
  cd sam
  sam build --use-container
  sam deploy --config-env dev
  ```

- [ ] **データベース初期化**
  ```bash
  # Aurora PostgreSQL 初期スキーマ適用
  psql -h $DATABASE_HOST -U $DATABASE_USER -d $DATABASE_NAME -f scripts/init-schema.sql
  
  # DynamoDB テーブル初期設定確認
  aws dynamodb describe-table --table-name csv-audit-logs-dev
  ```

- [ ] **動作確認テスト**
  ```bash
  # API ヘルスチェック
  curl -f https://api-dev.example.com/health
  
  # サンプルCSVファイルアップロード・処理テスト
  aws s3 cp sample.csv s3://csv-input-files-526636471122-dev/
  ```

### 5.2 本番環境デプロイ ⏳未着手

#### 本番環境準備 ⏳未着手
- [ ] **本番環境インフラ構築**
  ```bash
  cd terraform/environments/prod
  terraform init
  terraform plan -out=tfplan
  terraform apply tfplan
  ```

- [ ] **セキュリティ設定確認**
  - IAMロール最小権限確認
  - セキュリティグループ設定確認
  - S3バケットポリシー確認

- [ ] **監視・アラート設定確認**
  - CloudWatchアラーム動作確認
  - SNS通知設定確認
  - X-Rayトレーシング確認

- [ ] **バックアップ設定**
  - Aurora自動バックアップ確認
  - DynamoDBポイントインタイムリカバリ確認

#### 本番デプロイ実行 ⏳未着手
- [ ] **Blue/Green デプロイ実行**
  ```bash
  cd sam
  sam deploy --config-env prod
  ```

- [ ] **動作確認テスト**
- [ ] **性能テスト**
- [ ] **ロールバック手順確認**

### 5.3 デプロイ・リリース実行順序（推定時間: 4時間）

#### Phase 1: 開発環境デプロイ（2時間）
1. **インフラデプロイ・Lambda デプロイ** (1時間)
2. **データベース初期化・動作確認** (1時間)

#### Phase 2: 本番環境デプロイ（2時間）
1. **本番環境準備・セキュリティ確認** (1時間)
2. **本番デプロイ・動作確認** (1時間)

## 6. 運用準備フェーズ ⏳未着手

### 6.1 運用手順書作成 ⏳未着手

#### デプロイ手順書作成 ⏳未着手
**格納先**: 10_Manual/

- [ ] **01_デプロイ手順書.md**
  ```markdown
  # デプロイ手順書
  
  ## 1. 事前準備
  - [ ] AWSアカウント・権限確認
  - [ ] GitHub Actions Secrets確認
  - [ ] デプロイ対象ブランチ確認
  
  ## 2. 開発環境デプロイ
  ### 2.1 インフラデプロイ
  ```bash
  cd terraform/environments/dev
  terraform plan -out=tfplan
  terraform apply tfplan
  ```
  
  ### 2.2 アプリケーションデプロイ
  ```bash
  cd sam
  sam build --use-container
  sam deploy --config-env dev
  ```
  ```

- [ ] **02_ロールバック手順書.md**
- [ ] **03_設定変更手順書.md**

#### 監視・運用手順書作成 ⏳未着手
- [ ] **04_監視手順書.md**
  ```markdown
  # 監視手順書
  
  ## 1. 日次監視項目
  - [ ] Lambda関数実行状況確認
  - [ ] Step Functions実行状況確認
  - [ ] Aurora PostgreSQL接続状況確認
  - [ ] DynamoDB使用量確認
  - [ ] S3バケット使用量確認
  
  ## 2. 週次監視項目
  - [ ] コスト使用量レビュー
  - [ ] セキュリティログレビュー
  - [ ] パフォーマンスメトリクスレビュー
  ```

- [ ] **05_アラート対応手順書.md**
- [ ] **06_ログ分析手順書.md**

#### 障害対応手順書作成 ⏳未着手
- [ ] **07_障害対応手順書.md**
- [ ] **08_復旧手順書.md**
- [ ] **09_メンテナンス手順書.md**

### 6.2 利用者向けドキュメント作成 ⏳未着手

#### API仕様書作成 ⏳未着手
- [ ] **OpenAPI 3.0 仕様書**
  ```yaml
  openapi: 3.0.0
  info:
    title: CSV Parallel Processing API
    version: 1.0.0
    description: CSVファイル並列処理システム API
  
  paths:
    /process-csv:
      post:
        summary: CSV処理開始
        requestBody:
          required: true
          content:
            application/json:
              schema:
                type: object
                properties:
                  bucket:
                    type: string
                  key:
                    type: string
        responses:
          '200':
            description: 処理開始成功
  ```

- [ ] **Postmanコレクション**
- [ ] **サンプルコード**

#### システム利用手順書作成 ⏳未着手
- [ ] **CSVアップロード手順**
- [ ] **処理状況確認手順**
- [ ] **エラー対応手順**

### 6.3 運用準備実行順序（推定時間: 6時間）

#### Phase 1: 運用手順書作成（4時間）
1. **デプロイ・ロールバック手順書** (2時間)
2. **監視・障害対応手順書** (2時間)

#### Phase 2: 利用者向けドキュメント（2時間）
1. **API仕様書・サンプルコード** (1時間)
2. **システム利用手順書** (1時間)

## 7. 全体進捗管理

### 7.1 フェーズ別進捗状況
- 🔴 **ソースコード製造フェーズ**: 0% (未着手) - 推定20時間
- 🔴 **テスト製造フェーズ**: 0% (未着手) - 推定8時間
- 🔴 **デプロイ・リリースフェーズ**: 0% (未着手) - 推定4時間
- 🔴 **運用準備フェーズ**: 0% (未着手) - 推定6時間

**合計推定時間**: **38時間**

### 7.2 リスク・課題

#### 技術的リスク
- **Lambda同時実行数制限**: デフォルト1000の制限による処理能力上限
- **Step Functions分散マップ制限**: 1回の実行で最大10,000アイテム
- **Aurora Serverless起動時間**: 初回起動時の遅延（最大30秒）
- **VPC内Lambda実行**: ENI作成による初回実行遅延（最大10秒）

#### 設計・実装リスク
- **DDD アーキテクチャ**: 複雑な設計による実装工数増加
- **TypeScript型安全性**: 厳密な型チェックによる開発速度への影響
- **テストカバレッジ**: 高品質維持のための十分なテスト実装

#### 運用リスク
- **コスト管理**: Aurora Serverless、DynamoDBオンデマンド課金の予測困難
- **監視体制**: 24時間監視体制の構築要否
- **障害対応**: 分散システムでの障害切り分け・対応の複雑性

### 7.3 成功要因
- **段階的実装**: フェーズごとの確実な実装・テスト
- **自動化**: CI/CDによる品質担保・デプロイ効率化
- **ドキュメント整備**: 運用・保守を考慮した詳細ドキュメント
- **品質重視**: テストファースト開発による高品質確保

## 8. 関連ドキュメント

### 8.1 前段階ドキュメント
- `20250804_14_製造タスク_開発環境構築.md` - 開発環境構築（前段階）

### 8.2 分割元・関連ドキュメント
- `20250804_01_製造タスク管理.md` - 元の統合タスク管理
- `20250804_11_製造タスク_AWS環境準備.md` - AWS環境準備
- `20250804_12_製造タスク_GitHub環境準備.md` - GitHub環境準備
- `20250804_13_製造タスク_インフラ製造.md` - インフラ製造

### 8.3 参照設計書
- `02-01_基本設計書_Lambda開発標準仕様書.md` - Lambda開発標準
- `03-06_詳細設計書_CSV統合処理関数.md` - Lambda関数詳細設計
- `03-02_詳細設計書_Step Functions詳細設計.md` - Step Functions設計
- `03-13_詳細設計書_API詳細設計.md` - API設計
- `02-09_基本設計書_CI-CD設計書.md` - CI/CD設計

---

**最終更新**: 2025-08-04  
**ステータス**: ⏳後続フェーズ未着手  
**次のアクション**: ソースコード製造フェーズ開始  
**推定作業時間**: 38時間  
**重要**: 開発環境構築完了後に実施開始