# StepFunctions CSV並列処理システム プロジェクトの設計管理

## 1. 要件調査フェーズ ✅完了

### 1.1 技術調査 ✅完了
- [x] StepFunctions分散マップ調査
- [x] S3イベント通知の仕組み調査  
- [x] EventBridge連携パターン調査
- [x] DynamoDB用途・必要性分析
- [x] エラーハンドリング・例外ケース調査
- [x] 重複実行防止対策調査

### 1.2 アーキテクチャ検討 ✅完了
- [x] S3 - EventBridge - StepFunctions - Lambda構成検討
- [x] DynamoDB採用可否判断
- [x] 分散マップによる並列処理設計検討
- [x] エラー処理・監視方式検討

## 2. 設計ドキュメント作成フェーズ ✅完了

### 2.1 要件定義 ✅完了
- [x] **機能要件定義書作成**
  - [x] システム概要（1000行レベルCSV、最大5並列処理）
  - [x] 機能一覧（F001-F010の機能定義）
  - [x] 性能要件（1,000行/5分以内、99.9%可用性）
  - [x] 制約事項（AWS制約、データ制約、運用制約）
  - [x] インターフェース仕様（S3、EventBridge、DynamoDB）

### 2.2 アーキテクチャ構成 ✅完了  
- [x] **システムアーキテクチャ設計書作成**
  - [x] 全体構成図（AWSアイコン版Mermaid図）
  - [x] コンポーネント構成（S3、EventBridge、Step Functions、Lambda、Aurora、DynamoDB）
  - [x] データフロー図（シーケンス図）
  - [x] インフラ構成（VPC 10.0.1.0/24、/27サブネット分割）
  - [x] セキュリティ設計（IAM、KMS、VPC設計）
  - [x] Step Functionsワークフロー設計（ASL定義）
  - [x] データベース設計（Aurora + DynamoDB）

### 2.3 機能の基本設計 ✅完了
- [x] **基本設計書作成**

  - [x] Lambdaの開発標準の作成
  - [x] Lambda関数設計
  - [x] EventBridge ルール設計
  - [x] エラーハンドリング設計
  - [x] 監視・ログ設計
  - [x] ソース管理
  - [x] Step Functions状態機械設計
  - [x] S3バケット設計
  - [x] CI/CD設計

## 3. 詳細設計フェーズ ✅完了

### 3.1 インフラ詳細設計 ✅完了
- [x] **IAMロール・ポリシー設計** - 03-01_詳細設計書_インフラ詳細設計.md
- [x] **VPC・ネットワーク設計** - 03-01_詳細設計書_インフラ詳細設計.md
- [x] **Aurora PostgreSQL設計** - 03-01_詳細設計書_インフラ詳細設計.md
- [x] **DynamoDB設計** - 03-01_詳細設計書_インフラ詳細設計.md
- [x] **S3バケットポリシー設計** - 03-01_詳細設計書_インフラ詳細設計.md
- [x] **CloudWatch監視設計** - 03-01_詳細設計書_インフラ詳細設計.md

### 3.2 Lambda関数詳細設計 ✅完了
- [x] **CSV統合処理関数設計**（DIP適用レイヤードアーキテクチャ） - 03-06_詳細設計書_CSV統合処理関数.md
  - [x] CSV検証機能（CSV_VALIDATION）
  - [x] チャンク処理機能（CSV_CHUNK_PROCESSING）
  - [x] 監査ログ機能（AUDIT_LOGGING）
  - [x] 結果集約機能（RESULT_AGGREGATION）
  - [x] エラーハンドリング機能（ERROR_HANDLING）

### 3.3 Step Functions詳細設計 ✅完了
- [x] **ステートマシン定義** - 03-02_詳細設計書_Step Functions詳細設計.md
- [x] **分散マップ設定詳細** - 03-05_詳細設計書_分散マップ詳細設計.md
- [x] **エラー処理フロー** - 03-03_詳細設計書_エラー処理フロー詳細設計.md
- [x] **再試行設定** - 03-04_詳細設計書_再試行設定詳細設計.md

### 3.4 システム統合設計 ✅完了
- [x] **命名規則ガイドライン** - 02-10_基本設計書_命名規則ガイドライン.md
- [x] **リソース名統一化** - 全詳細設計書に反映済み
- [x] **統合Lambda関数への移行** - 複数Lambda関数から単一統合関数へ設計変更完了

### 3.5 セキュリティ・監視設計 ✅完了
- [x] **セキュリティ詳細設計書** - 03-11_詳細設計書_セキュリティ詳細設計.md
- [x] **監視・ログ詳細設計書** - 03-12_詳細設計書_監視・ログ詳細設計.md

### 3.6 外部連携・データ設計 ✅完了
- [x] **API詳細設計書** - 03-13_詳細設計書_API詳細設計.md
- [x] **データモデル詳細設計書** - 03-14_詳細設計書_データモデル詳細設計.md

## 4. 現在の進捗状況

### 完了済み
- ✅ **要件調査フェーズ**（100%完了）
  - 技術調査、アーキテクチャ検討完了
  - 03_Research配下に調査結果格納
- ✅ **設計ドキュメント作成フェーズ**（100%完了）
  - 要件定義書、システムアーキテクチャ設計書作成完了
  - 基本設計書（02-01～02-10）作成完了
  - 01_Document配下に設計書格納
- ✅ **詳細設計フェーズ**（100%完了）
  - インフラ詳細設計完了（IAM、VPC、Aurora、DynamoDB、S3、CloudWatch）
  - Lambda統合関数設計完了（DIP適用レイヤードアーキテクチャ）
  - Step Functions詳細設計完了（分散マップ、エラー処理、再試行）
  - セキュリティ・監視詳細設計完了
  - API・データモデル詳細設計完了
  - 詳細設計書（03-01～03-14）作成完了

### 次のアクション
1. **実装フェーズ開始** - SAM + Terraform による Infrastructure as Code
2. **統合Lambda関数実装** - csv-processor関数の開発
3. **テスト設計・実装** - 単体・統合・E2Eテスト

## 5. 成果物一覧

### 調査・検討成果物（03_Research）
- StepFunctions分散マップ調査
- EventBridge連携エラー・例外ケース調査
- 重複実行防止対策調査
- DynamoDB必要性検討
- その他技術調査ドキュメント

### 設計成果物（01_Document）
- ✅ 機能要件定義書（01-01_要件定義書_CSVファイル並列処理システム.md）
- ✅ システムアーキテクチャ設計書（01-02_要件定義書_システムアーキテクチャ設計書.md）
- ✅ **基本設計書（02-01～02-10）**
  - ✅ Lambda開発標準仕様書（02-01_基本設計書_Lambda開発標準仕様書.md）
  - ✅ Lambda関数基本設計（02-02_基本設計書_Lambda関数基本設計.md）
  - ✅ EventBridgeルール基本設計（02-03_基本設計書_EventBridgeルール基本設計.md）
  - ✅ Step Functions基本設計（02-04_基本設計書_Step Functions基本設計.md）
  - ✅ S3バケット設計（02-05_基本設計書_S3バケット設計.md）
  - ✅ 監視・ログ設計（02-06_基本設計書_監視・ログ設計.md）
  - ✅ エラーハンドリング基本設計（02-07_基本設計書_エラーハンドリング基本設計.md）
  - ✅ ソース管理設計（02-08_基本設計書_ソース管理設計.md）
  - ✅ CI/CD設計書（02-09_基本設計書_CI-CD設計書.md）
  - ✅ 命名規則ガイドライン（02-10_基本設計書_命名規則ガイドライン.md）
- ✅ **詳細設計書（03-01～03-14）**
  - ✅ インフラ詳細設計（03-01_詳細設計書_インフラ詳細設計.md）
  - ✅ Step Functions詳細設計（03-02_詳細設計書_Step Functions詳細設計.md）
  - ✅ エラー処理フロー詳細設計（03-03_詳細設計書_エラー処理フロー詳細設計.md）
  - ✅ 再試行設定詳細設計（03-04_詳細設計書_再試行設定詳細設計.md）
  - ✅ 分散マップ詳細設計（03-05_詳細設計書_分散マップ詳細設計.md）
  - ✅ CSV統合処理関数（03-06_詳細設計書_CSV統合処理関数.md）
  - ✅ セキュリティ詳細設計（03-11_詳細設計書_セキュリティ詳細設計.md）
  - ✅ 監視・ログ詳細設計（03-12_詳細設計書_監視・ログ詳細設計.md）
  - ✅ API詳細設計（03-13_詳細設計書_API詳細設計.md）
  - ✅ データモデル詳細設計（03-14_詳細設計書_データモデル詳細設計.md）

### 運用成果物（10_Manual）予定
- デプロイ手順書
- 運用手順書
- 障害対応手順書

## 6. 注意事項・課題

### 解決済み技術課題
- ✅ EventBridge重複実行対策：Step Functions実行名による制御
- ✅ CSVファイル処理規模：1000行レベルに調整
- ✅ エラーハンドリング：DynamoDB監査ログによる包括的管理
- ✅ アーキテクチャ設計：AWSアイコン版Mermaid図で可視化
- ✅ ネットワーク設計：VPC 10.0.1.0/24、/27サブネット分割

### 新たな技術課題
- ✅ 統合Lambda関数設計：複数機能を1つの関数に統合、イベント駆動型振り分け
- ✅ DIP適用アーキテクチャ：依存性逆転の原則に基づくレイヤード設計
- ✅ SAM + Terraform 構成：Lambda（SAM）+ インフラ（Terraform）の適材適所設計
- ✅ 包括的セキュリティ設計：IAM、暗号化、アクセス制御の詳細定義
- ✅ 完全なデータモデル：Aurora PostgreSQL + DynamoDB の最適活用

### 次フェーズ課題
- Infrastructure as Code実装（SAM + Terraform）
- 統合Lambda関数（csv-processor）の実装
- 包括的テスト戦略（単体・統合・E2E）
- 運用手順書の整備