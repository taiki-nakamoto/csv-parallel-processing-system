# SAM環境構築エラー対応

## 1. エラー内容

### 1.1 発生したエラー
- **エラーメッセージ**: `Cannot reference more than 5 layers`
- **発生日時**: 2025年8月7日
- **対象スタック**: csv-parallel-processing-full
- **エラー発生箇所**: CsvProcessorFunction (Lambda関数)

### 1.2 エラーの原因
template.yaml内で**Lambda Layersが重複定義**されていた：
1. **Globals > Function**セクション（32-35行目）でLayersを定義
2. **CsvProcessorFunction**セクション（120-123行目）でもLayersを定義

この結果、Lambda関数に6つのレイヤー（3つ×2）が適用され、AWS Lambdaの5レイヤー制限を超過した。

## 2. 対応内容

### 2.1 修正実施内容
**template.yaml**のGlobalsセクションからLayersの定義を削除：

#### 修正前（template.yaml 30-36行目）
```yaml
        POWERTOOLS_TRACER_CAPTURE_ERROR: 'true'
        POWERTOOLS_TRACER_CAPTURE_RESPONSE: 'true'
    Layers:
      - !Ref CommonUtilsLayer
      - !Ref AwsSdkWrapperLayer
      - !Ref BusinessLogicLayer
    # VpcConfig設定は現在コメントアウト（Terraform Export準備まで）
```

#### 修正後（template.yaml 30-32行目）
```yaml
        POWERTOOLS_TRACER_CAPTURE_ERROR: 'true'
        POWERTOOLS_TRACER_CAPTURE_RESPONSE: 'true'
    # VpcConfig設定は現在コメントアウト（Terraform Export準備まで）
```

### 2.2 設計との整合性確認
設計ドキュメント（`02-01_基本設計書_Lambda開発標準仕様書.md`）を確認した結果：
- **レイヤー分離方針**：AWS SAM Layersによる共通コードの再利用（34行目）
- **3つのレイヤー構成**：
  1. CommonUtilsLayer（共通ユーティリティ）
  2. AwsSdkWrapperLayer（AWS SDKラッパー）
  3. BusinessLogicLayer（ビジネスロジック）

**結論**：個別のLambda関数（CsvProcessorFunction）でLayersが定義されているため、GlobalsセクションのLayers削除は問題なし。

## 3. 比較分析

### 3.1 template-minimal.yaml vs template.yaml
| 項目 | template-minimal.yaml | template.yaml |
|------|----------------------|---------------|
| **Layersの定義箇所** | CsvProcessorFunctionのみ | Globals + CsvProcessorFunction（重複） |
| **適用されるレイヤー数** | 3つ | 6つ（エラー） |
| **デプロイ結果** | 成功 | 失敗（5レイヤー制限超過） |

### 3.2 その他の差分
template.yamlには以下の追加設定があるが、レイヤーエラーとは無関係：
- Step Functions定義
- 環境変数の追加（REGION、SYSTEM_VERSION等）
- PowerTools関連の環境変数

## 4. 今後の対応

### 4.1 即時対応（完了）
- [x] GlobalsセクションからLayersを削除
- [x] template.yamlの修正を完了

### 4.2 次のステップ
1. 修正後のtemplate.yamlでSAMビルドを実行
2. フルスタックのデプロイを実行
3. デプロイ成功を確認

### 4.3 推奨事項
- **Globalsセクション**：全Lambda関数で共通の設定のみを定義
- **個別Lambda関数**：関数固有の設定（Layers含む）を定義
- **重複チェック**：デプロイ前にGlobalsと個別設定の重複を確認

## 5. 学習事項

### 5.1 AWS Lambda制限事項
- **最大レイヤー数**: 5つまで
- **レイヤーサイズ**: 解凍後250MBまで
- **関数+レイヤー合計**: 解凍後250MBまで

### 5.2 SAM Globalsセクションのベストプラクティス
1. **環境変数**：全関数共通の環境変数のみ定義
2. **タイムアウト**：デフォルト値のみ定義（個別で上書き可能）
3. **Layers**：慎重に使用（個別定義との重複注意）

### 5.3 デバッグ手法
```bash
# CloudFormationエラーの詳細確認
aws cloudformation describe-stack-events \
  --stack-name <stack-name> \
  --region ap-northeast-1 \
  --query "StackEvents[?ResourceStatus=='CREATE_FAILED']"

# SAMビルド後のテンプレート確認
cat .aws-sam/build/template.yaml | grep -A 5 "Layers:"
```

## 6. 関連ドキュメント
- `/docs/01_Document/02_基本設計書/02-01_基本設計書_Lambda開発標準仕様書.md`
- `/docs/01_Document/02_基本設計書/02-02_基本設計書_Lambda関数基本設計.md`
- `/docs/10_Manual/02_AWSSAM環境構築手順.md`