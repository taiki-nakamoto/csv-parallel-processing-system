# CSV処理Date型マーシャリングエラー分析

## 📋 基本情報

- **実施日**: 2025年8月8日
- **エラー種別**: `Unsupported type passed: Date object to DynamoDB marshall`
- **発生場所**: CSV検証段階の監査ログ記録処理
- **対応担当**: システム開発チーム

## 🚨 現在の問題状況

### エラー概要
```
Error: Unsupported type passed: Thu Aug 07 2025 15:03:11 GMT+0000 (Coordinated Universal Time). 
Pass options.convertClassInstanceToMap=true to marshall typeof object as map attribute.
```

### 影響範囲
- CSV処理がValidation段階で停止
- Step Functions全体が `ValidationError` で終了
- 実際のCSVデータ処理に到達しない

## 📊 CSV処理の全体フロー

### 1. CSV検証段階（❌ 現在エラー発生中）
- **処理内容**:
  - S3からCSVファイルを読み込み
  - CSVファイル構造の妥当性チェック（ヘッダー、データ型、行数など）
  - ファイルサイズ・レコード数の確認
- **監査ログ記録**: DynamoDBに処理状況を記録 ← **ここでDate型マーシャリングエラー発生**

### 2. 処理戦略決定（未到達）
- **処理内容**:
  - ファイルサイズに基づく処理方法の選択
  - 小ファイル（≤10,000行）: 単一処理
  - 大ファイル（>10,000行）: 並列チャンク処理

### 3. 実際のCSV処理（未到達）
- **処理内容**:
  - CSVデータをパース
  - ユーザー統計情報（ログイン回数、投稿回数）の抽出・計算
  - Aurora PostgreSQLのユーザーテーブルとの突合・更新
  - 処理結果をS3に出力

### 4. 監査・メタデータ記録（未到達）
- **処理内容**:
  - 処理状況をDynamoDBの複数テーブルに記録：
    - `audit-logs`: 処理履歴
    - `processing-metadata`: 実行状況
    - `batch-jobs`: バッチジョブ情報

## 🔍 技術的根本原因

### Date型マーシャリング問題
- AuditLogやProcessingMetadataオブジェクト作成時に `new Date()` を使用
- DynamoDB保存時に、Date型が文字列に変換されずに直接marshall関数に渡される
- DynamoDBはDate型オブジェクトを直接サポートしないため `Unsupported type passed` エラー

### 問題箇所
- **CSV処理のビジネスロジック自体は正常**
- **処理の監査ログ記録でエラーが発生**

## ✅ 現在正常動作している機能

### インフラ・連携部分
- ✅ EventBridge → Step Functions 自動起動（正常動作）
- ✅ S3イベント検知・通知（正常動作）
- ✅ Step Functions JSONPath修正（正常動作）  
- ✅ エラーハンドリング（ValidationErrorHandling、BatchStatusUpdate実装済み）

### 修正済み項目
- ✅ Lambda関数のRuntime.ImportModuleError解決
- ✅ UserStatisticsクラス実装完了
- ✅ Powertools Metrics設定修正
- ✅ Step Functions JSONPath参照エラー修正
- ✅ handleBatchStatusUpdate実装完了

## 🛠️ 対応方針の提案

### パターン1: 監査ログ機能の一時的コメントアウト

#### 実装内容
```typescript
// 一時的にAuditLog記録を無効化
// await logAuditEvent(container, executionId, eventType, 'INFO', event);
logger.info('Audit logging temporarily disabled for debugging');
```

#### メリット
- **即座にCSV処理の動作確認が可能**
- 核となるビジネスロジックの検証ができる
- 開発スピードの向上

#### デメリット・影響範囲
- **監査機能の完全停止**
- **コンプライアンス要件への不適合**
- 以下への影響:
  - Step Functions: エラーハンドリング部分の監査ログ記録が停止
  - Terraform: 監査ログテーブル定義は維持（データ未投入）
  - 他クラス: AuditLoggingController、AuditLoggingService等が呼び出されなくなる

#### 修正必要箇所
1. `handler.ts`: logAuditEvent呼び出しをコメントアウト
2. `CsvValidationController.ts`: 監査ログ記録部分をコメントアウト
3. `ErrorHandlingController.ts`: 監査ログ記録部分をコメントアウト
4. 各サービスクラス: 監査ログ関連処理をコメントアウト

### パターン2: あるべき姿に沿った根本修正（推奨）

#### 詳細分析結果

**問題の本質**:
- DynamoDBマーシャリング時のDate型オブジェクト混入
- 複数箇所でDate型 → ISO文字列変換が不完全

**修正が必要な箇所**:
1. **AuditLoggingService**: `sanitizeMetadataForDynamoDB`実装済み（要適用範囲拡大）
2. **CsvValidationService**: Date型オブジェクト作成箇所の特定・修正
3. **ProcessingMetadataRepository**: メタデータ保存時の安全化
4. **その他リポジトリクラス**: 全DynamoDB保存処理の統一的修正

#### 実装方針

**Phase 1: 共通ユーティリティ関数作成**
```typescript
// src/utils/DynamoDbSanitizer.ts
export class DynamoDbSanitizer {
  static sanitizeObject(obj: any): any {
    // Date型を再帰的にISO文字列に変換
  }
}
```

**Phase 2: 各リポジトリでの適用**
- すべてのDynamoDB保存処理で事前サニタイズ実行
- 既存の`toDynamoDbItem`メソッドの検証・修正

**Phase 3: テスト・検証**
- 修正後の動作確認
- Date型オブジェクトが含まれていないことの確認

#### メリット
- **設計仕様に完全準拠**
- **監査・コンプライアンス機能の維持**
- **根本原因の解決**
- **将来的な同様エラーの予防**

#### 実装工数
- 調査・修正: 2-3時間
- テスト・検証: 1-2時間
- **合計**: 3-5時間

## 📝 推奨する進行方針

### 推奨: パターン2（根本修正）

**理由**:
1. **システム設計の完整性維持**
2. **監査要件への準拠継続**
3. **技術的負債の回避**
4. **現在の修正が最終段階（99%完了状態）**

### 実施手順
1. **即座実施**: 共通DynamoDbSanitizerユーティリティ作成
2. **順次適用**: 各リポジトリクラスでの適用
3. **動作確認**: CSV処理フルフロー確認
4. **最終検証**: 監査ログ・メタデータ記録の正常動作確認

## 🎯 結論

現在のシステムは**基本インフラ・連携機能が正常動作**しており、**Date型マーシャリング問題の解決のみ**でフル機能が実現されます。

**パターン2（根本修正）による完全解決**を強く推奨します。

---

**次のアクション**: DynamoDbSanitizerユーティリティクラス作成 → 各リポジトリでの適用 → 動作確認テスト実行