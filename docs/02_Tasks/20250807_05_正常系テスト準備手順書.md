# CSVファイル並列処理システム - 正常系テスト準備手順書

## 1. 概要

### 1.1 テスト目的
- CSVファイル処理の正常系動作確認
- S3 → EventBridge → Step Functions → Lambda のフロー検証
- データベース（Aurora、DynamoDB）連携確認
- 100レコードのCSVファイルでの並列処理性能確認

### 1.2 テスト実施日時
2025年8月7日

### 1.3 テスト環境
- **AWS環境**: dev環境
- **リージョン**: ap-northeast-1
- **処理対象**: 100レコードのユーザー統計CSVファイル

## 2. テスト準備要件

### 2.1 📋 事前準備チェックリスト

#### A. インフラ稼働確認
- [ ] Aurora PostgreSQL稼働中 
  - エンドポイント: `csv-parallel-processing-aurora-dev.cluster-cbuqsk2gi5o4.ap-northeast-1.rds.amazonaws.com`
  - 接続確認: `aws rds describe-db-clusters --db-cluster-identifier csv-parallel-processing-aurora-dev`
  
- [ ] DynamoDBテーブル稼働中
  ```bash
  aws dynamodb list-tables --region ap-northeast-1 | grep csv-parallel-processing
  ```
  
- [ ] S3バケット確認
  ```bash
  aws s3 ls csv-processing-526636471122-dev
  ```
  
- [ ] Step Functions StateMachine確認
  ```bash
  aws stepfunctions describe-state-machine --state-machine-arn "arn:aws:states:ap-northeast-1:526636471122:stateMachine:csv-parallel-processing-csv-processing-dev"
  ```

#### B. Lambda関数設定確認
- [ ] 環境変数設定完了
- [ ] VPC設定有効化（Aurora接続用）
- [ ] IAMロール権限確認

#### C. EventBridge設定確認
- [ ] S3イベント通知有効
- [ ] EventBridgeルール有効
- [ ] Step Functionsターゲット設定完了

## 3. データ準備手順

### 3.1 Aurora PostgreSQL事前データ登録

#### 3.1.1 データベース接続
```bash
# Aurora接続情報確認
aws secretsmanager get-secret-value \
  --secret-id "arn:aws:secretsmanager:ap-northeast-1:526636471122:secret:rds!cluster-9473744a-7f41-4d4e-88d7-427a8d09eadd-hOXGZz" \
  --query SecretString --output text | jq
```

#### 3.1.2 テスト用ユーザーデータ登録
```sql
-- データベース接続後、以下のSQLを実行
-- テスト用ユーザーマスタ登録（U00001〜U00100）

INSERT INTO users (user_id, username, email, created_at, updated_at, is_active, metadata) VALUES
('U00001', 'testuser001', 'test001@example.com', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, TRUE, '{}'),
('U00002', 'testuser002', 'test002@example.com', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, TRUE, '{}'),
('U00003', 'testuser003', 'test003@example.com', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, TRUE, '{}'),
-- ... (U00004〜U00099は同様のパターン)
('U00100', 'testuser100', 'test100@example.com', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, TRUE, '{}');

-- 登録確認
SELECT COUNT(*) FROM users WHERE user_id LIKE 'U00%';
-- 結果: 100 が返ることを確認
```

#### 3.1.3 統計テーブル初期化
```sql
-- user_statisticsテーブルの既存データクリア（テスト用）
DELETE FROM user_statistics WHERE user_id LIKE 'U00%';

-- 確認
SELECT COUNT(*) FROM user_statistics WHERE user_id LIKE 'U00%';
-- 結果: 0 が返ることを確認
```

### 3.2 DynamoDB初期状態確認
```bash
# 監査ログテーブルの既存データ確認
aws dynamodb scan \
  --table-name csv-parallel-processing-audit-logs-dev \
  --select "COUNT" \
  --region ap-northeast-1

# 処理メタデータテーブルの確認
aws dynamodb scan \
  --table-name csv-parallel-processing-processing-metadata-dev \
  --select "COUNT" \
  --region ap-northeast-1
```

### 3.3 テストCSVファイル準備
- **ファイル名**: `test-user-stats-20250807-100records.csv`
- **配置場所**: プロジェクトルート
- **レコード数**: 100件（ヘッダー含む101行）
- **フォーマット**: `ユーザーID,ログイン回数,投稿回数`

## 4. テスト実行手順

### 4.1 Phase 1: S3アップロードテスト

#### 4.1.1 CSVファイルアップロード
```bash
# S3バケットにCSVファイルをアップロード
aws s3 cp test-user-stats-20250807-100records.csv \
  s3://csv-processing-526636471122-dev/incoming/ \
  --region ap-northeast-1

# アップロード確認
aws s3 ls s3://csv-processing-526636471122-dev/incoming/
```

#### 4.1.2 EventBridge自動起動確認（期待）
- S3アップロードから数秒以内にEventBridgeがStep Functionsを起動
- 実際は手動実行が必要になる可能性あり

### 4.2 Phase 2: Step Functions手動実行（バックアップ）

#### 4.2.1 手動実行コマンド
```bash
# Step Functions実行
aws stepfunctions start-execution \
  --state-machine-arn "arn:aws:states:ap-northeast-1:526636471122:stateMachine:csv-parallel-processing-csv-processing-dev" \
  --name "test-execution-$(date +%s)" \
  --input '{
    "s3Bucket": "csv-processing-526636471122-dev",
    "s3Key": "incoming/test-user-stats-20250807-100records.csv",
    "executionId": "test-run-001",
    "eventType": "csv-validation"
  }' \
  --region ap-northeast-1
```

#### 4.2.2 実行状況監視
```bash
# 実行中のStep Functions確認
aws stepfunctions list-executions \
  --state-machine-arn "arn:aws:states:ap-northeast-1:526636471122:stateMachine:csv-parallel-processing-csv-processing-dev" \
  --status-filter RUNNING \
  --region ap-northeast-1
```

### 4.3 Phase 3: 処理結果確認

#### 4.3.1 Step Functions実行結果
```bash
# 最新実行の詳細確認
EXECUTION_ARN=$(aws stepfunctions list-executions \
  --state-machine-arn "arn:aws:states:ap-northeast-1:526636471122:stateMachine:csv-parallel-processing-csv-processing-dev" \
  --max-items 1 \
  --query "executions[0].executionArn" \
  --output text)

aws stepfunctions describe-execution \
  --execution-arn $EXECUTION_ARN \
  --region ap-northeast-1
```

#### 4.3.2 Lambda関数ログ確認
```bash
# Lambda関数の最新ログストリーム確認
aws logs describe-log-streams \
  --log-group-name "/aws/lambda/csv-parallel-processing-csv-processor-dev" \
  --order-by LastEventTime \
  --descending \
  --max-items 5 \
  --region ap-northeast-1

# 最新ログイベント取得
LOG_STREAM=$(aws logs describe-log-streams \
  --log-group-name "/aws/lambda/csv-parallel-processing-csv-processor-dev" \
  --order-by LastEventTime \
  --descending \
  --max-items 1 \
  --query "logStreams[0].logStreamName" \
  --output text)

aws logs get-log-events \
  --log-group-name "/aws/lambda/csv-parallel-processing-csv-processor-dev" \
  --log-stream-name "$LOG_STREAM" \
  --region ap-northeast-1
```

#### 4.3.3 データベース結果確認
```sql
-- Aurora: 統計データ更新確認
SELECT 
  user_id,
  login_count,
  post_count,
  updated_at
FROM user_statistics 
WHERE user_id LIKE 'U00%'
ORDER BY user_id
LIMIT 10;

-- 更新レコード数確認
SELECT COUNT(*) as updated_users 
FROM user_statistics 
WHERE user_id LIKE 'U00%' 
  AND updated_at > CURRENT_TIMESTAMP - INTERVAL '1 hour';
```

#### 4.3.4 DynamoDB監査ログ確認
```bash
# 監査ログ確認
aws dynamodb scan \
  --table-name csv-parallel-processing-audit-logs-dev \
  --filter-expression "contains(execution_id, :exec_id)" \
  --expression-attribute-values '{":exec_id": {"S": "test-run-001"}}' \
  --region ap-northeast-1 \
  --max-items 10

# 処理メタデータ確認
aws dynamodb scan \
  --table-name csv-parallel-processing-processing-metadata-dev \
  --filter-expression "contains(file_name, :file)" \
  --expression-attribute-values '{":file": {"S": "test-user-stats-20250807-100records.csv"}}' \
  --region ap-northeast-1
```

#### 4.3.5 S3結果出力確認
```bash
# 処理結果ファイル確認
aws s3 ls s3://csv-processing-526636471122-dev/output/ --recursive

# 結果ファイルダウンロード（あれば）
aws s3 cp s3://csv-processing-526636471122-dev/output/results/ . --recursive
```

## 5. 成功判定基準

### 5.1 ✅ 正常完了の条件
1. **Step Functions実行**: `SUCCEEDED`ステータスで完了
2. **Lambda関数**: エラーなく全てのイベントタイプを処理
3. **データ整合性**: CSV100レコード全てがAuroraに反映
4. **監査ログ**: DynamoDBに全処理ログが記録
5. **処理時間**: 15分以内での完了（目安）

### 5.2 ⚠️ 注意すべきポイント
- **VPC接続**: Aurora接続エラーの可能性
- **環境変数**: 設定不備による処理失敗
- **IAM権限**: 各サービスへのアクセス権限エラー
- **並列処理**: 同時実行数制限による性能低下

## 6. トラブルシューティング

### 6.1 よくある問題と対処法

#### 問題1: Lambda関数がAuroraに接続できない
**原因**: VPC設定が未適用
**対処法**: 
```bash
# SAM template.yamlでVPC設定を有効化し再デプロイ
sam build && sam deploy --no-confirm-changeset
```

#### 問題2: 環境変数が読み込まれない
**原因**: template.yamlの環境変数設定不備
**対処法**: 環境変数を設定しSAM再デプロイ

#### 問題3: Step Functions実行が開始されない
**原因**: EventBridge設定問題
**対処法**: 手動実行で機能確認後、EventBridge設定を見直し

#### 問題4: データベース接続エラー
**原因**: Aurora接続情報またはSecrets Manager設定問題
**対処法**: 
```bash
# Aurora接続確認
aws rds describe-db-clusters --db-cluster-identifier csv-parallel-processing-aurora-dev

# Secrets Manager確認
aws secretsmanager describe-secret --secret-id "arn:aws:secretsmanager:ap-northeast-1:526636471122:secret:rds!cluster-9473744a-7f41-4d4e-88d7-427a8d09eadd-hOXGZz"
```

## 7. テスト実行スケジュール

### 7.1 推奨実行タイミング
1. **事前準備**: 1-2時間（データ登録、設定確認）
2. **テスト実行**: 30分（実行と初期確認）
3. **結果検証**: 1時間（詳細データ確認）
4. **レポート作成**: 30分

### 7.2 実行前最終チェック
- [ ] Aurora PostgreSQLにテストユーザー100件登録完了
- [ ] Lambda環境変数設定完了
- [ ] VPC設定有効化完了
- [ ] CSVファイル準備完了
- [ ] モニタリング環境準備完了

## 8. 期待される処理フロー

```
1. S3アップロード
   ↓ (EventBridge自動起動)
2. Step Functions開始
   ↓
3. CSV検証フェーズ
   - ヘッダー検証
   - データ形式検証
   - ファイルサイズ確認
   ↓
4. 並列処理フェーズ（最大5並列）
   - ユーザー存在確認（Aurora）
   - 統計データ更新（Aurora）
   - 監査ログ記録（DynamoDB）
   ↓
5. 集約・完了フェーズ
   - 処理サマリー作成
   - 結果ファイル出力（S3）
   - 完了通知
```

## 9. 次のステップ

### 9.1 テスト成功後
- 性能測定データの分析
- 1000レコードでの拡張テスト計画
- 本格運用への移行準備

### 9.2 テスト失敗時
- エラー原因の詳細分析
- 設定・実装の修正
- 再テスト計画の策定

---

**注意**: このテストは本格運用前の最終検証です。全ての準備を確実に実施してからテスト実行を開始してください。