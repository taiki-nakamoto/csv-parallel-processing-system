# Lambdaå®Ÿè£…è¨­è¨ˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯çµæœ

## 1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå | Lambdaå®Ÿè£…è¨­è¨ˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯çµæœ |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 1.0 |
| ä½œæˆæ—¥ | 2025-08-06 |
| ä½œæˆè€… | ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ  |
| ãƒã‚§ãƒƒã‚¯å¯¾è±¡ | Lambda/Step Functionså®Ÿè£…å†…å®¹ã¨è¨­è¨ˆæ›¸ã®æ•´åˆæ€§ |

## 2. ãƒã‚§ãƒƒã‚¯æ¦‚è¦

CSVä¸¦åˆ—å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã®Lambda/Step Functionså®Ÿè£…å†…å®¹ã¨è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆdocs/01_Documenté…ä¸‹ï¼‰ã®æ•´åˆæ€§ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚

### 2.1 ãƒã‚§ãƒƒã‚¯å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- **å®Ÿè£…**: `sam/template.yaml`, `sam/src/**/*.ts`, `sam/statemachine/*.json`
- **è¨­è¨ˆæ›¸**: åŸºæœ¬è¨­è¨ˆæ›¸ã€è©³ç´°è¨­è¨ˆæ›¸ï¼ˆLambdaã€Step Functionsã€ç›£æŸ»ãƒ­ã‚°é–¢é€£ï¼‰

## 3. é‡å¤§ãªå·®ç•°ãƒã‚¤ãƒ³ãƒˆ

### 3.1 **æœ€é‡è¦: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ€æƒ³ã®æ ¹æœ¬çš„ç›¸é•**

#### è¨­è¨ˆè¦ä»¶
- **çµ±åˆLambdaé–¢æ•°**: `csv-processor`ï¼ˆ1ã¤ã®é–¢æ•°ï¼‰
- **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•**: `eventType`ã«ã‚ˆã‚‹æ©Ÿèƒ½æŒ¯ã‚Šåˆ†ã‘
- **DIPé©ç”¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: Domain Interface â†’ Infrastructureå®Ÿè£…

#### ç¾åœ¨ã®å®Ÿè£…
- **åˆ†é›¢Lambdaé–¢æ•°**: 5ã¤ã®ç‹¬ç«‹é–¢æ•°ï¼ˆCsvValidation, ChunkProcessing, etc.ï¼‰
- **S3Eventç›´æ¥å‡¦ç†**: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•æ©Ÿæ§‹ãªã—
- **å¾“æ¥å‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: Domain Interfaceãªã—ã®Repositoryç›´æ¥å®Ÿè£…

**å½±éŸ¿åº¦**: ğŸ”´ **æ¥µã‚ã¦é«˜ã„**ï¼ˆè¨­è¨ˆæ€æƒ³ãƒ¬ãƒ™ãƒ«ã®ç›¸é•ï¼‰

### 3.2 **Step Functionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸æ•´åˆ**

#### è¨­è¨ˆè¦ä»¶
```json
{
  "ProcessorConfig": {
    "Mode": "DISTRIBUTED",
    "ExecutionType": "STANDARD"
  },
  "ToleratedFailurePercentage": 5
}
```

#### ç¾åœ¨ã®å®Ÿè£…
```json
{
  "Type": "Map",
  "MaxConcurrency": 10
  // åˆ†æ•£ãƒãƒƒãƒ—è¨­å®šãªã—
  // éšœå®³è¨±å®¹è¨­å®šãªã—
}
```

**å½±éŸ¿åº¦**: ğŸŸ¡ **ä¸­ç¨‹åº¦**ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»å¯ç”¨æ€§ã«å½±éŸ¿ï¼‰

### 3.3 **DIPé•å**

#### è¨­è¨ˆè¦ä»¶
```typescript
// Domainå±¤ã§Interfaceå®šç¾©
export interface IUserRepository {
  findById(userId: string): Promise<User | null>;
}

// Infrastructureå±¤ã§å®Ÿè£…
export class UserRepository implements IUserRepository {
  async findById(userId: string): Promise<User | null> { ... }
}
```

#### ç¾åœ¨ã®å®Ÿè£…
```typescript
// Domain Interfaceãªã—ã€ç›´æ¥Repositoryå®Ÿè£…
export class S3CsvRepository {
  async getCsvContent(...): Promise<string> { ... }
}
```

**å½±éŸ¿åº¦**: ğŸŸ¡ **ä¸­ç¨‹åº¦**ï¼ˆä¿å®ˆæ€§ãƒ»ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã«å½±éŸ¿ï¼‰

## 4. å…·ä½“çš„ãªä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ

### 4.1 **å„ªå…ˆåº¦1: çµ±åˆLambdaé–¢æ•°åŒ–**

#### 4.1.1 template.yamlä¿®æ­£
```yaml
Resources:
  # æ—¢å­˜ã®5å€‹Lambdaé–¢æ•°ã‚’å‰Šé™¤ã—ã€çµ±åˆé–¢æ•°ã«ç½®ãæ›ãˆ
  CsvProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-csv-processor-${Environment}'
      CodeUri: src/
      Handler: handler.handler  # çµ±åˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      Environment:
        Variables:
          # æ—¢å­˜ç’°å¢ƒå¤‰æ•°ã‚’çµ±åˆ
```

#### 4.1.2 çµ±åˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ä½œæˆ
```typescript
// æ–°è¦ä½œæˆ: src/handler.ts
import { DIContainer } from './infrastructure/di/DIContainer';
import { EventParser } from './utils/EventParser';

export const handler = async (event: any, context: Context) => {
  const diContainer = DIContainer.getInstance();
  const eventType = EventParser.parseEventType(event);
  
  switch (eventType) {
    case 'CSV_VALIDATION':
      const controller = diContainer.createValidationController();
      return await controller.validate(event);
    case 'CSV_CHUNK_PROCESSING':
      // ... ä»–ã®eventTypeå‡¦ç†
    default:
      throw new Error(`Unsupported event type: ${eventType}`);
  }
};
```

### 4.2 **å„ªå…ˆåº¦2: Domain Interfaceå®Ÿè£…**

#### 4.2.1 Domain Interfaceå®šç¾©
```typescript
// æ–°è¦ä½œæˆ: src/domain/interfaces/IUserRepository.ts
export interface IUserRepository {
  findById(userId: string): Promise<User | null>;
  save(user: User): Promise<void>;
  update(user: User): Promise<void>;
}

// æ–°è¦ä½œæˆ: src/domain/interfaces/IS3Repository.ts
export interface IS3Repository {
  getCsvContent(bucketName: string, objectKey: string): Promise<string>;
  putCsvContent(bucketName: string, objectKey: string, content: string): Promise<void>;
}
```

#### 4.2.2 Infrastructureå±¤ã§ã®å®Ÿè£…
```typescript
// ä¿®æ­£: src/infrastructure/repositories/S3CsvRepository.ts
import { IS3Repository } from '@domain/interfaces/IS3Repository';

export class S3CsvRepository implements IS3Repository {
  // æ—¢å­˜å®Ÿè£…ã¯IS3Repositoryã«æº–æ‹ ã™ã‚‹ã‚ˆã†ä¿®æ­£
}
```

### 4.3 **å„ªå…ˆåº¦3: DIContainerå®Ÿè£…**

```typescript
// æ–°è¦ä½œæˆ: src/infrastructure/di/DIContainer.ts
export class DIContainer {
  private static instance: DIContainer;
  
  static getInstance(): DIContainer {
    if (!DIContainer.instance) {
      DIContainer.instance = new DIContainer();
    }
    return DIContainer.instance;
  }
  
  createValidationController(): ValidationController {
    return new ValidationController(
      this.createCsvValidationService()
    );
  }
  
  private createCsvValidationService(): CsvValidationService {
    return new CsvValidationService(
      this.createS3Repository(),
      this.createAuditRepository()
    );
  }
  
  private createS3Repository(): IS3Repository {
    return new S3CsvRepository();
  }
  
  private createAuditRepository(): IAuditLogRepository {
    return new DynamoDbAuditRepository();
  }
}
```

### 4.4 **å„ªå…ˆåº¦4: Step Functionsä¿®æ­£**

```json
{
  "ParallelChunkProcessing": {
    "Type": "Map",
    "ItemProcessor": {
      "ProcessorConfig": {
        "Mode": "DISTRIBUTED",
        "ExecutionType": "STANDARD"
      },
      "StartAt": "ProcessChunk",
      "States": {
        "ProcessChunk": {
          "Type": "Task",
          "Resource": "${CsvProcessorFunctionArn}",
          "Parameters": {
            "eventType": "CSV_CHUNK_PROCESSING",
            "chunkIndex.$": "$$.Map.Item.Index"
          }
        }
      }
    },
    "MaxConcurrency": 5,
    "ToleratedFailurePercentage": 5,
    "ToleratedFailureCount": 10
  }
}
```

## 5. è¿½åŠ å®Ÿè£…ãŒå¿…è¦ãªæ©Ÿèƒ½

### 5.1 **User Domain Model**
```typescript
// æ–°è¦ä½œæˆ: src/domain/models/User.ts
export class User {
  constructor(
    private readonly userId: string,
    private loginCount: number,
    private postCount: number
  ) {}
  
  updateStatistics(loginCount: number, postCount: number): void {
    // ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«é©ç”¨
    this.loginCount = loginCount;
    this.postCount = postCount;
  }
  
  // ã‚²ãƒƒã‚¿ãƒ¼ãƒ»ã‚»ãƒƒã‚¿ãƒ¼ç­‰
}
```

### 5.2 **EventParser Utility**
```typescript
// æ–°è¦ä½œæˆ: src/utils/EventParser.ts
export class EventParser {
  static parseEventType(event: any): string {
    // S3Event
    if (event.Records && event.Records[0].eventSource === 'aws:s3') {
      return 'CSV_VALIDATION';
    }
    
    // Step Functions Event
    if (event.eventType) {
      return event.eventType;
    }
    
    // CloudWatch Event
    if (event.source === 'aws.stepfunctions') {
      return 'AUDIT_LOGGING';
    }
    
    throw new Error('Unknown event type');
  }
}
```

### 5.3 **åŒ…æ‹¬çš„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
```typescript
// æ–°è¦ä½œæˆ: src/utils/ErrorHandler.ts
export class ErrorHandler {
  static handle(error: Error, context: Context): ErrorResponse {
    if (error instanceof DomainError) {
      return ResponseFormatter.formatDomainError(error);
    }
    
    if (error instanceof ValidationError) {
      return ResponseFormatter.formatValidationError(error);
    }
    
    // ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼
    logger.error('System error occurred', { error, context });
    return ResponseFormatter.formatSystemError(error);
  }
}
```

## 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

### 6.1 **æœªå®Ÿè£…ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶**
- [ ] IAM Roleæœ€å°æ¨©é™åŸå‰‡ã®è©³ç´°è¨­å®š
- [ ] VPCè¨­å®šã®ç’°å¢ƒå¤‰æ•°åŒ–
- [ ] Secrets Managerä½¿ç”¨ï¼ˆç¾åœ¨ã¯ç’°å¢ƒå¤‰æ•°ç›´æ¥å‚ç…§ï¼‰
- [ ] Lambdaé–¢æ•°é–“ã®IAMæ¨©é™åˆ†é›¢

### 6.2 **æœªå®Ÿè£…ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶**
- [ ] Lambdaäºˆç´„åŒæ™‚å®Ÿè¡Œæ•°è¨­å®š
- [ ] ãƒ¡ãƒ¢ãƒªãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®æ©Ÿèƒ½åˆ¥æœ€é©åŒ–  
- [ ] Step Functionsåˆ†æ•£ãƒãƒƒãƒ—æ´»ç”¨
- [ ] CloudWatch ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹

### 6.3 **æœªå®Ÿè£…ç›£è¦–è¦ä»¶**
- [ ] X-Rayåˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°çµ±åˆ
- [ ] SNSé€šçŸ¥è¨­å®š
- [ ] CloudWatch Alarmsè¨­å®š
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä½œæˆ

## 7. å¯¾å¿œæ–¹é‡ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### 7.1 **æ®µéšçš„ç§»è¡Œã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**

#### ãƒ•ã‚§ãƒ¼ã‚º1: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£çµ±åˆï¼ˆå„ªå…ˆåº¦1-2ï¼‰
1. çµ±åˆLambdaé–¢æ•°ã®å®Ÿè£…
2. Domain Interface + DIPé©ç”¨
3. DIContainerå°å…¥
4. æ—¢å­˜æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª

#### ãƒ•ã‚§ãƒ¼ã‚º2: Step Functionså¼·åŒ–ï¼ˆå„ªå…ˆåº¦3ï¼‰
1. åˆ†æ•£ãƒãƒƒãƒ—å®Ÿè£…
2. éšœå®³è¨±å®¹è¨­å®š
3. çµ±åˆLambdaé–¢æ•°ã¨ã®é€£æº

#### ãƒ•ã‚§ãƒ¼ã‚º3: ç›£è¦–ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼ˆå„ªå…ˆåº¦4ï¼‰
1. åŒ…æ‹¬çš„ç›£æŸ»ãƒ­ã‚°
2. ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šå¼·åŒ–

### 7.2 **æ¨å¥¨å®Ÿæ–½é †åº**
1. **Domain Interfaceè¨­è¨ˆ** â†’ **DIContainerå®Ÿè£…** â†’ **çµ±åˆHandlerä½œæˆ**
2. **Step Functionsä¿®æ­£** â†’ **åˆ†æ•£ãƒãƒƒãƒ—é©ç”¨**
3. **ç›£è¦–ãƒ»ãƒ­ã‚°å¼·åŒ–** â†’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š**

### 7.3 **ãƒªã‚¹ã‚¯è»½æ¸›ç­–**
- æ—¢å­˜æ©Ÿèƒ½ã‚’ç ´å£Šã—ãªã„æ®µéšçš„ç§»è¡Œ
- ååˆ†ãªå˜ä½“ãƒ†ã‚¹ãƒˆãƒ»çµåˆãƒ†ã‚¹ãƒˆå®Ÿè£…
- Blue/Green ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã‚ˆã‚‹å®‰å…¨ãªæœ¬ç•ªé©ç”¨

## 8. çµè«–

ç¾åœ¨ã®å®Ÿè£…ã¯è¨­è¨ˆæ€æƒ³ãƒ¬ãƒ™ãƒ«ã§**æ ¹æœ¬çš„ãªç›¸é•**ãŒã‚ã‚Šã¾ã™ã€‚ç‰¹ã«ã€Œçµ±åˆLambdaé–¢æ•° + DIPé©ç”¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€vsã€Œãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€ã¨ã„ã†ç‚¹ã§è¨­è¨ˆæ„å›³ã¨å¤§ããä¹–é›¢ã—ã¦ã„ã¾ã™ã€‚

**ç·Šæ€¥åº¦**: ğŸ”´ **é«˜ã„** - è¨­è¨ˆæ€æƒ³ã®çµ±ä¸€ãŒå¿…è¦
**å·¥æ•°è¦‹ç©**: ç´„20-30äººæ—¥ï¼ˆæ®µéšçš„ç§»è¡Œã‚’æƒ³å®šï¼‰
**å®Œäº†æœŸé™**: é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºå†…ã§ã®æ—©æœŸå¯¾å¿œã‚’æ¨å¥¨

ã“ã®æ•´åˆæ€§ç¢ºä¿ã«ã‚ˆã‚Šã€è¨­è¨ˆæ›¸ã§æ„å›³ã—ãŸä¿å®ˆæ€§ãƒ»æ‹¡å¼µæ€§ãƒ»ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚