# CSVファイル並列処理システム 製造タスク管理

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| ドキュメント名 | 製造タスク管理 |
| バージョン | 1.0 |
| 作成日 | 2025-08-04 |
| 作成者 | システム開発チーム |
| 更新日 | 2025-08-04 |

## 2. 製造概要

### 2.1 製造方針
- **段階的実装**: インフラ → 開発環境 → ソースコード の順序で製造
- **Infrastructure as Code**: Terraform + SAM による自動化
- **テスト駆動**: 単体テスト、統合テスト、E2Eテストの段階的実装
- **CI/CD自動化**: GitHub Actions による継続的インテグレーション・デプロイ

### 2.2 製造順序
1. **製造準備フェーズ**: AWS環境・GitHub環境の準備
2. **インフラ製造フェーズ**: Terraformによるインフラリソース作成
3. **開発環境構築フェーズ**: ローカル開発環境の構築
4. **ソースコード製造フェーズ**: Lambda関数・Step Functions実装

## 3. 製造準備フェーズ ⏳進行中

### 3.1 AWS環境準備 ✅完了 - 参照: 20250804_06_AWS環境準備結果.md
- [x] **AWSアカウント設定**
  - [x] 開発用AWSアカウント準備 - アカウントID: 526636471122
  - [x] 本番用AWSアカウント準備（必要に応じて）
  - [x] AWS CLI設定・認証情報設定 - v2.27.45 設定済み
  - [x] AWS Profile設定（dev/prod環境分離） - default プロファイル使用中

- [x] **IAMユーザー・ロール準備**
  - [x] Terraform実行用IAMユーザー確認 - dev-terrarom-naka（管理者権限あり）
  - [x] SAM Deploy用IAMユーザー確認 - dev-terrarom-naka（AdministratorAccess）
  - [x] CI/CD用IAMロール準備完了 - 管理者権限で作業可能
  - [x] 必要な権限ポリシーのアタッチ - AdministratorAccess + IAMUserChangePassword

- [x] **S3バケット準備** ✅完了 - 参照: 01_Document/04-01_製造準備_AWS環境.md
  - [x] Terraform State管理用S3バケット決定
    - [x] バケット名: `naka-enginner-tfstate` （既存バケット利用決定）
    - [x] バージョニング有効化済み
    - [x] サーバーサイド暗号化設定済み (AES256)
    - [x] プロジェクト用パス: `05_csv-batch/dev/` を使用
  - [x] SAM Artifacts用S3バケット作成 ✅完了
    - [x] バケット名: `naka-sam-artifacts` (作成済み)
    - [x] バージョニング有効化済み
    - [x] ライフサイクルポリシー設定済み (90日後削除、旧バージョン30日後削除)
    - [x] パブリックアクセス完全ブロック設定済み

- [x] **DynamoDB準備**（必要に応じて）
  - [x] Terraform State Lock用DynamoDBテーブル作成
    - [x] テーブル名: `terraform-state-lock`
    - [x] プライマリキー: `LockID`
    - [x] 読み書き容量モード設定

### 3.2 GitHub環境準備 ⏳未着手
- [ ] **リポジトリ設定**
  - [ ] GitHubリポジトリ作成
    - [ ] リポジトリ名: `csv-parallel-processing-system`
    - [ ] プライベートリポジトリ設定
    - [ ] README.md、.gitignore作成
  - [ ] ブランチ保護ルール設定
    - [ ] mainブランチ保護
    - [ ] developブランチ保護
    - [ ] プルリクエスト必須化

- [ ] **GitHub Actions設定**
  - [ ] Secrets設定
    - [ ] `AWS_ACCESS_KEY_ID`
    - [ ] `AWS_SECRET_ACCESS_KEY`
    - [ ] `AWS_REGION`
    - [ ] その他環境変数
  - [ ] Environments設定
    - [ ] development環境
    - [ ] production環境

- [ ] **初期ディレクトリ構成作成**
  ```
  csv-parallel-processing-system/
  ├── .github/workflows/
  ├── terraform/
  ├── sam-lambda/
  ├── docs/
  ├── tests/
  └── scripts/
  ```

### 3.3 開発ツール準備 ⏳未着手
- [ ] **必要ツールのインストール確認**
  - [ ] AWS CLI v2
  - [ ] SAM CLI
  - [ ] Terraform
  - [ ] Node.js (Lambda開発用)
  - [ ] TypeScript
  - [ ] Docker (SAMローカル実行用)
  - [ ] Git

- [ ] **IDE・エディタ設定**
  - [ ] VS Code設定ファイル作成
  - [ ] 拡張機能推奨リスト作成
  - [ ] ESLint、Prettier設定ファイル作成

## 4. インフラ製造フェーズ ⏳未着手

### 4.1 Terraform基盤構築 ⏳未着手
- [ ] **Terraformプロジェクト初期化**
  - [ ] プロバイダー設定（AWS Provider）
  - [ ] Backend設定（S3 + DynamoDB）
  - [ ] Variables定義ファイル作成
  - [ ] Output定義ファイル作成

- [ ] **共通モジュール作成**
  - [ ] ネットワークモジュール（VPC、Subnet、Security Group）
  - [ ] IAMモジュール（ロール、ポリシー）
  - [ ] S3モジュール（バケットポリシー、CORS設定）
  - [ ] DynamoDBモジュール（テーブル定義）
  - [ ] CloudWatchモジュール（ログ、メトリクス、アラーム）

### 4.2 ネットワークインフラ構築 ⏳未着手
- [ ] **VPC構築** - 参照: 03-01_詳細設計書_インフラ詳細設計.md
  - [ ] VPC作成 (10.0.1.0/24)
  - [ ] パブリックサブネット作成 (10.0.1.0/27)
  - [ ] プライベートサブネット作成 (10.0.1.32/27)
  - [ ] インターネットゲートウェイ作成
  - [ ] NATゲートウェイ作成（必要に応じて）
  - [ ] ルートテーブル作成・関連付け

- [ ] **セキュリティグループ構築**
  - [ ] Lambda用セキュリティグループ
  - [ ] Aurora用セキュリティグループ
  - [ ] VPCエンドポイント用セキュリティグループ

### 4.3 データベースインフラ構築 ⏳未着手
- [ ] **Aurora PostgreSQL構築** - 参照: 03-14_詳細設計書_データモデル詳細設計.md
  - [ ] DBサブネットグループ作成
  - [ ] DBパラメータグループ作成
  - [ ] Aurora Serverless v2クラスター作成
  - [ ] データベース・テーブル作成
  - [ ] 初期データ投入（必要に応じて）

- [ ] **DynamoDB構築**
  - [ ] 監査ログテーブル作成 (`csv_audit_logs`)
  - [ ] グローバルセカンダリインデックス作成
  - [ ] TTL設定（ログ自動削除）
  - [ ] Auto Scaling設定

### 4.4 ストレージインフラ構築 ⏳未着手
- [ ] **S3バケット構築** - 参照: 02-05_基本設計書_S3バケット設計.md
  - [ ] 入力ファイル用バケット (`csv-input-files-{account-id}`)
  - [ ] 処理済みファイル用バケット (`csv-processed-files-{account-id}`)
  - [ ] エラーファイル用バケット (`csv-error-files-{account-id}`)
  - [ ] バケットポリシー・CORS設定
  - [ ] ライフサイクルポリシー設定

### 4.5 監視・ログインフラ構築 ⏳未着手
- [ ] **CloudWatch構築** - 参照: 03-12_詳細設計書_監視・ログ詳細設計.md
  - [ ] ロググループ作成
  - [ ] カスタムメトリクス設定
  - [ ] CloudWatchアラーム作成
  - [ ] SNSトピック作成（アラート通知用）

- [ ] **X-Ray設定**
  - [ ] X-Rayサービスマップ有効化
  - [ ] トレーシング設定

### 4.6 IAMロール・ポリシー構築 ⏳未着手
- [ ] **Step Functions用IAMロール** - 参照: 03-01_詳細設計書_インフラ詳細設計.md
  - [ ] Step Functions実行ロール作成
  - [ ] 分散マップ用ロール作成
  - [ ] 必要ポリシーのアタッチ

- [ ] **Lambda用IAMロール**
  - [ ] csv-processor関数用ロール作成
  - [ ] VPC、S3、DynamoDB、Aurora接続権限設定

## 5. 開発環境構築フェーズ ⏳未着手

### 5.1 SAMプロジェクト初期化 ⏳未着手
- [ ] **SAMアプリケーション作成** - 参照: 02-01_基本設計書_Lambda開発標準仕様書.md
  - [ ] `sam init` によるプロジェクト初期化
  - [ ] TypeScript テンプレート選択
  - [ ] ディレクトリ構成作成（DIP準拠）
    ```
    sam-lambda/
    ├── src/
    │   ├── controllers/          # プレゼンテーション層
    │   ├── application/          # アプリケーション層
    │   ├── domain/               # ドメイン層
    │   │   ├── models/          # ドメインモデル
    │   │   └── interfaces/      # ドメインインターfaces
    │   └── infrastructure/      # インフラストラクチャ層
    │       └── repositories/    # リポジトリ実装
    ├── layers/                  # Lambda Layers
    ├── tests/                   # テストコード
    └── template.yaml           # SAMテンプレート
    ```

- [ ] **package.json設定**
  - [ ] TypeScript依存関係設定
  - [ ] ESLint、Prettier設定
  - [ ] テストフレームワーク設定（Jest）
  - [ ] AWS SDK v3依存関係設定

### 5.2 開発環境設定 ⏳未着手
- [ ] **ローカル開発環境**
  - [ ] SAM local環境構築
  - [ ] DynamoDB Local設定
  - [ ] Docker Compose設定（LocalStack等）
  - [ ] 環境変数設定ファイル作成

- [ ] **設定ファイル作成**
  - [ ] `samconfig.toml` 作成（環境別設定）
  - [ ] TypeScript設定 (`tsconfig.json`)
  - [ ] ESLint設定 (`.eslintrc.js`)
  - [ ] Prettier設定 (`.prettierrc`)
  - [ ] Jest設定 (`jest.config.js`)

### 5.3 CI/CD パイプライン構築 ⏳未着手
- [ ] **GitHub Actions ワークフロー作成** - 参照: 02-09_基本設計書_CI-CD設計書.md
  - [ ] `.github/workflows/pr-check.yml`
    - [ ] TypeScript コンパイルチェック
    - [ ] ESLint 実行
    - [ ] 単体テスト実行
    - [ ] SAM Build確認
  - [ ] `.github/workflows/dev-deploy.yml`
    - [ ] Terraform Plan/Apply（インフラ）
    - [ ] SAM Deploy（Lambda）
    - [ ] 統合テスト実行
  - [ ] `.github/workflows/prod-deploy.yml`
    - [ ] 本番環境デプロイ
    - [ ] ヘルスチェック
    - [ ] ロールバック手順

## 6. ソースコード製造フェーズ ⏳未着手

### 6.1 統合Lambda関数実装 ⏳未着手
- [ ] **csv-processor関数基盤実装** - 参照: 03-06_詳細設計書_CSV統合処理関数.md
  - [ ] メインハンドラー実装（イベント種別ルーティング）
  - [ ] イベントパーサー実装
  - [ ] DI コンテナ設定
  - [ ] ログ設定（構造化ログ）
  - [ ] エラーハンドリング基盤

- [ ] **CSV検証機能実装** (CSV_VALIDATION)
  - [ ] CSVValidationController実装
  - [ ] CSVValidationService実装（アプリケーション層）
  - [ ] CSVValidator実装（ドメイン層）
  - [ ] ValidationRepository実装（インフラ層）

- [ ] **チャンク処理機能実装** (CSV_CHUNK_PROCESSING)
  - [ ] ChunkProcessingController実装
  - [ ] ChunkProcessingService実装
  - [ ] ChunkProcessor実装（ドメイン層）
  - [ ] DataRepository実装（Aurora接続）

- [ ] **監査ログ機能実装** (AUDIT_LOGGING)
  - [ ] AuditLoggingController実装
  - [ ] AuditLoggingService実装
  - [ ] AuditLogger実装（ドメイン層）
  - [ ] AuditRepository実装（DynamoDB接続）

- [ ] **結果集約機能実装** (RESULT_AGGREGATION)
  - [ ] ResultAggregationController実装
  - [ ] ResultAggregationService実装
  - [ ] ResultAggregator実装（ドメイン層）
  - [ ] ResultRepository実装

- [ ] **エラーハンドリング機能実装** (ERROR_HANDLING)
  - [ ] ErrorHandlingController実装
  - [ ] ErrorHandlingService実装
  - [ ] ErrorHandler実装（ドメイン層）
  - [ ] ErrorRepository実装

### 6.2 Lambda Layers実装 ⏳未着手
- [ ] **共通ライブラリLayer**
  - [ ] 共通ユーティリティ関数
  - [ ] AWS SDK Wrapper
  - [ ] ログライブラリ
  - [ ] メトリクス送信ライブラリ

- [ ] **ビジネスロジックLayer**
  - [ ] CSV処理共通ロジック
  - [ ] バリデーション共通ロジック
  - [ ] データ変換共通ロジック

### 6.3 Step Functions実装 ⏳未着手
- [ ] **メインワークフロー実装** - 参照: 03-02_詳細設計書_Step Functions詳細設計.md
  - [ ] ASL（Amazon States Language）定義作成
  - [ ] 分散マップ設定
  - [ ] エラーハンドリング設定
  - [ ] 再試行ポリシー設定

### 6.4 API実装 ⏳未着手
- [ ] **管理API実装** - 参照: 03-13_詳細設計書_API詳細設計.md
  - [ ] Step Functions実行管理API
  - [ ] 実行状況監視API
  - [ ] ファイル管理API
  - [ ] ヘルスチェックAPI

## 7. テスト製造フェーズ ⏳未着手

### 7.1 単体テスト実装 ⏳未着手
- [ ] **Lambda関数単体テスト**
  - [ ] Controller層テスト
  - [ ] Service層テスト
  - [ ] Domain層テスト
  - [ ] Repository層テスト（モック使用）

- [ ] **テストユーティリティ作成**
  - [ ] テストデータ作成ヘルパー
  - [ ] モック作成ヘルパー
  - [ ] テスト環境セットアップ

### 7.2 統合テスト実装 ⏳未着手
- [ ] **AWS サービス統合テスト**
  - [ ] S3連携テスト
  - [ ] DynamoDB連携テスト
  - [ ] Aurora連携テスト
  - [ ] Step Functions連携テスト

### 7.3 E2Eテスト実装 ⏳未着手
- [ ] **エンド・ツー・エンドテスト**
  - [ ] CSVアップロード → 処理完了までの全体テスト
  - [ ] エラーケーステスト
  - [ ] 性能テスト
  - [ ] 負荷テスト（並列処理）

## 8. デプロイ・リリースフェーズ ⏳未着手

### 8.1 開発環境デプロイ ⏳未着手
- [ ] **開発環境構築**
  - [ ] Terraform Apply（開発環境）
  - [ ] SAM Deploy（開発環境）
  - [ ] データベース初期化
  - [ ] 動作確認テスト

### 8.2 本番環境デプロイ ⏳未着手
- [ ] **本番環境準備**
  - [ ] 本番環境インフラ構築
  - [ ] セキュリティ設定確認
  - [ ] 監視・アラート設定確認
  - [ ] バックアップ設定

- [ ] **本番デプロイ実行**
  - [ ] Blue/Green デプロイ実行
  - [ ] 動作確認テスト
  - [ ] 性能テスト
  - [ ] ロールバック手順確認

## 9. 運用準備フェーズ ⏳未着手

### 9.1 運用手順書作成 ⏳未着手
- [ ] **デプロイ手順書作成** - 格納先: 10_Manual/
  - [ ] 01_デプロイ手順書.md
  - [ ] 02_ロールバック手順書.md
  - [ ] 03_設定変更手順書.md

- [ ] **監視・運用手順書作成**
  - [ ] 04_監視手順書.md
  - [ ] 05_アラート対応手順書.md
  - [ ] 06_ログ分析手順書.md

- [ ] **障害対応手順書作成**
  - [ ] 07_障害対応手順書.md
  - [ ] 08_復旧手順書.md
  - [ ] 09_メンテナンス手順書.md

### 9.2 利用者向けドキュメント作成 ⏳未着手
- [ ] **API仕様書作成**
  - [ ] OpenAPI 3.0 仕様書
  - [ ] Postmanコレクション
  - [ ] サンプルコード

- [ ] **システム利用手順書作成**
  - [ ] CSVアップロード手順
  - [ ] 処理状況確認手順
  - [ ] エラー対応手順

## 10. 進捗管理

### 10.1 フェーズ別進捗状況
- 🟡 **製造準備フェーズ**: 60% (進行中)
  - ✅ AWS環境準備完了 (S3バケット作成完了)
  - ⏳ GitHub環境準備
  - ⏳ 開発ツール準備
- 🔴 **インフラ製造フェーズ**: 0% (未着手)
- 🔴 **開発環境構築フェーズ**: 0% (未着手)
- 🔴 **ソースコード製造フェーズ**: 0% (未着手)
- 🔴 **テスト製造フェーズ**: 0% (未着手)
- 🔴 **デプロイ・リリースフェーズ**: 0% (未着手)
- 🔴 **運用準備フェーズ**: 0% (未着手)

### 10.2 次のアクション
1. **GitHub環境準備**: リポジトリ作成、ブランチ保護設定、GitHub Actions Secrets設定
2. **開発ツール準備**: SAM CLI、Terraform等のインストール確認
3. **インフラ製造開始**: Terraformプロジェクト初期化

## 11. 参照設計書

### 11.1 基本設計書
- 02-01_基本設計書_Lambda開発標準仕様書.md
- 02-08_基本設計書_ソース管理設計.md
- 02-09_基本設計書_CI-CD設計書.md

### 11.2 詳細設計書
- 03-01_詳細設計書_インフラ詳細設計.md
- 03-06_詳細設計書_CSV統合処理関数.md
- 03-12_詳細設計書_監視・ログ詳細設計.md
- 03-13_詳細設計書_API詳細設計.md
- 03-14_詳細設計書_データモデル詳細設計.md

## 12. 注意事項

### 12.1 製造時の重要ポイント
- **セキュリティ**: IAMロール・ポリシーは最小権限の原則に従う
- **テスト**: 各フェーズで必ずテストを実行し、品質を担保する
- **ドキュメント**: コード実装と並行して運用手順書を整備する
- **監視**: システム稼働後の監視・アラート設定を忘れずに行う

### 12.2 リスク・課題
- **AWS制限**: Lambda同時実行数、Step Functions分散マップ制限
- **ネットワーク**: VPC設定によるLambda起動時間への影響
- **コスト**: Aurora Serverless、DynamoDBの使用量監視
- **運用**: 24時間監視体制の構築要否検討