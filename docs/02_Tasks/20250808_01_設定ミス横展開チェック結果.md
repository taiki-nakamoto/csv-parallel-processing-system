# 設定ミス横展開チェック結果

## 実施日時
2025-08-08

## チェック概要
TRY&エラーを減らすため、これまでのエラーパターンから体系的な検証を実施

## 1. Step Functions JSONPath不整合（重要度：高）

### 検出された問題

#### 問題1: validationResult重複参照
- **ファイル**: `sam/statemachine/csv-processing-workflow.asl.json`
- **行70**: `"fileMetadata.$": "$.validationResult.validationResult.metadata"`
- **行71**: `"errors.$": "$.validationResult.validationResult.errors"`
- **問題**: `validationResult`が重複している
- **修正**: `$.validationResult.metadata`, `$.validationResult.errors`

#### 問題2: ValidationErrorHandling状態のJSONPath参照
- **行346**: `"error.$": "$.validationResult"`
- **状況**: 既に修正済み（$.validationError → $.validationResult）

#### 問題3: ResultPath不整合の可能性
- **行44**: `"ResultPath": "$.validationError"`
- **懸念**: 後続ステートで参照している場合の不整合

## 2. TypeScript型エラー（重要度：高）

### 検出された問題

#### 問題1: ValidationError重複定義
- **場所1**: `domain/errors/DomainErrors.ts` (正式版 - 3引数)
- **場所2**: `application/services/ChunkProcessingService.ts` (独自版 - 1引数)
- **影響**: CsvValidatorでの呼び出し時に引数数不整合

#### 問題2: CsvValidatorでのundefined可能性
現在のTypeScript diagnostics:
- Line 65: `string[] | undefined` → `string[]`
- Line 76, 84: `CsvRow[] | undefined` → `CsvRow[]`
- Line 93, 112, 113: `'rows' は 'undefined' の可能性があります`

## 3. 横展開検証結果

### A. メソッド呼び出し整合性 ✅
- `CsvFile`クラス: `getHeaders()`, `getDataRowCount()` 正常
- `getFileSize()` → `fileSize` 修正済み

### B. エラークラス使用整合性 ❌
- 重複したValidationError定義が混在
- import/export整合性に問題

### C. JSONPath参照整合性 ❌
- Step Functions定義で重複参照
- ResultPath命名の不統一

## 4. 推奨修正アクション

### 優先度1（即座対応）
1. Step Functions JSONPath重複参照修正
2. ValidationError重複定義の統一

### 優先度2（次回対応）
1. TypeScriptのundefined可能性対応
2. ResultPath命名統一

### 優先度3（将来対応）
1. 統一的なエラーハンドリング戦略策定

## 5. 予防策提案

### デプロイ前チェックリスト
1. TypeScriptビルドエラー0件確認
2. JSONPath参照の手動検証
3. 統合テストでの動作確認

### 開発標準化
1. エラークラス使用統一ガイドライン
2. Step Functions JSONPath命名規約
3. CI/CDでの静的解析導入