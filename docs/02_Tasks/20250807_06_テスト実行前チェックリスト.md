# 正常系テスト実行前チェックリスト

## 📋 実行日: 2025年8月7日

### 🔧 インフラ準備状況

#### AWS基盤リソース
- [ ] Aurora PostgreSQL稼働中
  - `csv-parallel-processing-aurora-dev.cluster-cbuqsk2gi5o4.ap-northeast-1.rds.amazonaws.com`
- [ ] DynamoDB テーブル4つ稼働中 
  - audit-logs, processing-metadata, batch-jobs, job-locks
- [ ] S3バケット準備完了
  - `csv-processing-526636471122-dev`
- [ ] Step Functions StateMachine Active
  - `csv-parallel-processing-csv-processing-dev`

#### Lambda関数設定
- [ ] **重要**: 環境変数設定完了（S3_BUCKET_NAME, AURORA_ENDPOINT等）
- [ ] **重要**: VPC設定有効化（Aurora接続用）
- [ ] IAMロール権限確認（Terraform作成ロール使用）
- [ ] Lambda Layers適用済み

#### EventBridge設定
- [ ] S3イベント通知有効
- [ ] EventBridgeルール作成済み
- [ ] Step Functionsターゲット設定済み

### 💾 データ準備状況

#### Aurora PostgreSQL
- [ ] **必須**: テストユーザー100件登録完了
  ```sql
  SELECT COUNT(*) FROM users WHERE user_id LIKE 'U00%'; -- 結果: 100
  ```
- [ ] user_statisticsテーブル初期化
  ```sql  
  SELECT COUNT(*) FROM user_statistics WHERE user_id LIKE 'U00%'; -- 結果: 0
  ```

#### テストファイル
- [ ] CSV ファイル準備完了
  - ファイル名: `test-user-stats-20250807-100records.csv`  
  - レコード数: 100件（ヘッダー含む101行）
  - フォーマット: `ユーザーID,ログイン回数,投稿回数`

### 🚨 重要な既知課題

#### 事前対応必須項目
- [ ] **最重要**: Lambda環境変数の完全設定
  - 現状、コメントアウトされている環境変数を有効化
  - SAM template.yaml修正 → 再デプロイ必要
- [ ] **重要**: VPC設定の有効化
  - Aurora接続のため必須
  - 現在コメントアウト状態

#### バックアップ計画
- [ ] Step Functions手動実行コマンド準備済み
  - EventBridge自動起動が失敗した場合の代替手段

### ⏱️ テスト実行スケジュール

1. **Phase 1**: 事前準備修正（推定1-2時間）
   - Lambda環境変数設定・VPC有効化
   - SAM再デプロイ
   - 設定確認テスト

2. **Phase 2**: データ準備（推定30分）
   - Auroraテストユーザー登録
   - 初期状態確認

3. **Phase 3**: テスト実行（推定30分）
   - CSVファイルS3アップロード
   - Step Functions実行・監視
   - 基本動作確認

4. **Phase 4**: 結果検証（推定1時間）
   - データベース結果確認
   - ログ詳細分析
   - 性能測定

### 🎯 成功判定基準

#### 必須条件
- [ ] Step Functions: `SUCCEEDED`で完了
- [ ] Aurora: 100レコード全て`user_statistics`に反映
- [ ] DynamoDB: 全処理の監査ログ記録
- [ ] Lambda: エラーなく全イベントタイプ処理

#### 性能目標
- [ ] 総処理時間: 15分以内
- [ ] 並列処理: 最大5並列で実行
- [ ] データ整合性: 0件のデータ不整合

### 🚧 リスク評価

#### 高リスク項目
- **Aurora接続エラー**: VPC未設定による接続失敗
- **環境変数不備**: 外部リソース接続情報不足
- **IAM権限不足**: Terraform/SAM間のロール不整合

#### 対策準備
- [ ] 各種接続テストコマンド準備
- [ ] エラー時の調査手順確立
- [ ] 手動実行での代替手段確保

### 📊 監視・確認ポイント

#### リアルタイム監視
- [ ] AWS Console Step Functions実行画面
- [ ] CloudWatch Logs Lambda関数ログ
- [ ] Aurora接続状況

#### 事後確認項目
- [ ] 処理時間・スループット測定
- [ ] データ正確性検証
- [ ] エラー/警告ログ分析

---

## ⚡ 最優先対応事項

### 1. Lambda環境変数設定（必須）
```yaml
# template.yaml修正箇所
Environment:
  Variables:
    S3_BUCKET_NAME: "csv-processing-526636471122-dev"
    AURORA_ENDPOINT: "csv-parallel-processing-aurora-dev.cluster-cbuqsk2gi5o4.ap-northeast-1.rds.amazonaws.com"
    # その他コメントアウト項目を有効化
```

### 2. VPC設定有効化（必須）
```yaml
# template.yaml修正箇所  
VpcConfig:
  SecurityGroupIds:
    - "sg-06c634d551276a4ea"
  SubnetIds:
    - "subnet-08a0f6d12ec88f57b"
    - "subnet-0b5bc36627c1f6dbb"
```

### 3. Aurora事前データ登録（必須）
```sql
-- U00001からU00100までの100ユーザー登録
-- 詳細は準備手順書参照
```

---

**✅ 全チェック完了後にテスト実行開始**

**実行コマンド例**:
```bash
# S3アップロード
aws s3 cp test-user-stats-20250807-100records.csv \
  s3://csv-processing-526636471122-dev/incoming/

# 処理状況確認
aws stepfunctions list-executions \
  --state-machine-arn "arn:aws:states:ap-northeast-1:526636471122:stateMachine:csv-parallel-processing-csv-processing-dev"
```