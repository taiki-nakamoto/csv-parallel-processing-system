# インフラ詳細設計書

## 1. 概要

### 1.1 目的
CSVファイル並列処理システムにおけるAWSインフラストラクチャの詳細設計を定義する。IAMロール・ポリシー、CloudWatch監視、S3バケットポリシーの具体的な設定内容と実装方法を明確化する。

### 1.2 設計方針
- **最小権限の原則**: 必要最小限の権限のみ付与
- **セキュリティバイデザイン**: 設計段階からセキュリティを組み込み
- **運用効率**: 自動化と監視による運用負荷軽減
- **コスト最適化**: 適切なリソース設定とライフサイクル管理

### 1.3 対象リソース
- IAMロール・ポリシー（Step Functions、Lambda、S3、DynamoDB）
- CloudWatch監視（ログ、メトリクス、ダッシュボード、アラーム）
- S3バケットポリシー（アクセス制御、セキュリティ）
- VPCネットワーク設定
- KMS暗号化キー管理

## 2. IAMロール・ポリシー詳細設計

### 2.1 IAMロール構成

#### 2.1.1 ロール一覧
```yaml
IAMRoles:
  StepFunctions:
    - csv-stepfunctions-execution-role
    - csv-stepfunctions-distributed-map-role
    
  Lambda:
    - csv-lambda-processor-role
    
  S3:
    - S3-CrossAccount-Upload-Role
    - S3-Replication-Role
    
  DynamoDB:
    - DynamoDB-Backup-Role
    
  Monitoring:
    - CloudWatch-LogsDelivery-Role
    - X-Ray-Tracing-Role
```

### 2.2 Step Functions IAMロール設計

#### 2.2.1 csv-stepfunctions-execution-role
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "InvokeLambdaFunctions",
      "Effect": "Allow",
      "Action": [
        "lambda:InvokeFunction"
      ],
      "Resource": [
        "arn:aws:lambda:ap-northeast-1:ACCOUNT:function:csv-processor",
        "arn:aws:lambda:ap-northeast-1:ACCOUNT:function:csv-chunk-processor",
        "arn:aws:lambda:ap-northeast-1:ACCOUNT:function:csv-csv-processor",
        "arn:aws:lambda:ap-northeast-1:ACCOUNT:function:csv-csv-processor",
        "arn:aws:lambda:ap-northeast-1:ACCOUNT:function:csv-csv-processor"
      ]
    },
    {
      "Sid": "CloudWatchLogsAccess",
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents",
        "logs:DescribeLogGroups",
        "logs:DescribeLogStreams"
      ],
      "Resource": [
        "arn:aws:logs:ap-northeast-1:ACCOUNT:log-group:/aws/stepfunctions/*"
      ]
    },
    {
      "Sid": "DistributedMapAccess",
      "Effect": "Allow",
      "Action": [
        "states:DescribeExecution",
        "states:StartExecution",
        "states:StopExecution"
      ],
      "Resource": [
        "arn:aws:states:ap-northeast-1:ACCOUNT:stateMachine:csv-main-workflow",
        "arn:aws:states:ap-northeast-1:ACCOUNT:execution:csv-main-workflow:*"
      ]
    },
    {
      "Sid": "S3ResultWriterAccess",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:PutObjectAcl"
      ],
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/output/results/*"
      ]
    }
  ]
}
```

#### 2.2.2 信頼関係ポリシー
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "states.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

### 2.3 Lambda IAMロール設計

#### 2.3.1 csv-lambda-validator-role
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "BasicLambdaExecution",
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:ap-northeast-1:ACCOUNT:log-group:/aws/lambda/csv-processor:*"
    },
    {
      "Sid": "S3InputBucketAccess",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion"
      ],
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/input/incoming/*",
        "arn:aws:s3:::csv-processing-{account-id}/input/processing/*"
      ]
    },
    {
      "Sid": "S3InputBucketList",
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket"
      ],
      "Resource": "arn:aws:s3:::csv-processing-{account-id}",
      "Condition": {
        "StringLike": {
          "s3:prefix": [
            "incoming/*",
            "processing/*"
          ]
        }
      }
    },
    {
      "Sid": "DynamoDBLogAccess",
      "Effect": "Allow",
      "Action": [
        "dynamodb:PutItem"
      ],
      "Resource": "arn:aws:dynamodb:ap-northeast-1:ACCOUNT:table/csv-logs"
    },
    {
      "Sid": "VPCNetworkInterface",
      "Effect": "Allow",
      "Action": [
        "ec2:CreateNetworkInterface",
        "ec2:DescribeNetworkInterfaces",
        "ec2:DeleteNetworkInterface",
        "ec2:AttachNetworkInterface",
        "ec2:DetachNetworkInterface"
      ],
      "Resource": "*"
    }
  ]
}
```

#### 2.3.2 csv-lambda-chunk-processor-role
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "BasicLambdaExecution",
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:ap-northeast-1:ACCOUNT:log-group:/aws/lambda/csv-chunk-processor:*"
    },
    {
      "Sid": "AuroraDBAccess",
      "Effect": "Allow",
      "Action": [
        "rds-db:connect"
      ],
      "Resource": "arn:aws:rds-db:ap-northeast-1:ACCOUNT:dbuser:csv-cluster/lambda_user"
    },
    {
      "Sid": "SecretsManagerAccess",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": "arn:aws:secretsmanager:ap-northeast-1:ACCOUNT:secret:csv/aurora-credentials-*"
    },
    {
      "Sid": "DynamoDBLogAccess",
      "Effect": "Allow",
      "Action": [
        "dynamodb:PutItem"
      ],
      "Resource": "arn:aws:dynamodb:ap-northeast-1:ACCOUNT:table/csv-logs"
    },
    {
      "Sid": "VPCNetworkInterface",
      "Effect": "Allow",
      "Action": [
        "ec2:CreateNetworkInterface",
        "ec2:DescribeNetworkInterfaces",
        "ec2:DeleteNetworkInterface",
        "ec2:AttachNetworkInterface",
        "ec2:DetachNetworkInterface"
      ],
      "Resource": "*"
    }
  ]
}
```

#### 2.3.3 csv-lambda-csv-processor-role
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "BasicLambdaExecution",
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:ap-northeast-1:ACCOUNT:log-group:/aws/lambda/csv-processor:*"
    },
    {
      "Sid": "DynamoDBFullAccess",
      "Effect": "Allow",
      "Action": [
        "dynamodb:PutItem",
        "dynamodb:GetItem",
        "dynamodb:UpdateItem",
        "dynamodb:Query",
        "dynamodb:Scan"
      ],
      "Resource": "arn:aws:dynamodb:ap-northeast-1:ACCOUNT:table/csv-logs"
    },
    {
      "Sid": "DynamoDBIndexAccess",
      "Effect": "Allow",
      "Action": [
        "dynamodb:Query"
      ],
      "Resource": "arn:aws:dynamodb:ap-northeast-1:ACCOUNT:table/csv-logs/index/*"
    }
  ]
}
```

### 2.4 S3クロスアカウントアクセス設計

#### 2.4.1 S3-CrossAccount-Upload-Role（外部システム用）
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "UploadToIncomingFolder",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:PutObjectAcl"
      ],
      "Resource": "arn:aws:s3:::csv-processing-{account-id}/input/incoming/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-server-side-encryption": "AES256"
        },
        "StringLike": {
          "s3:x-amz-metadata-source-system": "external-system-*"
        },
        "IpAddress": {
          "aws:SourceIp": [
            "203.0.113.0/24",
            "198.51.100.0/24"
          ]
        }
      }
    },
    {
      "Sid": "ListBucketForValidation",
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket"
      ],
      "Resource": "arn:aws:s3:::csv-processing-{account-id}",
      "Condition": {
        "StringLike": {
          "s3:prefix": "incoming/*"
        }
      }
    }
  ]
}
```

#### 2.4.2 信頼関係ポリシー（外部アカウント）
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::EXTERNAL-ACCOUNT:root"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "csv-upload-external-id-12345"
        },
        "IpAddress": {
          "aws:SourceIp": [
            "203.0.113.0/24",
            "198.51.100.0/24"
          ]
        }
      }
    }
  ]
}
```

## 3. CloudWatch監視詳細設計

### 3.1 ログ設計

#### 3.1.1 ロググループ設計
```yaml
LogGroups:
  StepFunctions:
    - Name: "/aws/stepfunctions/csv-processing"
      RetentionDays: 30
      KMSKeyId: "alias/cloudwatch-logs"
      
  Lambda:
    - Name: "/aws/lambda/csv-processor"
      RetentionDays: 30
    - Name: "/aws/lambda/csv-chunk-processor"
      RetentionDays: 30
    - Name: "/aws/lambda/csv-processor"
      RetentionDays: 90
    - Name: "/aws/lambda/csv-processor"
      RetentionDays: 30
    - Name: "/aws/lambda/csv-processor"
      RetentionDays: 90
      
  VPC:
    - Name: "/aws/vpc/flowlogs"
      RetentionDays: 7
      
  Application:
    - Name: "/csv-processing/application"
      RetentionDays: 30
    - Name: "/csv-processing/audit"
      RetentionDays: 90
    - Name: "/csv-processing/security"
      RetentionDays: 365
```

#### 3.1.2 ログサブスクリプションフィルター
```json
{
  "SubscriptionFilters": [
    {
      "FilterName": "ErrorLogFilter",
      "LogGroupName": "/aws/lambda/csv-chunk-processor",
      "FilterPattern": "ERROR",
      "DestinationArn": "arn:aws:kinesis:ap-northeast-1:ACCOUNT:stream/csv-processing-error-stream"
    },
    {
      "FilterName": "SecurityLogFilter",
      "LogGroupName": "/csv-processing/security",
      "FilterPattern": "[timestamp, level=\"SECURITY\", ...]",
      "DestinationArn": "arn:aws:lambda:ap-northeast-1:ACCOUNT:function:security-alert-handler"
    }
  ]
}
```

### 3.2 メトリクス設計

#### 3.2.1 標準メトリクス監視項目
```yaml
StandardMetrics:
  StepFunctions:
    - ExecutionsStarted
    - ExecutionsSucceeded
    - ExecutionsFailed
    - ExecutionsAborted
    - ExecutionTime
    - ActivityScheduleTime
    - ActivityRunTime
    
  Lambda:
    - Invocations
    - Duration
    - Errors
    - Throttles
    - DeadLetterErrors
    - ConcurrentExecutions
    - ProvisionedConcurrencyUtilization
    
  Aurora:
    - DatabaseConnections
    - CPUUtilization
    - ReadLatency
    - WriteLatency
    - FreeStorageSpace
    - DatabaseConnectionsBorrowCount
    
  DynamoDB:
    - ConsumedReadCapacityUnits
    - ConsumedWriteCapacityUnits
    - ReadLatency
    - WriteLatency
    - ItemCount
    - TableSizeBytes
    
  S3:
    - NumberOfObjects
    - BucketSizeBytes
    - AllRequests
    - GetRequests
    - PutRequests
    - 4xxErrors
    - 5xxErrors
```

#### 3.2.2 カスタムメトリクス設計（個人開発のため不要）
個人開発のため、カスタムメトリクスは実装しません。標準メトリクスで十分な監視を行います。

### 3.3 ダッシュボード設計（個人開発のため不要）
個人開発のため、CloudWatchダッシュボードは作成しません。必要に応じてCloudWatchコンソールから標準メトリクスを確認します。

### 3.4 アラーム設計（個人開発のため不要）
個人開発のため、CloudWatchアラームは設定しません。必要に応じてCloudWatchコンソールでメトリクスを手動確認します。

## 4. S3バケットポリシー詳細設計

### 4.1 csv-processing-{account-id} バケットポリシー

#### 4.1.1 包括的バケットポリシー
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyInsecureConnections",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/*",
        "arn:aws:s3:::csv-processing-{account-id}"
      ],
      "Condition": {
        "Bool": {
          "aws:SecureTransport": "false"
        }
      }
    },
    {
      "Sid": "DenyUnencryptedObjectUploads",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::csv-processing-{account-id}/*",
      "Condition": {
        "StringNotEquals": {
          "s3:x-amz-server-side-encryption": "AES256"
        }
      }
    },
    {
      "Sid": "AllowExternalSystemUpload",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::EXTERNAL-ACCOUNT:role/CSVUploadRole"
      },
      "Action": [
        "s3:PutObject",
        "s3:PutObjectAcl"
      ],
      "Resource": "arn:aws:s3:::csv-processing-{account-id}/input/incoming/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-server-side-encryption": "AES256",
          "s3:x-amz-metadata-source-system": "external-system-production"
        },
        "StringLike": {
          "s3:x-amz-metadata-file-type": "user-log-*"
        },
        "IpAddress": {
          "aws:SourceIp": [
            "203.0.113.0/24",
            "198.51.100.0/24"
          ]
        },
        "DateGreaterThan": {
          "aws:CurrentTime": "2024-01-01T00:00:00Z"
        }
      }
    },
    {
      "Sid": "AllowStepFunctionsAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::ACCOUNT:role/csv-stepfunctions-execution-role"
      },
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/*",
        "arn:aws:s3:::csv-processing-{account-id}"
      ]
    },
    {
      "Sid": "AllowLambdaAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": [
          "arn:aws:iam::ACCOUNT:role/csv-lambda-validator-role",
          "arn:aws:iam::ACCOUNT:role/csv-lambda-chunk-processor-role"
        ]
      },
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion"
      ],
      "Resource": "arn:aws:s3:::csv-input-{account-id}/*"
    },
    {
      "Sid": "AllowFileMovement",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::ACCOUNT:role/csv-lambda-validator-role"
      },
      "Action": [
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/input/processing/*",
        "arn:aws:s3:::csv-processing-{account-id}/input/processed/*",
        "arn:aws:s3:::csv-processing-{account-id}/input/failed/*"
      ]
    },
    {
      "Sid": "DenyDirectAccessToSensitiveFolders",
      "Effect": "Deny",
      "Principal": "*",
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/input/failed/*",
        "arn:aws:s3:::csv-processing-{account-id}/.aws/*"
      ],
      "Condition": {
        "StringNotEquals": {
          "aws:PrincipalServiceName": [
            "lambda.amazonaws.com",
            "states.amazonaws.com"
          ]
        }
      }
    }
  ]
}
```

### 4.2 csv-processing-{account-id} バケットポリシー（出力用権限）

#### 4.2.1 出力バケットポリシー
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyInsecureConnections",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/*",
        "arn:aws:s3:::csv-processing-{account-id}"
      ],
      "Condition": {
        "Bool": {
          "aws:SecureTransport": "false"
        }
      }
    },
    {
      "Sid": "AllowLambdaResultWrite",
      "Effect": "Allow",
      "Principal": {
        "AWS": [
          "arn:aws:iam::ACCOUNT:role/csv-lambda-csv-processor-role",
          "arn:aws:iam::ACCOUNT:role/csv-stepfunctions-execution-role"
        ]
      },
      "Action": [
        "s3:PutObject",
        "s3:PutObjectAcl"
      ],
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/output/results/*",
        "arn:aws:s3:::csv-output-{account-id}/reports/*"
      ],
      "Condition": {
        "StringEquals": {
          "s3:x-amz-server-side-encryption": "AES256"
        }
      }
    },
    {
      "Sid": "AllowInternalRead",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::ACCOUNT:root"
      },
      "Action": [
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/*",
        "arn:aws:s3:::csv-processing-{account-id}"
      ]
    },
    {
      "Sid": "DenyPublicAccess",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/*",
        "arn:aws:s3:::csv-processing-{account-id}"
      ],
      "Condition": {
        "StringNotEquals": {
          "aws:PrincipalAccount": "ACCOUNT"
        }
      }
    }
  ]
}
```

## 5. VPCネットワーク詳細設計

### 5.1 VPC設定
```yaml
VPC:
  CIDR: "10.0.1.0/24"
  EnableDnsHostnames: true
  EnableDnsSupport: true
  InstanceTenancy: "default"
  
  Tags:
    Name: "csv-vpc"
    Project: "CSV-Parallel-Processing"
    Environment: "Production"
```

### 5.2 サブネット設計
```yaml
Subnets:
  PrivateSubnet1:
    CIDR: "10.0.1.0/27"  # 10.0.1.0 - 10.0.1.31
    AvailabilityZone: "ap-northeast-1a"
    MapPublicIpOnLaunch: false
    Purpose: "Lambda Functions, Aurora Primary"
    
  PrivateSubnet2:
    CIDR: "10.0.1.32/27"  # 10.0.1.32 - 10.0.1.63
    AvailabilityZone: "ap-northeast-1c"
    MapPublicIpOnLaunch: false
    Purpose: "Aurora Replica, DynamoDB VPC Endpoint"
    
  PrivateSubnet3:
    CIDR: "10.0.1.64/27"  # 10.0.1.64 - 10.0.1.95
    AvailabilityZone: "ap-northeast-1d"
    MapPublicIpOnLaunch: false
    Purpose: "Reserved for future expansion"
```

### 5.3 セキュリティグループ設計

#### 5.3.1 Lambda関数用セキュリティグループ
```json
{
  "GroupName": "csv-sg-lambda",
  "Description": "Security group for CSV processing Lambda functions",
  "VpcId": "csv-vpc",
  "SecurityGroupRules": [
    {
      "IpProtocol": "tcp",
      "FromPort": 5432,
      "ToPort": 5432,
      "ReferencedGroupId": "csv-sg-aurora",
      "Description": "Aurora PostgreSQL access"
    },
    {
      "IpProtocol": "tcp",
      "FromPort": 443,
      "ToPort": 443,
      "CidrIp": "0.0.0.0/0",
      "Description": "HTTPS outbound for AWS API calls"
    }
  ]
}
```

#### 5.3.2 Aurora用セキュリティグループ
```json
{
  "GroupName": "csv-sg-aurora",
  "Description": "Security group for Aurora PostgreSQL cluster",
  "VpcId": "csv-vpc",
  "SecurityGroupRules": [
    {
      "IpProtocol": "tcp",
      "FromPort": 5432,
      "ToPort": 5432,
      "SourceSecurityGroupId": "csv-sg-lambda",
      "Description": "Lambda function access"
    }
  ]
}
```

### 5.4 VPCエンドポイント設計
```yaml
VPCEndpoints:
  S3Gateway:
    Type: "Gateway"
    ServiceName: "com.amazonaws.ap-northeast-1.s3"
    RouteTableIds: 
      - "rtb-private-subnet-1"
      - "rtb-private-subnet-2"
      
  DynamoDBGateway:
    Type: "Gateway"
    ServiceName: "com.amazonaws.ap-northeast-1.dynamodb"
    RouteTableIds:
      - "rtb-private-subnet-1"
      - "rtb-private-subnet-2"
      
  LambdaInterface:
    Type: "Interface"
    ServiceName: "com.amazonaws.ap-northeast-1.lambda"
    SubnetIds:
      - "subnet-private-1"
      - "subnet-private-2"
    SecurityGroupIds:
      - "sg-vpc-endpoint"
      
  StepFunctionsInterface:
    Type: "Interface"
    ServiceName: "com.amazonaws.ap-northeast-1.states"
    SubnetIds:
      - "subnet-private-1"
      - "subnet-private-2"
    SecurityGroupIds:
      - "sg-vpc-endpoint"
```

## 6. KMS暗号化キー管理

### 6.1 キー設計
```yaml
KMSKeys:
  CloudWatchLogs:
    Alias: "alias/cloudwatch-logs"
    Description: "CloudWatch Logs encryption key"
    KeyUsage: "ENCRYPT_DECRYPT"
    KeySpec: "SYMMETRIC_DEFAULT"
    
  S3Buckets:
    Alias: "alias/s3-csv-processing"
    Description: "S3 bucket encryption key"
    KeyUsage: "ENCRYPT_DECRYPT"
    KeySpec: "SYMMETRIC_DEFAULT"
    
  DynamoDB:
    Alias: "alias/dynamodb-csv-processing"
    Description: "DynamoDB table encryption key"
    KeyUsage: "ENCRYPT_DECRYPT"
    KeySpec: "SYMMETRIC_DEFAULT"
    
  SecretsManager:
    Alias: "alias/secrets-csv-processing"
    Description: "Secrets Manager encryption key"
    KeyUsage: "ENCRYPT_DECRYPT"
    KeySpec: "SYMMETRIC_DEFAULT"
```

### 6.2 キーポリシー例（CloudWatch Logs用）
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "EnableIAMUserPermissions",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::ACCOUNT:root"
      },
      "Action": "kms:*",
      "Resource": "*"
    },
    {
      "Sid": "AllowCloudWatchLogsEncryption",
      "Effect": "Allow",
      "Principal": {
        "Service": "logs.ap-northeast-1.amazonaws.com"
      },
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:ReEncrypt*",
        "kms:GenerateDataKey*",
        "kms:DescribeKey"
      ],
      "Resource": "*",
      "Condition": {
        "ArnEquals": {
          "kms:EncryptionContext:aws:logs:arn": "arn:aws:logs:ap-northeast-1:ACCOUNT:log-group:/aws/lambda/*"
        }
      }
    },
    {
      "Sid": "AllowLambdaLogsAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": [
          "arn:aws:iam::ACCOUNT:role/csv-lambda-validator-role",
          "arn:aws:iam::ACCOUNT:role/csv-lambda-chunk-processor-role",
          "arn:aws:iam::ACCOUNT:role/csv-lambda-csv-processor-role"
        ]
      },
      "Action": [
        "kms:Decrypt",
        "kms:DescribeKey"
      ],
      "Resource": "*"
    }
  ]
}
```

## 7. Secrets Manager設計

### 7.1 シークレット設計
```yaml
Secrets:
  AuroraCredentials:
    Name: "csv/aurora-credentials"
    Description: "Aurora PostgreSQL master credentials"
    SecretString:
      username: "csv_admin"
      password: "AUTO_GENERATED"
      engine: "postgres"
      host: "csv-cluster.cluster-xxxxx.ap-northeast-1.rds.amazonaws.com"
      port: 5432
      dbname: "csv_processing"
    KmsKeyId: "alias/secrets-csv-processing"
    
  ExternalSystemApiKey:
    Name: "csv/external-api-key"
    Description: "External system API key for authentication"
    SecretString:
      api_key: "AUTO_GENERATED"
      endpoint: "https://external-system.example.com/api"
    KmsKeyId: "alias/secrets-csv-processing"
```

### 7.2 リソースポリシー（Aurora認証情報用）
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowLambdaAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": [
          "arn:aws:iam::ACCOUNT:role/csv-lambda-chunk-processor-role",
          "arn:aws:iam::ACCOUNT:role/csv-lambda-csv-processor-role"
        ]
      },
      "Action": "secretsmanager:GetSecretValue",
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "secretsmanager:ResourceTag/Project": "CSV-Parallel-Processing"
        }
      }
    }
  ]
}
```

## 8. リソースタグ戦略

### 8.1 タグ標準
```yaml
StandardTags:
  Required:
    Project: "CSV-Parallel-Processing"
    Environment: "Production" | "Development" | "Staging"
    Owner: "data-platform-team"
    CostCenter: "IT-Operations"
    
  Optional:
    Component: "lambda" | "stepfunctions" | "s3" | "dynamodb" | "aurora"
    BackupRequired: "true" | "false"
    DataClassification: "Internal" | "Confidential" | "Public"
    Compliance: "SOX" | "GDPR" | "None"
```

### 8.2 自動タグ付けポリシー
```json
{
  "TagPolicies": [
    {
      "PolicyName": "CSV-Processing-Required-Tags",
      "RequiredTags": {
        "Project": "CSV-Parallel-Processing",
        "Environment": ["Production", "Development", "Staging"],
        "Owner": "data-platform-team",
        "CostCenter": "IT-Operations"
      },
      "EnforceOnCreate": true,
      "ResourceTypes": [
        "lambda:function",
        "states:statemachine",
        "s3:bucket",
        "dynamodb:table",
        "rds:cluster"
      ]
    }
  ]
}
```

## 9. 運用設計

### 9.1 デプロイメント戦略
```yaml
DeploymentStrategy:
  Infrastructure:
    Tool: "AWS CDK"
    StackOrder:
      1: "Network (VPC, Subnets, Security Groups)"
      2: "IAM (Roles, Policies)"
      3: "KMS (Encryption Keys)"
      4: "Storage (S3, DynamoDB)"
      5: "Database (Aurora)"
      6: "Compute (Lambda, Step Functions)"
      7: "Monitoring (CloudWatch)"
      
  RollbackStrategy:
    AutoRollback: true
    HealthCheck: "Lambda function test invocation"
    Timeout: "600 seconds"
```

### 9.2 バックアップ・災害復旧
```yaml
BackupStrategy:
  DynamoDB:
    PointInTimeRecovery: true
    BackupRetention: "35 days"
    
  Aurora:
    BackupRetention: "7 days"
    PreferredBackupWindow: "03:00-04:00"
    PreferredMaintenanceWindow: "sun:04:00-sun:05:00"
    
  S3:
    Versioning: true
    CrossRegionReplication: false  # 個人開発のため無効
    
  Secrets:
    AutomaticRotation: true
    RotationInterval: "30 days"
```

## 10. セキュリティ設計

### 10.1 セキュリティ監査
```yaml
SecurityAudit:
  CloudTrail:
    EnableLogging: true
    IncludeGlobalServiceEvents: true
    IsMultiRegionTrail: false
    S3BucketName: "csv-processing-ACCOUNT"
    S3KeyPrefix: "cloudtrail-logs/"
    
  GuardDuty:
    Enabled: false  # 個人開発のため無効
    
  SecurityHub:
    Enabled: false  # 個人開発のため無効
    
  ConfigRules:
    Enabled: false  # 個人開発のため無効
```

### 10.2 アクセス制御マトリクス
```yaml
AccessMatrix:
  Roles:
    Developer:
      Permissions:
        - "Read all resources"
        - "Write Lambda code"
        - "Deploy via CDK"
      Resources: ["lambda:*", "states:*"]
      
    DataAnalyst:
      Permissions:
        - "Read S3 output buckets"
        - "Query DynamoDB logs"
      Resources: ["s3:csv-output-*", "dynamodb:csv-logs"]
      
    SecurityAuditor:
      Permissions:
        - "Read CloudTrail logs"
        - "Read IAM policies"
      Resources: ["s3:csv-logs-*", "iam:*"]
```

この詳細設計により、セキュアで効率的なインフラストラクチャ運用を実現し、CSVファイル並列処理システムの安定稼働を支えます。