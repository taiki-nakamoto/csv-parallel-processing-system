# 監視・ログ詳細設計書

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| ドキュメント名 | 監視・ログ詳細設計書 |
| バージョン | 1.0 |
| 作成日 | 2025-08-04 |
| 作成者 | システム設計チーム |
| 更新日 | 2025-08-04 |
| 承認者 | - |

## 2. 概要

### 2.1 目的
CSVファイル並列処理システムにおける包括的な監視・ログ基盤の詳細実装仕様を定義する。統合Lambda関数（csv-processor）を中心とした監視アーキテクチャ、具体的なメトリクス設定、アラート条件、ダッシュボード設計を記載する。

### 2.2 設計方針
- **統合監視**: 統合Lambda関数のイベント駆動型監視
- **予兆検知**: メトリクス分析による障害予防
- **運用自動化**: CloudWatch Alarms連携による自動対応
- **コスト最適化**: ログ保存期間とストレージクラス最適化

### 2.3 適用範囲
- CloudWatch Logs設定詳細
- CloudWatch Metrics定義
- CloudWatch Alarms設定
- CloudWatch Dashboards設計
- X-Ray分散トレーシング設定
- SNS通知設定

## 3. 監視アーキテクチャ詳細設計

### 3.1 統合監視構成

```mermaid
graph TB
    subgraph "イベント駆動層"
        SF[Step Functions] --> CWL[CloudWatch Logs]
        LP[csv-processor] --> CWL
        EB[EventBridge] --> CWL
        S3[S3 Bucket] --> CWL
        AU[Aurora] --> CWL
        DDB[DynamoDB] --> CWL
    end
    
    subgraph "メトリクス収集層"
        CWL --> CWM[CloudWatch Metrics]
        LP --> XR[X-Ray Traces]
        LP --> CWCM[Custom Metrics]
        XR --> CWM
        CWCM --> CWM
    end
    
    subgraph "分析・可視化層"
        CWM --> CWD[CloudWatch Dashboard]
        CWM --> CWA[CloudWatch Alarms]
        CWL --> CWI[CloudWatch Insights]
    end
    
    subgraph "通知・対応層"
        CWA --> SNS[SNS Topic]
        SNS --> SLACK[Slack Webhook]
        SNS --> EMAIL[Email Alert]
        SNS --> PD[PagerDuty]
    end
    
    subgraph "長期保存・分析層"
        CWL --> S3A[S3 Archive]
        S3A --> ATHENA[Athena Query]
        S3A --> GLUE[Glue Catalog]
    end
```

### 3.2 統合Lambda関数監視設計

#### 3.2.1 イベント種別監視
統合Lambda関数（csv-processor）は複数の機能を提供するため、eventTypeベースの監視を実装。

```json
{
  "eventType": "CSV_VALIDATION",
  "metrics": {
    "duration": 150.5,
    "memory_used": 128,
    "billing_duration": 200,
    "validation_result": "SUCCESS"
  },
  "custom_metrics": [
    {
      "MetricName": "CSV_ValidationDuration",
      "Value": 150.5,
      "Unit": "Milliseconds",
      "Dimensions": [
        {"Name": "EventType", "Value": "CSV_VALIDATION"},
        {"Name": "FunctionName", "Value": "csv-processor"}
      ]
    }
  ]
}
```

## 4. CloudWatch Logs詳細設定

### 4.1 ログ グループ設定

#### 4.1.1 統合Lambda関数ログ設定
```yaml
LogGroups:
  LambdaProcessor:
    Name: "/aws/lambda/csv-processor"
    RetentionInDays: 90
    KmsKeyId: "alias/cloudwatch-logs"
    SubscriptionFilters:
      - FilterName: "csv-processor-error-filter"
        FilterPattern: "{ $.level = \"ERROR\" }"
        DestinationArn: "arn:aws:lambda:region:account:function:log-processor"
      - FilterName: "csv-processor-performance-filter"
        FilterPattern: "{ $.event_type = \"PERFORMANCE_METRICS\" }"
        DestinationArn: "arn:aws:firehose:region:account:deliverystream/performance-metrics"
```

#### 4.1.2 Step Functions ログ設定
```yaml
  StepFunctionsLogs:
    Name: "/aws/stepfunctions/csv-processing"
    RetentionInDays: 30
    KmsKeyId: "alias/cloudwatch-logs"
    LoggingConfiguration:
      Level: "ALL" 
      IncludeExecutionData: true
      Destinations:
        - CloudWatchLogsLogGroup:
            LogGroupArn: "arn:aws:logs:region:account:log-group:/aws/stepfunctions/csv-processing"
```

#### 4.1.3 アプリケーションログ設定
```yaml
  ApplicationLogs:
    Name: "/csv-processing/application"
    RetentionInDays: 30
    SubscriptionFilters:
      - FilterName: "business-error-filter"
        FilterPattern: "{ $.error_type = \"BUSINESS_ERROR\" }"
        DestinationArn: "arn:aws:sns:region:account:business-error-alerts"
```

### 4.2 構造化ログ設計

#### 4.2.1 統合Lambda関数ログ構造
```typescript
// TypeScript ログ構造定義
interface ProcessorLogEntry {
  timestamp: string;
  level: "DEBUG" | "INFO" | "WARN" | "ERROR" | "FATAL";
  service: "csv-processor";
  function_name: "csv-processor";
  request_id: string;
  execution_id?: string;
  event_type: "CSV_VALIDATION" | "CSV_CHUNK_PROCESSING" | "AUDIT_LOGGING" | "RESULT_AGGREGATION" | "ERROR_HANDLING";
  details: {
    input_size?: number;
    processing_time?: number;
    records_processed?: number;
    error_count?: number;
    memory_used?: number;
    billing_duration?: number;
  };
  correlation_id?: string;
  user_id?: string;
  trace_id?: string;
  span_id?: string;
}
```

#### 4.2.2 ログ出力実装例
```typescript
// services/logging-service.ts
export class StructuredLogger {
  constructor(private service: string) {}

  info(eventType: string, details: any, correlationId?: string): void {
    const logEntry: ProcessorLogEntry = {
      timestamp: new Date().toISOString(),
      level: "INFO",
      service: "csv-processor",
      function_name: "csv-processor",
      request_id: context.awsRequestId,
      execution_id: details.executionId,
      event_type: eventType,
      details,
      correlation_id: correlationId,
      trace_id: process.env._X_AMZN_TRACE_ID
    };
    
    console.log(JSON.stringify(logEntry));
  }

  error(eventType: string, error: Error, details: any): void {
    const logEntry: ProcessorLogEntry = {
      timestamp: new Date().toISOString(),
      level: "ERROR",
      service: "csv-processor",
      function_name: "csv-processor",
      request_id: context.awsRequestId,
      event_type: eventType,
      details: {
        ...details,
        error_message: error.message,
        error_stack: error.stack
      }
    };
    
    console.error(JSON.stringify(logEntry));
  }
}
```

## 5. CloudWatch Metrics詳細設計

### 5.1 標準メトリクス監視

#### 5.1.1 Lambda関数メトリクス
```yaml
LambdaMetrics:
  Duration:
    MetricName: "Duration"
    Namespace: "AWS/Lambda"
    Dimensions:
      - Name: "FunctionName"
        Value: "csv-processor"
    Thresholds:
      Warning: 30000  # 30秒
      Critical: 45000  # 45秒
      
  Errors:
    MetricName: "Errors"
    Namespace: "AWS/Lambda"
    Dimensions:
      - Name: "FunctionName"
        Value: "csv-processor"
    Thresholds:
      Warning: 1
      Critical: 5
      
  Throttles:
    MetricName: "Throttles"
    Namespace: "AWS/Lambda"
    Dimensions:
      - Name: "FunctionName"
        Value: "csv-processor"
    Thresholds:
      Warning: 1
      Critical: 3
      
  ConcurrentExecutions:
    MetricName: "ConcurrentExecutions"
    Namespace: "AWS/Lambda"
    Dimensions:
      - Name: "FunctionName"
        Value: "csv-processor"
    Thresholds:
      Warning: 4
      Critical: 5
```

#### 5.1.2 Step Functions メトリクス
```yaml
StepFunctionsMetrics:
  ExecutionsFailed:
    MetricName: "ExecutionsFailed"
    Namespace: "AWS/States"
    Dimensions:
      - Name: "StateMachineArn"
        Value: "arn:aws:states:region:account:stateMachine:csv-processing-workflow"
    Thresholds:
      Warning: 1
      Critical: 3
      
  ExecutionTime:
    MetricName: "ExecutionTime"
    Namespace: "AWS/States"
    Dimensions:
      - Name: "StateMachineArn"
        Value: "arn:aws:states:region:account:stateMachine:csv-processing-workflow"
    Thresholds:
      Warning: 300000  # 5分
      Critical: 600000  # 10分
```

### 5.2 カスタムメトリクス設計

#### 5.2.1 ビジネスメトリクス
```typescript
// services/metrics-service.ts
export class CustomMetricsService {
  private cloudWatch: CloudWatch;

  constructor() {
    this.cloudWatch = new CloudWatch({ region: process.env.AWS_REGION });
  }

  async putMetric(metricName: string, value: number, unit: string, dimensions: Dimension[]): Promise<void> {
    const params: PutMetricDataRequest = {
      Namespace: 'CSV-Processing/Business',
      MetricData: [{
        MetricName: metricName,
        Value: value,
        Unit: unit,
        Dimensions: dimensions,
        Timestamp: new Date()
      }]
    };
    
    await this.cloudWatch.putMetricData(params).promise();
  }

  // CSV検証メトリクス
  async recordValidationMetrics(eventType: string, duration: number, recordCount: number, errorCount: number): Promise<void> {
    const dimensions = [
      { Name: 'EventType', Value: eventType },
      { Name: 'FunctionName', Value: 'csv-processor' }
    ];

    await Promise.all([
      this.putMetric('ValidationDuration', duration, 'Milliseconds', dimensions),
      this.putMetric('RecordsProcessed', recordCount, 'Count', dimensions),
      this.putMetric('ValidationErrors', errorCount, 'Count', dimensions),
      this.putMetric('ValidationSuccessRate', ((recordCount - errorCount) / recordCount) * 100, 'Percent', dimensions)
    ]);
  }

  // チャンク処理メトリクス
  async recordProcessingMetrics(eventType: string, duration: number, chunkSize: number, throughput: number): Promise<void> {
    const dimensions = [
      { Name: 'EventType', Value: eventType },
      { Name: 'FunctionName', Value: 'csv-processor' }
    ];

    await Promise.all([
      this.putMetric('ProcessingDuration', duration, 'Milliseconds', dimensions),
      this.putMetric('ChunkSize', chunkSize, 'Count', dimensions),
      this.putMetric('ProcessingThroughput', throughput, 'Count/Second', dimensions)
    ]);
  }
}
```

#### 5.2.2 メトリクス定義一覧
```yaml
CustomMetrics:
  BusinessMetrics:
    Namespace: "CSV-Processing/Business"
    Metrics:
      - Name: "ValidationDuration"
        Unit: "Milliseconds"
        Description: "CSV検証処理時間"
        
      - Name: "RecordsProcessed" 
        Unit: "Count"
        Description: "処理したレコード数"
        
      - Name: "ValidationErrors"
        Unit: "Count"
        Description: "検証エラー数"
        
      - Name: "ValidationSuccessRate"
        Unit: "Percent"
        Description: "検証成功率"
        
      - Name: "ProcessingThroughput"
        Unit: "Count/Second"
        Description: "処理スループット"
        
      - Name: "ChunkProcessingTime"
        Unit: "Milliseconds"
        Description: "チャンク処理時間"
        
      - Name: "AuditLogLatency"
        Unit: "Milliseconds"
        Description: "監査ログ記録遅延"
        
      - Name: "ResultAggregationTime"
        Unit: "Milliseconds"
        Description: "結果集約時間"

  SystemMetrics:
    Namespace: "CSV-Processing/System"
    Metrics:
      - Name: "MemoryUtilization"
        Unit: "Percent"
        Description: "メモリ使用率"
        
      - Name: "DatabaseConnections"
        Unit: "Count"
        Description: "データベース接続数"
        
      - Name: "S3OperationLatency"
        Unit: "Milliseconds"
        Description: "S3操作遅延"
```

## 6. CloudWatch Alarms詳細設計

### 6.1 アラーム設定

#### 6.1.1 統合Lambda関数アラーム
```yaml
LambdaAlarms:
  # エラー率アラーム
  ErrorRateAlarm:
    Name: "csv-processor-error-rate-high"
    Description: "Lambda関数エラー率が閾値を超過"
    MetricName: "Errors"
    Namespace: "AWS/Lambda"
    Statistic: "Sum"
    Dimensions:
      - Name: "FunctionName"
        Value: "csv-processor"
    Period: 300  # 5分
    EvaluationPeriods: 2
    Threshold: 5
    ComparisonOperator: "GreaterThanThreshold"
    TreatMissingData: "notBreaching"
    AlarmActions:
      - "arn:aws:sns:region:account:csv-processing-critical-alerts"
    OKActions:
      - "arn:aws:sns:region:account:csv-processing-ok-alerts"

  # 実行時間アラーム  
  DurationAlarm:
    Name: "csv-processor-duration-high"
    Description: "Lambda関数実行時間が閾値を超過"
    MetricName: "Duration"
    Namespace: "AWS/Lambda"
    Statistic: "Average"
    Dimensions:
      - Name: "FunctionName"
        Value: "csv-processor"
    Period: 300
    EvaluationPeriods: 2
    Threshold: 30000  # 30秒
    ComparisonOperator: "GreaterThanThreshold"
    AlarmActions:
      - "arn:aws:sns:region:account:csv-processing-warning-alerts"

  # 同時実行数アラーム
  ConcurrencyAlarm:
    Name: "csv-processor-concurrency-high"
    Description: "Lambda関数同時実行数が閾値を超過"
    MetricName: "ConcurrentExecutions"
    Namespace: "AWS/Lambda"
    Statistic: "Maximum"
    Dimensions:
      - Name: "FunctionName"
        Value: "csv-processor"
    Period: 60
    EvaluationPeriods: 3
    Threshold: 4
    ComparisonOperator: "GreaterThanThreshold"
    AlarmActions:
      - "arn:aws:sns:region:account:csv-processing-warning-alerts"

  # スロットリングアラーム
  ThrottleAlarm:
    Name: "csv-processor-throttles-detected"
    Description: "Lambda関数スロットリング検出"
    MetricName: "Throttles"
    Namespace: "AWS/Lambda"
    Statistic: "Sum"
    Dimensions:
      - Name: "FunctionName"
        Value: "csv-processor"
    Period: 300
    EvaluationPeriods: 1
    Threshold: 1
    ComparisonOperator: "GreaterThanOrEqualToThreshold"
    AlarmActions:
      - "arn:aws:sns:region:account:csv-processing-critical-alerts"
```

#### 6.1.2 ビジネスメトリクスアラーム
```yaml
BusinessAlarms:
  # 検証成功率アラーム
  ValidationSuccessRateAlarm:
    Name: "csv-validation-success-rate-low"
    Description: "CSV検証成功率が閾値を下回る"
    MetricName: "ValidationSuccessRate"
    Namespace: "CSV-Processing/Business"
    Statistic: "Average"
    Dimensions:
      - Name: "EventType"
        Value: "CSV_VALIDATION"
    Period: 300
    EvaluationPeriods: 2
    Threshold: 95.0  # 95%
    ComparisonOperator: "LessThanThreshold"
    AlarmActions:
      - "arn:aws:sns:region:account:csv-processing-business-alerts"

  # 処理スループットアラーム
  ThroughputAlarm:
    Name: "csv-processing-throughput-low"
    Description: "処理スループットが閾値を下回る"
    MetricName: "ProcessingThroughput"
    Namespace: "CSV-Processing/Business"
    Statistic: "Average"
    Dimensions:
      - Name: "EventType"
        Value: "CSV_CHUNK_PROCESSING"
    Period: 600
    EvaluationPeriods: 2
    Threshold: 50  # 50 records/second
    ComparisonOperator: "LessThanThreshold"
    AlarmActions:
      - "arn:aws:sns:region:account:csv-processing-performance-alerts"
```

### 6.2 複合アラーム設計

#### 6.2.1 システム健全性複合アラーム
```yaml
CompositeAlarms:
  SystemHealthAlarm:
    Name: "csv-processing-system-health"
    Description: "CSV処理システム全体の健全性監視"
    AlarmRule: |
      (ALARM("csv-processor-error-rate-high") OR 
       ALARM("csv-processor-duration-high") OR 
       ALARM("csv-stepfunctions-execution-failed"))
    AlarmActions:
      - "arn:aws:sns:region:account:csv-processing-system-alerts"
    ActionsEnabled: true

  BusinessHealthAlarm:
    Name: "csv-processing-business-health"
    Description: "CSV処理ビジネス指標の健全性監視"
    AlarmRule: |
      (ALARM("csv-validation-success-rate-low") OR
       ALARM("csv-processing-throughput-low"))
    AlarmActions:
      - "arn:aws:sns:region:account:csv-processing-business-alerts"
```

## 7. CloudWatch Dashboard設計

### 7.1 ダッシュボード構成

#### 7.1.1 統合監視ダッシュボード
```json
{
  "widgets": [
    {
      "type": "metric",
      "width": 12,
      "height": 6,
      "properties": {
        "metrics": [
          [ "AWS/Lambda", "Duration", "FunctionName", "csv-processor" ],
          [ ".", "Errors", ".", "." ],
          [ ".", "Invocations", ".", "." ],
          [ ".", "ConcurrentExecutions", ".", "." ]
        ],
        "period": 300,
        "stat": "Average",
        "region": "ap-northeast-1",
        "title": "Lambda関数基本メトリクス",
        "yAxis": {
          "left": {
            "min": 0
          }
        }
      }
    },
    {
      "type": "metric",
      "width": 12,
      "height": 6,
      "properties": {
        "metrics": [
          [ "CSV-Processing/Business", "ValidationSuccessRate", "EventType", "CSV_VALIDATION" ],
          [ ".", "ProcessingThroughput", ".", "CSV_CHUNK_PROCESSING" ],
          [ ".", "RecordsProcessed", ".", "CSV_VALIDATION" ]
        ],
        "period": 300,
        "stat": "Average",
        "region": "ap-northeast-1",
        "title": "ビジネスメトリクス",
        "yAxis": {
          "left": {
            "min": 0
          }
        }
      }
    },
    {
      "type": "log",
      "width": 24,
      "height": 6,
      "properties": {
        "query": "SOURCE '/aws/lambda/csv-processor'\n| fields @timestamp, level, event_type, details.records_processed\n| filter level = \"ERROR\"\n| sort @timestamp desc\n| limit 20",
        "region": "ap-northeast-1",
        "title": "最新エラーログ",
        "view": "table"
      }
    }
  ]
}
```

#### 7.1.2 イベント種別別ダッシュボード
```json
{
  "widgets": [
    {
      "type": "metric",
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [ "CSV-Processing/Business", "ValidationDuration", "EventType", "CSV_VALIDATION" ]
        ],
        "period": 300,
        "stat": "Average",
        "region": "ap-northeast-1",
        "title": "CSV検証処理時間"
      }
    },
    {
      "type": "metric", 
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [ "CSV-Processing/Business", "ChunkProcessingTime", "EventType", "CSV_CHUNK_PROCESSING" ]
        ],
        "period": 300,
        "stat": "Average",
        "region": "ap-northeast-1",
        "title": "チャンク処理時間"
      }
    },
    {
      "type": "metric",
      "width": 8, 
      "height": 6,
      "properties": {
        "metrics": [
          [ "CSV-Processing/Business", "ResultAggregationTime", "EventType", "RESULT_AGGREGATION" ]
        ],
        "period": 300,
        "stat": "Average",
        "region": "ap-northeast-1",
        "title": "結果集約時間"
      }
    }
  ]
}
```

## 8. X-Ray分散トレーシング設計

### 8.1 トレーシング設定

#### 8.1.1 Lambda関数トレーシング設定
```yaml
XRayConfiguration:
  TracingConfig:
    Mode: "Active"
  Environment:
    Variables:
      _X_AMZN_TRACE_ID: "auto"
      AWS_XRAY_TRACING_NAME: "csv-processor"
      AWS_XRAY_CONTEXT_MISSING: "LOG_ERROR"
```

#### 8.2.2 カスタムセグメント実装
```typescript
// services/tracing-service.ts
import AWSXRay from 'aws-xray-sdk-core';

export class TracingService {
  static createSubsegment(name: string, callback: (subsegment: any) => Promise<any>): Promise<any> {
    return new Promise((resolve, reject) => {
      AWSXRay.captureAsyncFunc(name, async (subsegment) => {
        try {
          subsegment.addAnnotation('service', 'csv-processor');
          const result = await callback(subsegment);
          subsegment.close();
          resolve(result);
        } catch (error) {
          subsegment.addError(error);
          subsegment.close(error);
          reject(error);
        }
      });
    });
  }

  static async traceValidation(eventType: string, validationFn: () => Promise<any>): Promise<any> {
    return this.createSubsegment(`CSV-Validation-${eventType}`, async (subsegment) => {
      subsegment.addAnnotation('event_type', eventType);
      subsegment.addAnnotation('operation', 'validation');
      
      const startTime = Date.now();
      const result = await validationFn();
      const duration = Date.now() - startTime;
      
      subsegment.addMetadata('validation_duration', duration);
      subsegment.addMetadata('records_validated', result.recordCount);
      
      return result;
    });
  }
}
```

## 9. SNS通知設定

### 9.1 通知トピック設計

#### 9.1.1 アラート分類別トピック
```yaml
SNSTopics:
  CriticalAlerts:
    Name: "csv-processing-critical-alerts"
    Description: "Critical alerts requiring immediate attention"
    Subscriptions:
      - Protocol: "email"
        Endpoint: "devops-critical@company.com"
      - Protocol: "https"
        Endpoint: "https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX"
      - Protocol: "https"
        Endpoint: "https://events.pagerduty.com/integration/abcdef123456/enqueue"

  WarningAlerts:
    Name: "csv-processing-warning-alerts"
    Description: "Warning alerts for performance issues"
    Subscriptions:
      - Protocol: "email"
        Endpoint: "devops-team@company.com"
      - Protocol: "https"
        Endpoint: "https://hooks.slack.com/services/T00000000/B00000000/YYYYYYYYYYYYYYYYYYYYYYYY"

  BusinessAlerts:
    Name: "csv-processing-business-alerts"
    Description: "Business metric alerts"
    Subscriptions:
      - Protocol: "email"
        Endpoint: "business-team@company.com"

  SystemAlerts:
    Name: "csv-processing-system-alerts"
    Description: "System health composite alerts"
    Subscriptions:
      - Protocol: "email"
        Endpoint: "system-admin@company.com"
      - Protocol: "https"
        Endpoint: "https://hooks.slack.com/services/T00000000/B00000000/ZZZZZZZZZZZZZZZZZZZZZZZZ"
```

### 9.2 通知メッセージフォーマット

#### 9.2.1 Slack通知フォーマット
```json
{
  "text": "CSV Processing Alert",
  "attachments": [
    {
      "color": "danger",
      "fields": [
        {
          "title": "Alert Type",
          "value": "Lambda Error Rate High",
          "short": true
        },
        {
          "title": "Function",
          "value": "csv-processor",
          "short": true
        },
        {
          "title": "Current Value", 
          "value": "8 errors in 5 minutes",
          "short": true
        },
        {
          "title": "Threshold",
          "value": "5 errors",
          "short": true
        },
        {
          "title": "Time",
          "value": "2025-08-04T10:30:00Z",
          "short": false
        }
      ],
      "actions": [
        {
          "type": "button",
          "text": "View Dashboard",
          "url": "https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#dashboards:name=csv-processing-overview"
        },
        {
          "type": "button", 
          "text": "View Logs",
          "url": "https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#logsV2:log-groups/log-group/$252Faws$252Flambda$252Fcsv-processor"
        }
      ]
    }
  ]
}
```

## 10. ログ アーカイブとクエリ設計

### 10.1 S3アーカイブ設定

#### 10.1.1 ログ エクスポート設定
```yaml
LogArchive:
  S3Bucket: "csv-processing-logs-archive-{account-id}"
  ExportConfiguration:
    ExportTaskName: "csv-processor-logs-export"
    LogGroupName: "/aws/lambda/csv-processor"
    From: "24 hours ago"
    To: "now"
    Destination: "csv-processing-logs-archive-{account-id}"
    DestinationPrefix: "lambda-logs/csv-processor/"
  
  LifecyclePolicy:
    Rules:
      - Id: "csv-logs-lifecycle"
        Status: "Enabled"
        Transitions:
          - Days: 30
            StorageClass: "STANDARD_IA"
          - Days: 90
            StorageClass: "GLACIER"
          - Days: 365
            StorageClass: "DEEP_ARCHIVE"
```

### 10.2 CloudWatch Insights クエリ

#### 10.2.1 定期分析クエリ
```sql
-- エラー分析クエリ
fields @timestamp, level, event_type, details.error_message, details.error_stack
| filter level = "ERROR"
| stats count() by event_type
| sort count() desc

-- 性能分析クエリ  
fields @timestamp, event_type, details.processing_time, details.memory_used
| filter event_type = "CSV_VALIDATION"
| stats avg(details.processing_time), max(details.processing_time), min(details.processing_time) by bin(5m)

-- スループット分析クエリ
fields @timestamp, event_type, details.records_processed
| filter event_type = "CSV_CHUNK_PROCESSING"
| stats sum(details.records_processed) by bin(1h)
| sort @timestamp desc
```

## 11. 運用手順

### 11.1 監視運用手順

#### 11.1.1 日次監視チェックリスト
```markdown
## 日次監視チェックリスト

### システム健全性確認
- [ ] Lambda関数エラー率 < 1%
- [ ] Step Functions実行成功率 > 99%
- [ ] 平均処理時間 < 30秒
- [ ] 同時実行数 < 5

### ビジネス指標確認
- [ ] CSV検証成功率 > 95%
- [ ] 処理スループット > 50 records/sec
- [ ] 1日の処理ファイル数確認
- [ ] エラーファイル数確認

### リソース使用状況確認
- [ ] Lambda関数メモリ使用率 < 80%
- [ ] DynamoDB使用容量確認
- [ ] S3ストレージ使用量確認
- [ ] CloudWatch Logs使用量確認
```

#### 11.1.2 アラート対応手順
```markdown
## アラート対応手順

### Critical Alert対応
1. **即座対応**（15分以内）
   - Slack通知確認
   - CloudWatch Dashboard確認
   - 影響範囲特定

2. **原因調査**（30分以内）
   - CloudWatch Logsでエラー詳細確認
   - X-Rayトレースで処理フロー確認
   - メトリクス推移分析

3. **対応実施**（1時間以内）
   - 一時的な対処実施
   - 関係者への状況共有
   - 根本原因対策検討

### Warning Alert対応
1. **状況確認**（1時間以内）
   - メトリクス推移確認
   - 傾向分析実施

2. **予防対応**（4時間以内）
   - 必要に応じて設定調整
   - 改善策検討・実施
```

この監視・ログ詳細設計書により、統合Lambda関数を中心とした包括的な監視基盤を構築し、システムの健全性確保と迅速な障害対応を実現します。