# 製造準備_AWS環境

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| ドキュメント名 | 製造準備_AWS環境 |
| バージョン | 1.0 |
| 作成日 | 2025-08-04 |
| 作成者 | システム開発チーム |
| 更新日 | 2025-08-04 |

## 2. 製造準備概要

CSVファイル並列処理システムの開発・製造に先立ち、**AWS環境**に関する準備および決定事項をまとめています。

## 3. AWS環境準備決定事項

### 3.1 AWSアカウント設定 ✅完了

| 項目 | 決定内容 | 確認日 |
|------|----------|---------|
| **開発用AWSアカウント** | 526636471122 | 2025-08-04 |
| **AWS CLI** | v2.27.45 設定済み | 2025-08-04 |
| **AWSプロファイル** | default プロファイル使用 | 2025-08-04 |
| **リージョン** | ap-northeast-1 (東京) | 2025-08-04 |
| **IAMユーザー** | dev-terrarom-naka（管理者権限） | 2025-08-04 |
| **IAM権限** | AdministratorAccess + IAMUserChangePassword | 2025-08-04 |

**参照ドキュメント**: `03_Research/20250804_06_AWS環境準備結果.md`

### 3.2 Terraform State管理用S3バケット ✅決定

#### 決定事項
既存バケット **`naka-enginner-tfstate`** を継続利用することを決定しました。

#### バケット設定詳細

| 設定項目 | 設定内容 | 確認結果 |
|----------|----------|----------|
| **バケット名** | naka-enginner-tfstate | ✅確認済み |
| **リージョン** | ap-northeast-1 (東京) | ✅確認済み |
| **バージョニング** | 有効 (Enabled) | ✅設定済み |
| **サーバーサイド暗号化** | AES256 | ✅設定済み |
| **アクセス権限** | プライベート | ✅確認済み |
| **プロジェクト用プレフィックス** | 05_csv-batch/dev/, 05_csv-batch/prod/ | ✅作成済み |

#### バケット構成
```
naka-enginner-tfstate/
├── 01_web-site/          # 既存プロジェクト
├── 02_gacha/             # 既存プロジェクト
├── 03_s-gacha/           # 既存プロジェクト
├── 04_musicGame/         # 既存プロジェクト
└── 05_csv-batch/         # 【新規】今回プロジェクト用
    ├── dev/              # 開発環境用State
    │   ├── terraform.tfstate
    │   └── .terraform.lock.hcl
    └── prod/             # 本番環境用State（将来使用）
        ├── terraform.tfstate
        └── .terraform.lock.hcl
```

#### 利用メリット
1. **既存インフラ活用**: 新規バケット作成不要
2. **統一管理**: 他プロジェクトと一元的な管理
3. **セキュリティ**: 既に適切なセキュリティ設定済み
4. **運用効率**: 既存の運用プロセスを継続利用可能

#### Terraform backend設定例
```hcl
terraform {
  backend "s3" {
    bucket  = "naka-enginner-tfstate"
    key     = "05_csv-batch/dev/terraform.tfstate"
    region  = "ap-northeast-1"
    encrypt = true
    # DynamoDB State Lockは使用しない
  }
}
```

### 3.3 SAM Artifacts用S3バケット

#### 決定事項
新規バケット **`naka-sam-artifacts`** を作成します。

#### バケット構成設計
複数プロジェクトのSAM Artifactsを一元管理するため、プレフィックスによる管理を採用します。

```
naka-sam-artifacts/
└── 05_csv-batch/             # 今回プロジェクト用
    ├── dev/                  # 開発環境用artifacts
    │   ├── packaged-template.yaml
    │   ├── lambda-layers/
    │   │   └── common-layer.zip
    │   └── lambda-functions/
    │       ├── csv-processor.zip
    │       └── error-handler.zip
    └── prod/                 # 本番環境用artifacts（将来使用）
        ├── packaged-template.yaml
        └── lambda-functions/
```

#### SAM設定での活用
**samconfig.toml での設定例**
```toml
[default.deploy.parameters]
s3_bucket = "naka-sam-artifacts"
s3_prefix = "05_csv-batch/dev"
```

#### バケット設定詳細

| 設定項目 | 設定内容 | 確認結果 |
|----------|----------|----------|
| **バケット名** | naka-sam-artifacts | ✅作成済み |
| **リージョン** | ap-northeast-1 (東京) | ✅設定済み |
| **バージョニング** | 有効 (Enabled) | ✅設定済み |
| **ライフサイクルポリシー** | 90日後削除、旧バージョン30日後削除 | ✅設定済み |
| **パブリックアクセス** | 完全ブロック | ✅設定済み |

#### 利用メリット
1. **一元管理**: 全プロジェクトのSAM Artifactsを統一バケットで管理
2. **コスト効率**: バケット数削減によるコスト最適化
3. **運用統一**: ライフサイクルポリシーなどの設定を統一適用
4. **権限管理**: IAMポリシーでプレフィックス単位のアクセス制御が可能
5. **将来拡張性**: 新プロジェクト追加時もプレフィックス追加のみで対応

#### バケット作成コマンド（✅実行済み）
```bash
# バケット作成
aws s3 mb s3://naka-sam-artifacts --region ap-northeast-1

# バージョニング有効化
aws s3api put-bucket-versioning \
    --bucket naka-sam-artifacts \
    --versioning-configuration Status=Enabled

# パブリックアクセスブロック
aws s3api put-public-access-block \
    --bucket naka-sam-artifacts \
    --public-access-block-configuration \
    "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"

# ライフサイクルポリシー設定
aws s3api put-bucket-lifecycle-configuration \
    --bucket naka-sam-artifacts \
    --lifecycle-configuration file://lifecycle-policy.json
```

### 3.4 DynamoDB準備

#### 決定事項
Terraform State Lock用DynamoDBテーブルは **不要** とします。

#### 理由
- シングル開発者環境のため、並行実行による競合状態が発生しない
- State Lock機能なしでも開発・テストは問題なく実行可能
- DynamoDBコストの削減
- 構成のシンプル化

#### Terraform backend設定
DynamoDBテーブルを指定しないbackend設定を使用します。
```hcl
terraform {
  backend "s3" {
    bucket  = "naka-enginner-tfstate"
    key     = "05_csv-batch/dev/terraform.tfstate"
    region  = "ap-northeast-1"
    encrypt = true
    # dynamodb_table は指定しない
  }
}
```

## 4. GitHub環境準備

GitHub環境準備は **別ドキュメントで管理** します。

**参照ドキュメント**: `01_Document/04-02_製造準備_GitHub.md`

## 5. 開発ツール準備状況

### 5.1 必要ツール確認

| ツール | 状況 | 備考 |
|--------|------|------|
| **AWS CLI** | ✅インストール済み | v2.27.45 |
| **SAM CLI** | ⏳確認予定 | ローカル開発に必要 |
| **Terraform** | ⏳確認予定 | インフラ構築に必要 |
| **Node.js** | ⏳確認予定 | Lambda開発に必要 |
| **TypeScript** | ⏳確認予定 | Lambda開発に必要 |
| **Docker** | ❌使用しない | 代替手段で対応 |
| **Git** | ⏳確認予定 | ソース管理に必要 |

## 6. ローカル開発環境設計

### 6.1 Docker代替構成決定
**参照ドキュメント**: `03_Research/20250804_08_AWS開発環境のローカル構築調査.md`

| AWSサービス | ローカル代替手段 | 決定理由 |
|-------------|------------------|----------|
| **S3** | ローカルファイルシステム | 設定不要、デバッグ容易 |
| **DynamoDB** | DynamoDB Local (JAR版) | 完全互換、Docker不要 |
| **Aurora** | PostgreSQL (ローカル) | Aurora互換、開発環境定番 |
| **Lambda** | SAM CLI Local | Lambda環境に近い、デバッグ機能 |
| **Step Functions** | バッチスクリプト + curl | 簡単な代替実装 |

### 6.2 ローカル環境ディレクトリ構成
```
csv-parallel-processing-system/
├── .github/workflows/        # CI/CD定義
├── terraform/                # インフラ定義
│   ├── environments/
│   │   ├── dev/
│   │   └── prod/
│   └── modules/
├── sam-lambda/               # Lambda関数
│   ├── src/
│   ├── layers/
│   ├── tests/
│   └── template.yaml
├── local-env/                # ローカル開発環境
│   ├── local-s3/            # S3代替
│   ├── postgresql/          # Aurora代替
│   ├── dynamodb-local/      # DynamoDB代替
│   └── scripts/             # 環境管理スクリプト
├── docs/                     # ドキュメント
└── scripts/                  # 各種スクリプト
```

## 7. 次のステップ

### 7.1 即座に実行予定のタスク
1. **SAM Artifacts用S3バケット作成**
2. **開発ツールのインストール確認**
3. **GitHubリポジトリ作成**

### 7.2 開発環境構築順序
1. **ローカル開発環境セットアップ**
2. **Terraformプロジェクト初期化**
3. **SAMアプリケーション初期化**
4. **CI/CDパイプライン設定**

## 8. リスク・注意事項

### 8.1 既存バケット利用時の注意点
- **競合回避**: 他プロジェクトのStateファイルとの干渉を避けるため、適切なkey設定が必要
- **権限管理**: 現在の管理者権限での開発は問題ないが、本番環境では最小権限の原則を適用
- **バックアップ**: 重要なStateファイルの定期バックアップを検討

### 8.2 コスト管理
- **Aurora Serverless**: 自動スケーリングによるコスト変動の監視
- **DynamoDB**: オンデマンド課金での使用量監視
- **S3**: ライフサイクルポリシーによる不要ファイルの自動削除

## 9. 承認・確認事項

### 9.1 決定済み事項
- ✅ AWS環境 (アカウント: 526636471122) の継続利用
- ✅ Terraform State管理用S3バケット (naka-enginner-tfstate) の継続利用
- ✅ Docker不使用のローカル開発環境構築方針

### 9.2 次回決定予定事項
- SAM Artifacts用S3バケット作成タイミング
- GitHubリポジトリ設定詳細
- CI/CDパイプライン設定詳細
- 本番環境デプロイ戦略

## 10. 関連ドキュメント

### 10.1 参照ドキュメント
- `02_Tasks/20250804_01_製造タスク管理.md` - 全体タスク管理
- `03_Research/20250804_06_AWS環境準備結果.md` - AWS環境確認結果
- `03_Research/20250804_08_AWS開発環境のローカル構築調査.md` - ローカル環境調査結果
- `04-02_製造準備_GitHub.md` - GitHub環境準備詳細

### 10.2 設計書
- `02-08_基本設計書_ソース管理設計.md` - ソース管理方針
- `02-09_基本設計書_CI-CD設計書.md` - CI/CD設計
- `03-01_詳細設計書_インフラ詳細設計.md` - インフラ設計詳細

---

**最終更新**: 2025-08-04  
**承認者**: システム開発チーム  
**次回レビュー予定**: 製造開始前