# CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸¦åˆ—å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸ï¼ˆAWSã‚¢ã‚¤ã‚³ãƒ³ç‰ˆï¼‰

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦
å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³å›æ•°ã‚„æŠ•ç¨¿å›æ•°ã‚’å«ã‚€1000è¡Œãƒ¬ãƒ™ãƒ«ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’AWS Step Functionsåˆ†æ•£ãƒãƒƒãƒ—æ©Ÿèƒ½ã§ä¸¦åˆ—å‡¦ç†ã—ã€Aurora DBã«ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæƒ…å ±ã‚’åæ˜ ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰S3ã¸ã®è‡ªå‹•ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ã€æœ€å¤§5ä¸¦åˆ—ã§ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## 2. ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

### 2.1 å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆAWSã‚¢ã‚¤ã‚³ãƒ³ç‰ˆï¼‰

```mermaid
---
title: CSVãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ä¸¦åˆ—å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
config:
  theme: neutral
  flowchart:
    nodeSpacing: 15
    rankSpacing: 40
---
flowchart TB

external-system@{img: "https://api.iconify.design/material-symbols/cloud-sync.svg",label: "å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ",pos: "b",w: 60,h: 60,constraint: "on"}

subgraph aws["AWS (ap-northeast-1)"]
  subgraph vpc-main["VPC (10.0.0.0/16)"]
    subgraph group-private-1[" "]
      aurora-primary@{img: "https://api.iconify.design/logos/aws-rds.svg",label: "Aurora<br/>ServerlessV2<br/>(Primary)",pos: "b",w: 60,h: 60,constraint: "on"}
    end
    subgraph group-private-2[" "]
      aurora-reader@{img: "https://api.iconify.design/logos/aws-rds.svg",label: "Aurora<br/>ServerlessV2<br/>(Reader)",pos: "b",w: 60,h: 60,constraint: "on"}
    end
    subgraph group-endpoints[" "]
      vpc-endpoints@{img: "https://api.iconify.design/material-symbols/hub.svg",label: "VPC<br/>Endpoints",pos: "b",w: 50,h: 50,constraint: "on"}
    end
  end
  
  subgraph group-storage[" "]
    s3-input@{img: "https://api.iconify.design/logos/aws-s3.svg",label: "S3<br/>Input Bucket",pos: "b",w: 60,h: 60,constraint: "on"}
    s3-output@{img: "https://api.iconify.design/logos/aws-s3.svg",label: "S3<br/>Output Bucket",pos: "b",w: 60,h: 60,constraint: "on"}
  end
  
  subgraph group-orchestration[" "]
    eventbridge@{img: "https://api.iconify.design/logos/aws-eventbridge.svg",label: "EventBridge",pos: "b",w: 60,h: 60,constraint: "on"}
    stepfunctions@{img: "https://api.iconify.design/logos/aws-step-functions.svg",label: "Step Functions<br/>åˆ†æ•£ãƒãƒƒãƒ—",pos: "b",w: 60,h: 60,constraint: "on"}
  end
  
  subgraph group-compute[" "]
    lambda-validator@{img: "https://api.iconify.design/logos/aws-lambda.svg",label: "Lambda<br/>CSVæ¤œè¨¼",pos: "b",w: 60,h: 60,constraint: "on"}
    lambda-processor@{img: "https://api.iconify.design/logos/aws-lambda.svg",label: "Lambda<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°å‡¦ç†<br/>(æœ€å¤§5ä¸¦åˆ—)",pos: "b",w: 60,h: 60,constraint: "on"}
  end
  
  subgraph group-database[" "]
    dynamodb@{img: "https://api.iconify.design/logos/aws-dynamodb.svg",label: "DynamoDB<br/>ã‚¨ãƒ©ãƒ¼ç®¡ç†",pos: "b",w: 60,h: 60,constraint: "on"}
  end
  
  subgraph group-monitoring[" "]
    cloudwatch@{img: "https://api.iconify.design/logos/aws-cloudwatch.svg",label: "CloudWatch<br/>ãƒ­ã‚°ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹",pos: "b",w: 60,h: 60,constraint: "on"}
  end
  
  subgraph group-security[" "]
    iam@{img: "https://api.iconify.design/logos/aws-iam.svg",label: "IAM<br/>æ¨©é™ç®¡ç†",pos: "b",w: 60,h: 60,constraint: "on"}
    kms@{img: "https://api.iconify.design/material-symbols/key.svg",label: "KMS<br/>æš—å·åŒ–ã‚­ãƒ¼",pos: "b",w: 50,h: 50,constraint: "on"}
  end
end

%% ãƒ•ãƒ­ãƒ¼å®šç¾©
external-system -.->|"ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°CSV<br/>è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"| s3-input
s3-input -->|"ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¤ãƒ™ãƒ³ãƒˆ"| eventbridge
eventbridge -->|"ç›´æ¥å‘¼ã³å‡ºã—"| stepfunctions
stepfunctions -->|"æœ€åˆã®Lambdaæ¤œè¨¼"| lambda-validator
stepfunctions -->|"åˆ†æ•£ãƒãƒƒãƒ—é–‹å§‹"| lambda-processor
lambda-processor -->|"ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæ›´æ–°"| aurora-primary
lambda-processor -->|"å‡¦ç†çµæœ"| s3-output
lambda-processor -->|"ã‚¨ãƒ©ãƒ¼æƒ…å ±"| dynamodb
aurora-primary -.->|"ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"| aurora-reader

%% VPCæ¥ç¶š
lambda-processor -.->|"ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆæ¥ç¶š"| aurora-primary
vpc-endpoints -.->|"ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆAPIã‚¢ã‚¯ã‚»ã‚¹"| s3-input
vpc-endpoints -.-> dynamodb

%% ç›£è¦–ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
stepfunctions -.-> cloudwatch
lambda-processor -.-> cloudwatch
iam -.-> lambda-processor
iam -.-> stepfunctions
kms -.-> s3-input
kms -.-> dynamodb
kms -.-> aurora-primary

%% ã‚°ãƒ«ãƒ¼ãƒ—ã®é…ç½®
group-private-1 ~~~ group-private-2 ~~~ group-endpoints
group-storage ~~~ group-orchestration ~~~ group-compute
group-database ~~~ group-monitoring ~~~ group-security

%% ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
classDef default fill:#fff
style aws fill:#fff,color:#345,stroke:#345,stroke-width:2px
style vpc-main fill:#e8f4fd,color:#0a5490,stroke:#0a5490,stroke-width:2px
classDef group fill:none,stroke:none
class group-private-1,group-private-2,group-endpoints,group-storage,group-orchestration,group-compute,group-database,group-monitoring,group-security group

%% ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ(ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
click s3-input href "https://aws.amazon.com/s3/" _blank
click stepfunctions href "https://aws.amazon.com/step-functions/" _blank
click lambda-processor href "https://aws.amazon.com/lambda/" _blank
click aurora-primary href "https://aws.amazon.com/rds/aurora/" _blank
click dynamodb href "https://aws.amazon.com/dynamodb/" _blank
```

### 2.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è©³ç´°

```mermaid
sequenceDiagram
    participant ES as ğŸŒ å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ 
    participant S3 as ğŸ“¦ S3 Input
    participant EB as ğŸ“¡ EventBridge
    participant SF as ğŸ”„ Step Functions
    participant LV as Î» æ¤œè¨¼Lambda
    participant LP as Î» å‡¦ç†Lambda
    participant DB as ğŸ“Š DynamoDB
    participant Aurora as ğŸ—„ï¸ Aurora
    
    Note over ES, Aurora: 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»Step Functionsèµ·å‹•ãƒ•ã‚§ãƒ¼ã‚º
    ES->>S3: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°CSVè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    S3->>EB: ObjectCreated ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
    EB->>SF: Step Functionsç›´æ¥å‘¼ã³å‡ºã—
    SF->>SF: å®Ÿè¡Œåã«ã‚ˆã‚‹é‡è¤‡ãƒã‚§ãƒƒã‚¯
    
    Note over ES, Aurora: 2. CSVæ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚º
    SF->>LV: CSVãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ
    LV->>S3: ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹èª­ã¿å–ã‚Š
    LV->>SF: æ¤œè¨¼çµæœè¿”å´
    
    alt æ¤œè¨¼æˆåŠŸ
        Note over ES, Aurora: 3. åˆ†æ•£ãƒãƒƒãƒ—ä¸¦åˆ—å‡¦ç†ãƒ•ã‚§ãƒ¼ã‚º
        SF->>LP: åˆ†æ•£ãƒãƒƒãƒ—é–‹å§‹ï¼ˆæœ€å¤§5ä¸¦åˆ—ï¼‰
        
        loop å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
            LP->>Aurora: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå­˜åœ¨ç¢ºèª
            LP->>Aurora: ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæƒ…å ±æ›´æ–°ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å›æ•°ã€æŠ•ç¨¿å›æ•°ï¼‰
            alt æ›´æ–°æˆåŠŸ
                LP->>S3: å‡¦ç†çµæœãƒ­ã‚°å‡ºåŠ›
            else æ›´æ–°ã‚¨ãƒ©ãƒ¼
                LP->>DB: ã‚¨ãƒ©ãƒ¼æƒ…å ±è¨˜éŒ²
            end
        end
        
        Note over ES, Aurora: 4. å‡¦ç†å®Œäº†ãƒ•ã‚§ãƒ¼ã‚º
        SF->>SF: å…¨å‡¦ç†æ­£å¸¸å®Œäº†
    else æ¤œè¨¼å¤±æ•—
        SF->>SF: æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã§å‡¦ç†çµ‚äº†
    end
```

### 2.3 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆè©³ç´°ï¼ˆAWSã‚¢ã‚¤ã‚³ãƒ³ç‰ˆï¼‰

```mermaid
---
title: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆå›³
config:
  theme: neutral
  flowchart:
    nodeSpacing: 20
    rankSpacing: 50
---
flowchart TB

subgraph internet["ğŸŒ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ"]
  external-systems@{img: "https://api.iconify.design/material-symbols/cloud-sync.svg",label: "å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ",pos: "b",w: 60,h: 60,constraint: "on"}
end

subgraph aws-region["AWS ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ (ap-northeast-1)"]
  subgraph vpc["VPC (10.0.1.0/24)"]
    subgraph az1["Availability Zone 1a"]
      subgraph private-subnet-1["Private Subnet 1a (10.0.1.0/27)"]
        aurora-1@{img: "https://api.iconify.design/logos/aws-rds.svg",label: "Aurora<br/>Primary<br/>10.0.1.10",pos: "b",w: 60,h: 60,constraint: "on"}
      end
      subgraph public-subnet-1["Public Subnet 1a (10.0.1.32/27)"]
        nat-gateway-1@{img: "https://api.iconify.design/material-symbols/router.svg",label: "NAT<br/>Gateway<br/>10.0.1.40",pos: "b",w: 50,h: 50,constraint: "on"}
      end
    end
    
    subgraph az2["Availability Zone 1c"]
      subgraph private-subnet-2["Private Subnet 1c (10.0.1.64/27)"]
        aurora-2@{img: "https://api.iconify.design/logos/aws-rds.svg",label: "Aurora<br/>Reader<br/>10.0.1.70",pos: "b",w: 60,h: 60,constraint: "on"}
      end
      subgraph public-subnet-2["Public Subnet 1c (10.0.1.96/27)"]
        nat-gateway-2@{img: "https://api.iconify.design/material-symbols/router.svg",label: "NAT<br/>Gateway<br/>10.0.1.100",pos: "b",w: 50,h: 50,constraint: "on"}
      end
    end
    
    subgraph vpc-endpoints-group["VPC Endpoints"]
      s3-endpoint@{img: "https://api.iconify.design/logos/aws-s3.svg",label: "S3<br/>Gateway<br/>Endpoint",pos: "b",w: 50,h: 50,constraint: "on"}
      dynamodb-endpoint@{img: "https://api.iconify.design/logos/aws-dynamodb.svg",label: "DynamoDB<br/>Gateway<br/>Endpoint",pos: "b",w: 50,h: 50,constraint: "on"}
    end
    
    igw@{img: "https://api.iconify.design/material-symbols/language.svg",label: "Internet<br/>Gateway",pos: "b",w: 50,h: 50,constraint: "on"}
  end
  
  subgraph managed-services["ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹"]
    s3-service@{img: "https://api.iconify.design/logos/aws-s3.svg",label: "S3<br/>Buckets",pos: "b",w: 60,h: 60,constraint: "on"}
    dynamodb-service@{img: "https://api.iconify.design/logos/aws-dynamodb.svg",label: "DynamoDB",pos: "b",w: 60,h: 60,constraint: "on"}
    lambda-service@{img: "https://api.iconify.design/logos/aws-lambda.svg",label: "Lambda<br/>Functions",pos: "b",w: 60,h: 60,constraint: "on"}
    stepfunctions-service@{img: "https://api.iconify.design/logos/aws-step-functions.svg",label: "Step<br/>Functions",pos: "b",w: 60,h: 60,constraint: "on"}
  end
end

%% æ¥ç¶šå®šç¾©
external-systems -.->|"API/HTTPS"| igw
igw --> nat-gateway-1
igw --> nat-gateway-2

nat-gateway-1 -.-> aurora-1
nat-gateway-2 -.-> aurora-2

%% VPC Endpointæ¥ç¶š
lambda-service -.->|"ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆæ¥ç¶š"| s3-endpoint
lambda-service -.->|"ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆæ¥ç¶š"| dynamodb-endpoint

s3-endpoint --> s3-service
dynamodb-endpoint --> dynamodb-service

%% Lambda VPCæ¥ç¶š
lambda-service -.->|"VPCæ¥ç¶š"| aurora-1
lambda-service -.->|"VPCæ¥ç¶š"| aurora-2

%% Aurora ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
aurora-1 -.->|"ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"| aurora-2

%% ã‚¹ã‚¿ã‚¤ãƒ«
classDef public fill:#90EE90,stroke:#006400,stroke-width:2px
classDef private fill:#FFB6C1,stroke:#8B0000,stroke-width:2px
classDef managed fill:#87CEEB,stroke:#000080,stroke-width:2px
classDef vpc-style fill:#e8f4fd,color:#0a5490,stroke:#0a5490,stroke-width:2px

style vpc vpc-style
style aws-region fill:#fff,color:#345,stroke:#345,stroke-width:2px
style private-subnet-1 private
style private-subnet-2 private
style public-subnet-1 public
style public-subnet-2 public
style managed-services managed
```

## 3. AWSãƒªã‚½ãƒ¼ã‚¹ä»•æ§˜æ¦‚è¦

### 3.1 ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚µãƒ¼ãƒ“ã‚¹ | ç”¨é€” | è¨­å®šæ¦‚è¦ |
|---------|------|----------|
| **Amazon S3** | CSVãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ãƒ»å‡ºåŠ› | æš—å·åŒ–æœ‰åŠ¹ã€ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«è¨­å®š |
| **Amazon EventBridge** | S3ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡ | ObjectCreated ã‚¤ãƒ™ãƒ³ãƒˆæ¤œçŸ¥ |
| **AWS Lambda** | CSVæ¤œè¨¼ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°å‡¦ç† | Python 3.11ã€VPCæ¥ç¶š |
| **AWS Step Functions** | åˆ†æ•£ãƒãƒƒãƒ—ä¸¦åˆ—å‡¦ç† | æœ€å¤§5ä¸¦åˆ—ã€åˆ†æ•£ãƒ¢ãƒ¼ãƒ‰ |
| **Amazon Aurora ServerlessV2** | ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ç®¡ç† | PostgreSQLã€ACU 0.5-2.0 |
| **Amazon DynamoDB** | ç›£æŸ»ãƒ­ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼æƒ…å ±ç®¡ç† | ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰èª²é‡‘ã€TTLè¨­å®šï¼ˆ6ãƒ¶æœˆï¼‰ |
| **Amazon VPC** | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢ | ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆé…ç½® |
| **AWS IAM** | æ¨©é™ç®¡ç† | æœ€å°æ¨©é™ã®åŸå‰‡ |
| **AWS KMS** | æš—å·åŒ–ç®¡ç† | ãƒ‡ãƒ¼ã‚¿æš—å·åŒ– |

### 3.2 å‡¦ç†ãƒ•ãƒ­ãƒ¼æ¦‚è¦

1. **ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**: å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ãŒS3ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
2. **ã‚¤ãƒ™ãƒ³ãƒˆæ¤œçŸ¥**: EventBridgeãŒS3ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œçŸ¥
3. **Step Functionsé–‹å§‹**: EventBridgeãŒç›´æ¥Step Functionsã‚’å‘¼ã³å‡ºã—
4. **CSVæ¤œè¨¼**: Step Functionsã®æœ€åˆã®ã‚¹ãƒ†ãƒ¼ãƒˆã§CSVæ¤œè¨¼Lambdaã‚’å®Ÿè¡Œ
5. **ä¸¦åˆ—å‡¦ç†**: æ¤œè¨¼å¾Œã€åˆ†æ•£ãƒãƒƒãƒ—ã§æœ€å¤§5ä¸¦åˆ—å‡¦ç†ã‚’é–‹å§‹
6. **ãƒ‡ãƒ¼ã‚¿æ›´æ–°**: å„Lambdaé–¢æ•°ãŒAurora DBã®ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã‚’æ›´æ–°
7. **çµæœå‡ºåŠ›**: å‡¦ç†çµæœã‚’S3ã«å‡ºåŠ›ã€å…¨å‡¦ç†ãƒ­ã‚°ã‚’DynamoDBã«è¨˜éŒ²

### 3.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ç›£è¦–

- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: VPCå†…ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆé…ç½®ã€Security Groupåˆ¶å¾¡
- **ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–**: KMSã«ã‚ˆã‚‹ä¿å­˜æ™‚ãƒ»è»¢é€æ™‚æš—å·åŒ–
- **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**: IAMã«ã‚ˆã‚‹æœ€å°æ¨©é™è¨­å®š
- **ç›£è¦–**: CloudWatchã«ã‚ˆã‚‹ãƒ­ã‚°ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
- **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**: Serverlessæ§‹æˆã€å€‹äººé–‹ç™ºå‘ã‘è¨­å®š

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 4.1 Aurora PostgreSQL ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆ

#### 4.1.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±
CREATE TABLE users (
    user_id VARCHAR(10) PRIMARY KEY,
    username VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæƒ…å ±ï¼ˆCSVã‹ã‚‰æ›´æ–°ï¼‰
CREATE TABLE user_statistics (
    user_id VARCHAR(10) PRIMARY KEY REFERENCES users(user_id),
    login_count INTEGER DEFAULT 0,
    post_count INTEGER DEFAULT 0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®š
CREATE INDEX idx_user_statistics_last_updated ON user_statistics(last_updated);
CREATE INDEX idx_users_created_at ON users(created_at);
```

### 4.2 DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

#### 4.2.1 ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆProcessingLogsï¼‰

```json
{
  "TableName": "ProcessingLogs",
  "KeySchema": [
    {"AttributeName": "executionName", "KeyType": "HASH"},
    {"AttributeName": "timestamp", "KeyType": "RANGE"}
  ],
  "AttributeDefinitions": [
    {"AttributeName": "executionName", "AttributeType": "S"},
    {"AttributeName": "timestamp", "AttributeType": "S"},
    {"AttributeName": "userId", "AttributeType": "S"}
  ],
  "GlobalSecondaryIndexes": [
    {
      "IndexName": "UserIdIndex",
      "KeySchema": [
        {"AttributeName": "userId", "KeyType": "HASH"},
        {"AttributeName": "timestamp", "KeyType": "RANGE"}
      ],
      "Projection": {"ProjectionType": "ALL"}
    }
  ],
  "BillingMode": "ON_DEMAND",
  "TimeToLiveSpecification": {
    "AttributeName": "ttl",
    "Enabled": true
  }
}
```

#### 4.2.2 DynamoDBãƒ¬ã‚³ãƒ¼ãƒ‰ä¾‹

```json
{
  "executionName": "user-log-20250802-093000",
  "timestamp": "2025-08-02T09:30:15.123Z",
  "userId": "U00001",
  "processingType": "login_update",
  "oldValue": 10,
  "newValue": 12,
  "status": "success",
  "ttl": 1740787815,
  "executionArn": "arn:aws:states:ap-northeast-1:123456789012:execution:csv-user-log-processor:user-log-20250802-093000"
}
```

## 5. Step Functionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

### 5.1 ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©

```json
{
  "Comment": "CSVãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ä¸¦åˆ—å‡¦ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼",
  "StartAt": "CSVFileValidation",
  "States": {
    "CSVFileValidation": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:user-log-csv-validator",
      "Parameters": {
        "bucket.$": "$.detail.bucket.name",
        "key.$": "$.detail.object.key"
      },
      "ResultPath": "$.validation",
      "Retry": [
        {
          "ErrorEquals": ["Lambda.ServiceException", "Lambda.AWSLambdaException"],
          "IntervalSeconds": 2,
          "MaxAttempts": 3,
          "BackoffRate": 2.0
        }
      ],
      "Catch": [
        {
          "ErrorEquals": ["ValidationError"],
          "Next": "ValidationFailed",
          "ResultPath": "$.error"
        },
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ProcessingFailed",
          "ResultPath": "$.error"
        }
      ],
      "Next": "CheckValidationResult"
    },
    "CheckValidationResult": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.validation.isValid",
          "BooleanEquals": true,
          "Next": "UserLogDistributedMap"
        }
      ],
      "Default": "ValidationFailed"
    },
    "UserLogDistributedMap": {
      "Type": "Map",
      "Mode": "DISTRIBUTED",
      "MaxConcurrency": 5,
      "ItemReader": {
        "Resource": "arn:aws:states:::s3:getObject",
        "Parameters": {
          "Bucket.$": "$.detail.bucket.name",
          "Key.$": "$.detail.object.key"
        },
        "ReaderConfig": {
          "InputType": "CSV",
          "CSVHeaderLocation": "FIRST_ROW",
          "CSVHeaders": ["ãƒ¦ãƒ¼ã‚¶ãƒ¼ID", "ãƒ­ã‚°ã‚¤ãƒ³å›æ•°", "æŠ•ç¨¿å›æ•°"]
        }
      },
      "ResultWriter": {
        "Resource": "arn:aws:states:::s3:putObject",
        "Parameters": {
          "Bucket": "${OutputBucket}",
          "Prefix": "results/"
        }
      },
      "ItemProcessor": {
        "StartAt": "ProcessUserLog",
        "States": {
          "ProcessUserLog": {
            "Type": "Task",
            "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:user-log-processor",
            "Parameters": {
              "userId.$": "$.ãƒ¦ãƒ¼ã‚¶ãƒ¼ID",
              "loginCount.$": "$.ãƒ­ã‚°ã‚¤ãƒ³å›æ•°",
              "postCount.$": "$.æŠ•ç¨¿å›æ•°",
              "executionName.$": "$$.Execution.Name"
            },
            "Retry": [
              {
                "ErrorEquals": ["DatabaseError"],
                "IntervalSeconds": 1,
                "MaxAttempts": 3,
                "BackoffRate": 2.0
              }
            ],
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "ResultPath": "$.error",
                "Next": "LogError"
              }
            ],
            "End": true
          },
          "LogError": {
            "Type": "Task",
            "Resource": "arn:aws:states:::dynamodb:putItem",
            "Parameters": {
              "TableName": "ProcessingLogs",
              "Item": {
                "executionName": {"S.$": "$$.Execution.Name"},
                "timestamp": {"S.$": "$$.State.EnteredTime"},
                "userId": {"S.$": "$.ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"},
                "processingType": {"S": "user_update"},
                "status": {"S": "failed"},
                "errorMessage": {"S.$": "$.error.Error"},
                "ttl": {"N.$": "$.ttlTimestamp"}
              }
            },
            "End": true
          }
        }
      },
      "ToleratedFailurePercentage": 5,
      "ToleratedFailureCount": 50,
      "Next": "ProcessingCompleted"
    },
    "ProcessingCompleted": {
      "Type": "Pass",
      "Result": {
        "status": "SUCCESS",
        "message": "CSV processing completed successfully"
      },
      "End": true
    },
    "ValidationFailed": {
      "Type": "Pass",
      "Result": {
        "status": "VALIDATION_FAILED",
        "message": "CSV validation failed"
      },
      "End": true
    },
    "ProcessingFailed": {
      "Type": "Pass",
      "Result": {
        "status": "PROCESSING_FAILED",
        "message": "Processing failed due to system error"
      },
      "End": true
    }
  }
}
```

### 5.2 EventBridgeãƒ«ãƒ¼ãƒ«è¨­å®š

```json
{
  "Name": "s3-csv-upload-rule",
  "EventPattern": {
    "source": ["aws.s3"],
    "detail-type": ["Object Created"],
    "detail": {
      "bucket": {
        "name": ["${InputBucketName}"]
      },
      "object": {
        "key": [
          {
            "suffix": ".csv"
          }
        ]
      }
    }
  },
  "Targets": [
    {
      "Id": "1",
      "Arn": "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:csv-user-log-processor",
      "RoleArn": "arn:aws:iam::${AWS::AccountId}:role/EventBridgeStepFunctionsRole",
      "InputTransformer": {
        "InputPathsMap": {
          "bucket": "$.detail.bucket.name",
          "key": "$.detail.object.key"
        },
        "InputTemplate": "{\"detail\": {\"bucket\": {\"name\": \"<bucket>\"}, \"object\": {\"key\": \"<key>\"}}}"
      }
    }
  ]
}
```

### 5.3 ãƒ¡ãƒªãƒƒãƒˆã¨ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

#### ãƒ¡ãƒªãƒƒãƒˆ
- **ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆ**: EventBridgeã‹ã‚‰ç›´æ¥Step Functionsã‚’å‘¼ã³å‡ºã—
- **çŠ¶æ…‹ç®¡ç†**: Step Functionså†…ã§å…¨ä½“ã®å‡¦ç†çŠ¶æ…‹ã‚’ä¸€å…ƒç®¡ç†
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: å„ã‚¹ãƒ†ãƒ¼ãƒˆã§é©åˆ‡ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
- **ã‚³ã‚¹ãƒˆåŠ¹ç‡**: Lambdaé–¢æ•°ã®å‘¼ã³å‡ºã—å›æ•°ã‚’å‰Šæ¸›
- **å¯è¦–æ€§**: Step Functionsã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡ŒçŠ¶æ³ã‚’è¦–è¦šçš„ã«ç¢ºèª

#### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
- **åˆæœŸè¨­å®šã®è¤‡é›‘ã•**: Step Functionsã®ASLå®šç¾©ãŒè¤‡é›‘
- **ãƒ‡ãƒãƒƒã‚°**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆãŒå›°é›£

## 6. é‹ç”¨ãƒ»ä¿å®ˆ

### 5.1 ç›£è¦–é …ç›®
- Lambdaå®Ÿè¡Œæ™‚é–“ãƒ»ã‚¨ãƒ©ãƒ¼ç‡
- Step Functionså®Ÿè¡ŒçŠ¶æ³
- Aurora DBæ¥ç¶šãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- DynamoDBã‚¨ãƒ©ãƒ¼ä»¶æ•°

### 5.2 ã‚³ã‚¹ãƒˆæœ€é©åŒ–
- Aurora ServerlessV2ã«ã‚ˆã‚‹è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰
- Lambdaé©åˆ‡ãªãƒ¡ãƒ¢ãƒªã‚µã‚¤ã‚ºè¨­å®š
- DynamoDBã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰èª²é‡‘ï¼ˆç›£æŸ»ãƒ­ã‚°ç”¨ã€æœˆé¡$2-3ç¨‹åº¦ï¼‰
- DynamoDB TTLè‡ªå‹•å‰Šé™¤ï¼ˆ6ãƒ¶æœˆå¾Œï¼‰
- S3ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

### 5.3 ç›£æŸ»ãƒ­ã‚°è¨­è¨ˆã®ãƒ¡ãƒªãƒƒãƒˆ
- **Aurora processing_logsãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤**: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆå‰Šæ¸›
- **DynamoDBç›£æŸ»ãƒ­ã‚°**: å…¨å‡¦ç†å±¥æ­´ã‚’è‡ªå‹•TTLç®¡ç†
- **ã‚³ã‚¹ãƒˆåŠ¹ç‡**: æœˆé¡$2-3ã§comprehensive audit trail
- **é‹ç”¨ç°¡ç´ åŒ–**: æ‰‹å‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†ä¸è¦

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€AWSã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ç”¨ã—ãŸè¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã¨ã€å®Ÿç”¨çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿç¾ã—ã¾ã™ã€‚