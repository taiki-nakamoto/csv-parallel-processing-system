# S3バケット設計書

## 1. 概要

### 1.1 目的
CSVファイル並列処理システムにおけるS3バケットの詳細設計を定義する。外部システムからのファイルアップロード、処理結果の格納、監査ログの保存を安全かつ効率的に実現する。

### 1.2 設計方針
- **セキュリティ優先**: 最小権限の原則、暗号化、アクセス制御
- **運用効率**: ライフサイクル管理、自動削除、コスト最適化
- **高可用性**: バージョニング、レプリケーション対応
- **監査対応**: 全アクセスログ記録、コンプライアンス準拠

## 2. バケット構成

### 2.1 バケット一覧

| バケット名 | 用途 | 保存期間 | 暗号化 | バージョニング |
|-----------|------|----------|---------|----------------|
| csv-input-{account-id} | CSVファイル入力用 | 7日 | SSE-S3 | 有効 |
| csv-output-{account-id} | 処理結果出力用 | 30日 | SSE-S3 | 有効 |
| csv-archive-{account-id} | 長期アーカイブ用 | 1年 | SSE-S3 | 有効 |
| csv-logs-{account-id} | 監査ログ用 | 90日 | SSE-S3 | 無効 |

### 2.2 ディレクトリ構造

#### 2.2.1 csv-input-{account-id}
```
/
├── incoming/              # 外部システムからのアップロード先
│   ├── 2024/
│   │   ├── 08/
│   │   │   ├── 02/
│   │   │   │   ├── user-log-20240802-001.csv
│   │   │   │   └── user-log-20240802-002.csv
├── processing/            # 処理中ファイル（移動先）
├── processed/             # 処理済みファイル（移動先）
└── failed/               # エラーファイル（移動先）
```

#### 2.2.2 csv-output-{account-id}
```
/
├── results/              # 処理結果格納
│   ├── 2024/
│   │   ├── 08/
│   │   │   ├── 02/
│   │   │   │   ├── user-log-20240802-001-result.json
│   │   │   │   └── user-log-20240802-001-summary.csv
├── reports/              # 集計レポート
│   ├── daily/
│   ├── weekly/
│   └── monthly/
└── errors/               # エラー詳細情報
```

#### 2.2.3 csv-archive-{account-id}
```
/
├── 2024/
│   ├── 08/
│   │   ├── input/       # 元ファイルアーカイブ
│   │   └── output/      # 結果ファイルアーカイブ
```

#### 2.2.4 csv-logs-{account-id}
```
/
├── access-logs/          # S3アクセスログ
├── stepfunctions/        # Step Functions実行ログ
└── lambda/              # Lambda実行ログ
```

## 3. バケット詳細設計

### 3.1 csv-input-{account-id}

#### 3.1.1 基本設定
```json
{
  "BucketName": "csv-input-{account-id}",
  "Region": "ap-northeast-1",
  "VersioningConfiguration": {
    "Status": "Enabled"
  },
  "PublicAccessBlockConfiguration": {
    "BlockPublicAcls": true,
    "BlockPublicPolicy": true,
    "IgnorePublicAcls": true,
    "RestrictPublicBuckets": true
  },
  "BucketEncryption": {
    "Rules": [
      {
        "ApplyServerSideEncryptionByDefault": {
          "SSEAlgorithm": "AES256"
        },
        "BucketKeyEnabled": true
      }
    ]
  }
}
```

#### 3.1.2 イベント通知設定
```json
{
  "EventBridgeConfiguration": {
    "EventBridgeEnabled": true
  },
  "NotificationConfiguration": {
    "EventBridgeConfiguration": {
      "Events": [
        {
          "Name": "CSVFileUploaded",
          "Events": ["s3:ObjectCreated:Put", "s3:ObjectCreated:Post"],
          "Filter": {
            "Key": {
              "FilterRules": [
                {
                  "Name": "prefix",
                  "Value": "incoming/"
                },
                {
                  "Name": "suffix",
                  "Value": ".csv"
                }
              ]
            }
          }
        }
      ]
    }
  }
}
```

#### 3.1.3 ライフサイクルポリシー
```json
{
  "Rules": [
    {
      "Id": "MoveToProcessed",
      "Status": "Enabled",
      "Prefix": "incoming/",
      "Transitions": [
        {
          "Days": 1,
          "StorageClass": "STANDARD_IA"
        }
      ],
      "Expiration": {
        "Days": 7
      }
    },
    {
      "Id": "DeleteProcessedFiles",
      "Status": "Enabled",
      "Prefix": "processed/",
      "Expiration": {
        "Days": 7
      }
    },
    {
      "Id": "ArchiveFailedFiles",
      "Status": "Enabled",
      "Prefix": "failed/",
      "Transitions": [
        {
          "Days": 1,
          "StorageClass": "GLACIER_FLEXIBLE_RETRIEVAL"
        }
      ],
      "Expiration": {
        "Days": 90
      }
    }
  ]
}
```

#### 3.1.4 バケットポリシー
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyInsecureConnections",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": [
        "arn:aws:s3:::csv-input-{account-id}/*",
        "arn:aws:s3:::csv-input-{account-id}"
      ],
      "Condition": {
        "Bool": {
          "aws:SecureTransport": "false"
        }
      }
    },
    {
      "Sid": "AllowExternalSystemUpload",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::{external-account-id}:role/CSVUploadRole"
      },
      "Action": [
        "s3:PutObject",
        "s3:PutObjectAcl"
      ],
      "Resource": "arn:aws:s3:::csv-input-{account-id}/incoming/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-server-side-encryption": "AES256"
        },
        "StringLike": {
          "s3:x-amz-metadata-source-system": "external-system-*"
        }
      }
    },
    {
      "Sid": "AllowStepFunctionsAccess",
      "Effect": "Allow",
      "Principal": {
        "Service": "states.amazonaws.com"
      },
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::csv-input-{account-id}/*",
        "arn:aws:s3:::csv-input-{account-id}"
      ]
    }
  ]
}
```

### 3.2 csv-output-{account-id}

#### 3.2.1 基本設定
```json
{
  "BucketName": "csv-output-{account-id}",
  "Region": "ap-northeast-1",
  "VersioningConfiguration": {
    "Status": "Enabled"
  },
  "PublicAccessBlockConfiguration": {
    "BlockPublicAcls": true,
    "BlockPublicPolicy": true, 
    "IgnorePublicAcls": true,
    "RestrictPublicBuckets": true
  },
  "BucketEncryption": {
    "Rules": [
      {
        "ApplyServerSideEncryptionByDefault": {
          "SSEAlgorithm": "AES256"
        },
        "BucketKeyEnabled": true
      }
    ]
  }
}
```

#### 3.2.2 ライフサイクルポリシー
```json
{
  "Rules": [
    {
      "Id": "TransitionToIA",
      "Status": "Enabled",
      "Prefix": "results/",
      "Transitions": [
        {
          "Days": 7,
          "StorageClass": "STANDARD_IA"
        }
      ],
      "Expiration": {
        "Days": 30
      }
    },
    {
      "Id": "DeleteOldReports",
      "Status": "Enabled",
      "Prefix": "reports/",
      "Expiration": {
        "Days": 90
      }
    }
  ]
}
```

### 3.3 csv-archive-{account-id}

#### 3.3.1 基本設定
```json
{
  "BucketName": "csv-archive-{account-id}",
  "Region": "ap-northeast-1",
  "VersioningConfiguration": {
    "Status": "Enabled"
  },
  "ObjectLockConfiguration": {
    "ObjectLockEnabled": "Enabled",
    "Rule": {
      "DefaultRetention": {
        "Mode": "COMPLIANCE",
        "Days": 365
      }
    }
  }
}
```

#### 3.3.2 ライフサイクルポリシー
```json
{
  "Rules": [
    {
      "Id": "ArchiveToGlacier",
      "Status": "Enabled",
      "Transitions": [
        {
          "Days": 30,
          "StorageClass": "GLACIER_FLEXIBLE_RETRIEVAL"
        },
        {
          "Days": 90,
          "StorageClass": "DEEP_ARCHIVE"
        }
      ],
      "NoncurrentVersionTransitions": [
        {
          "NoncurrentDays": 30,
          "StorageClass": "GLACIER_FLEXIBLE_RETRIEVAL"
        }
      ],
      "NoncurrentVersionExpiration": {
        "NoncurrentDays": 365
      }
    }
  ]
}
```

### 3.4 csv-logs-{account-id}

#### 3.4.1 基本設定
```json
{
  "BucketName": "csv-logs-{account-id}",
  "Region": "ap-northeast-1",
  "AccessControl": "LogDeliveryWrite",
  "LifecycleConfiguration": {
    "Rules": [
      {
        "Id": "DeleteOldLogs",
        "Status": "Enabled",
        "Expiration": {
          "Days": 90
        }
      }
    ]
  }
}
```

## 4. CORS設定

### 4.1 csv-input-{account-id} CORS設定
外部システムからのブラウザアップロードを許可する場合のみ設定。

```json
{
  "CORSRules": [
    {
      "AllowedHeaders": ["*"],
      "AllowedMethods": ["PUT", "POST"],
      "AllowedOrigins": ["https://external-system.example.com"],
      "ExposeHeaders": ["ETag"],
      "MaxAgeSeconds": 3600
    }
  ]
}
```

## 5. アクセスログ設定

### 5.1 ログ配信設定
```json
{
  "LoggingConfiguration": {
    "DestinationBucketName": "csv-logs-{account-id}",
    "LogFilePrefix": "access-logs/",
    "TargetGrants": [
      {
        "Grantee": {
          "Type": "Group",
          "URI": "http://acs.amazonaws.com/groups/s3/LogDelivery"
        },
        "Permission": "WRITE"
      }
    ]
  }
}
```

## 6. 監視・アラート設定

### 6.1 CloudWatch メトリクス
```json
{
  "MetricsConfiguration": [
    {
      "Id": "EntireBucket",
      "Filter": {},
      "IncludedObjectVersions": "Current"
    },
    {
      "Id": "IncomingFiles",
      "Filter": {
        "Prefix": "incoming/"
      },
      "IncludedObjectVersions": "Current"
    }
  ]
}
```

### 6.2 CloudWatch アラーム
```yaml
Alarms:
  - Name: HighNumberOfFailedFiles
    MetricName: NumberOfObjects
    Namespace: AWS/S3
    Dimensions:
      - Name: BucketName
        Value: csv-input-{account-id}
      - Name: StorageType
        Value: AllStorageTypes
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 100
    ComparisonOperator: GreaterThanThreshold
    TreatMissingData: notBreaching
```

## 7. コスト最適化設計

### 7.1 ストレージクラス戦略

| データタイプ | 初期クラス | 移行先クラス | 移行タイミング |
|-------------|-----------|-------------|---------------|
| 入力CSV | STANDARD | STANDARD_IA | 1日後 |
| 処理結果 | STANDARD | STANDARD_IA | 7日後 |
| アーカイブ | STANDARD | GLACIER | 30日後 |
| アーカイブ | GLACIER | DEEP_ARCHIVE | 90日後 |

### 7.2 コスト見積もり（月額）
- **ストレージ**: 
  - STANDARD: 100GB × $0.025 = $2.50
  - STANDARD_IA: 500GB × $0.0138 = $6.90
  - GLACIER: 1TB × $0.005 = $5.00
- **リクエスト**: 
  - PUT: 10,000 × $0.0047/1000 = $0.047
  - GET: 50,000 × $0.00037/1000 = $0.019
- **データ転送**: 10GB × $0.114 = $1.14
- **合計**: 約$16/月

## 8. 災害復旧設計

### 8.1 レプリケーション設定
```json
{
  "ReplicationConfiguration": {
    "Role": "arn:aws:iam::{account-id}:role/S3ReplicationRole",
    "Rules": [
      {
        "ID": "ReplicateCriticalData",
        "Status": "Enabled",
        "Priority": 1,
        "Filter": {
          "Prefix": "incoming/"
        },
        "Destination": {
          "Bucket": "arn:aws:s3:::csv-input-dr-{account-id}",
          "ReplicationTime": {
            "Status": "Enabled",
            "Time": {
              "Minutes": 15
            }
          },
          "Metrics": {
            "Status": "Enabled",
            "EventThreshold": {
              "Minutes": 15
            }
          },
          "StorageClass": "STANDARD_IA"
        }
      }
    ]
  }
}
```

## 9. セキュリティ設計

### 9.1 暗号化キー管理
- **デフォルト**: SSE-S3（AES256）
- **オプション**: SSE-KMS（カスタマー管理キー）

### 9.2 アクセス制御マトリクス

| ロール | csv-input | csv-output | csv-archive | csv-logs |
|--------|-----------|------------|-------------|----------|
| 外部システム | PUT(incoming/*) | - | - | - |
| Step Functions | GET | PUT | - | - |
| Lambda関数 | GET/PUT | PUT | PUT | - |
| 管理者 | FULL | FULL | READ | READ |
| 監査役 | READ | READ | READ | READ |

### 9.3 データ分類とタグ付け
```json
{
  "TagSet": [
    {"Key": "DataClassification", "Value": "Internal"},
    {"Key": "Project", "Value": "CSV-Processing"},
    {"Key": "Environment", "Value": "Production"},
    {"Key": "CostCenter", "Value": "IT-Operations"},
    {"Key": "Owner", "Value": "data-platform-team"}
  ]
}
```

## 10. 運用手順

### 10.1 バケット作成手順
```bash
# バケット作成
aws s3api create-bucket \
  --bucket csv-input-123456789012 \
  --region ap-northeast-1 \
  --create-bucket-configuration LocationConstraint=ap-northeast-1

# バージョニング有効化
aws s3api put-bucket-versioning \
  --bucket csv-input-123456789012 \
  --versioning-configuration Status=Enabled

# 暗号化設定
aws s3api put-bucket-encryption \
  --bucket csv-input-123456789012 \
  --server-side-encryption-configuration file://encryption.json

# イベント通知設定
aws s3api put-bucket-notification-configuration \
  --bucket csv-input-123456789012 \
  --notification-configuration file://notification.json
```

### 10.2 監視設定手順
```bash
# メトリクス設定
aws s3api put-bucket-metrics-configuration \
  --bucket csv-input-123456789012 \
  --id EntireBucket \
  --metrics-configuration file://metrics.json

# アクセスログ設定
aws s3api put-bucket-logging \
  --bucket csv-input-123456789012 \
  --bucket-logging-status file://logging.json
```

## 11. トラブルシューティング

### 11.1 よくある問題と対処法

| 問題 | 原因 | 対処法 |
|------|------|--------|
| アップロード失敗 | 権限不足 | IAMロール確認 |
| イベント未発火 | フィルター設定ミス | prefix/suffix確認 |
| 高額請求 | ライフサイクル未設定 | 古いファイル削除 |
| アクセス拒否 | バケットポリシー | 条件句確認 |

### 11.2 パフォーマンスチューニング
- **マルチパートアップロード**: 100MB以上のファイル
- **Transfer Acceleration**: 海外からのアップロード
- **リクエストレート**: プレフィックスのランダム化

この設計により、安全で効率的なS3バケット運用を実現する。