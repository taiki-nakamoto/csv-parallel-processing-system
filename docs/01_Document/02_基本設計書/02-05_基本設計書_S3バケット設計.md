# S3バケット設計書

## 1. 概要

### 1.1 目的
CSVファイル並列処理システムにおけるS3バケットの詳細設計を定義する。外部システムからのファイルアップロード、処理結果の格納を安全かつ効率的に実現する。

### 1.2 設計方針
- **セキュリティ優先**: 最小権限の原則、暗号化、アクセス制御
- **運用効率**: ライフサイクル管理、自動削除、コスト最適化
- **シンプルな構成**: 単一バケットでの統合管理
- **適切な保存期間**: 30日間の保存期間で運用

## 2. バケット構成

### 2.1 バケット概要

| バケット名 | 用途 | 保存期間 | 暗号化 | バージョニング |
|-----------|------|----------|---------|----------------|
| csv-processing-{account-id} | CSV処理統合バケット | 30日 | SSE-S3 | 有効 |

### 2.2 ディレクトリ構造

```
csv-processing-{account-id}/
├── input/
│   ├── incoming/              # 外部システムからのアップロード先
│   │   ├── 2024/
│   │   │   ├── 08/
│   │   │   │   ├── 02/
│   │   │   │   │   ├── user-log-20240802-001.csv
│   │   │   │   │   └── user-log-20240802-002.csv
│   ├── processing/            # 処理中ファイル（移動先）
│   ├── processed/             # 処理済みファイル（移動先）
│   └── failed/               # エラーファイル（移動先）
└── output/
    ├── results/              # 処理結果格納
    │   ├── 2024/
    │   │   ├── 08/
    │   │   │   ├── 02/
    │   │   │   │   ├── user-log-20240802-001-result.json
    │   │   │   │   └── user-log-20240802-001-summary.csv
    ├── reports/              # 集計レポート
    │   ├── daily/
    │   ├── weekly/
    │   └── monthly/
    └── errors/               # エラー詳細情報
```

## 3. バケット詳細設計

### 3.1 基本設定

```json
{
  "BucketName": "csv-processing-{account-id}",
  "Region": "ap-northeast-1",
  "VersioningConfiguration": {
    "Status": "Enabled"
  },
  "PublicAccessBlockConfiguration": {
    "BlockPublicAcls": true,
    "BlockPublicPolicy": true,
    "IgnorePublicAcls": true,
    "RestrictPublicBuckets": true
  },
  "BucketEncryption": {
    "Rules": [
      {
        "ApplyServerSideEncryptionByDefault": {
          "SSEAlgorithm": "AES256"
        },
        "BucketKeyEnabled": true
      }
    ]
  }
}
```

### 3.2 イベント通知設定

```json
{
  "EventBridgeConfiguration": {
    "EventBridgeEnabled": true
  },
  "NotificationConfiguration": {
    "EventBridgeConfiguration": {
      "Events": [
        {
          "Name": "CSVFileUploaded",
          "Events": ["s3:ObjectCreated:Put", "s3:ObjectCreated:Post"],
          "Filter": {
            "Key": {
              "FilterRules": [
                {
                  "Name": "prefix",
                  "Value": "input/incoming/"
                },
                {
                  "Name": "suffix",
                  "Value": ".csv"
                }
              ]
            }
          }
        }
      ]
    }
  }
}
```

### 3.3 統一ライフサイクルポリシー

```json
{
  "Rules": [
    {
      "Id": "UnifiedLifecycle",
      "Status": "Enabled",
      "Transitions": [
        {
          "Days": 7,
          "StorageClass": "STANDARD_IA"
        }
      ],
      "Expiration": {
        "Days": 30
      }
    },
    {
      "Id": "DeleteFailedFiles",
      "Status": "Enabled",
      "Prefix": "input/failed/",
      "Expiration": {
        "Days": 30
      }
    },
    {
      "Id": "DeleteProcessedFiles",
      "Status": "Enabled", 
      "Prefix": "input/processed/",
      "Expiration": {
        "Days": 7
      }
    }
  ]
}
```

### 3.4 バケットポリシー

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyInsecureConnections",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/*",
        "arn:aws:s3:::csv-processing-{account-id}"
      ],
      "Condition": {
        "Bool": {
          "aws:SecureTransport": "false"
        }
      }
    },
    {
      "Sid": "AllowExternalSystemUpload",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::{external-account-id}:role/CSVUploadRole"
      },
      "Action": [
        "s3:PutObject",
        "s3:PutObjectAcl"
      ],
      "Resource": "arn:aws:s3:::csv-processing-{account-id}/input/incoming/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-server-side-encryption": "AES256"
        },
        "StringLike": {
          "s3:x-amz-metadata-source-system": "external-system-*"
        }
      }
    },
    {
      "Sid": "AllowStepFunctionsAccess",
      "Effect": "Allow",
      "Principal": {
        "Service": "states.amazonaws.com"
      },
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion",
        "s3:ListBucket",
        "s3:PutObject"
      ],
      "Resource": [
        "arn:aws:s3:::csv-processing-{account-id}/*",
        "arn:aws:s3:::csv-processing-{account-id}"
      ]
    },
    {
      "Sid": "AllowLambdaAccess",
      "Effect": "Allow",
      "Principal": {
        "Service": "lambda.amazonaws.com"
      },
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::csv-processing-{account-id}/*"
    }
  ]
}
```

## 4. CORS設定

外部システムからのブラウザアップロードを許可する場合のみ設定。

```json
{
  "CORSRules": [
    {
      "AllowedHeaders": ["*"],
      "AllowedMethods": ["PUT", "POST"],
      "AllowedOrigins": ["https://external-system.example.com"],
      "ExposeHeaders": ["ETag"],
      "MaxAgeSeconds": 3600
    }
  ]
}
```

## 5. 監視・アラート設定

### 5.1 CloudWatch メトリクス

```json
{
  "MetricsConfiguration": [
    {
      "Id": "EntireBucket",
      "Filter": {},
      "IncludedObjectVersions": "Current"
    },
    {
      "Id": "IncomingFiles",
      "Filter": {
        "Prefix": "input/incoming/"
      },
      "IncludedObjectVersions": "Current"
    },
    {
      "Id": "ProcessingFiles",
      "Filter": {
        "Prefix": "input/processing/"
      },
      "IncludedObjectVersions": "Current"
    }
  ]
}
```

### 5.2 CloudWatch アラーム

```yaml
Alarms:
  - Name: HighNumberOfFailedFiles
    MetricName: NumberOfObjects
    Namespace: AWS/S3
    Dimensions:
      - Name: BucketName
        Value: csv-processing-{account-id}
      - Name: StorageType
        Value: AllStorageTypes
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 100
    ComparisonOperator: GreaterThanThreshold
    TreatMissingData: notBreaching
    
  - Name: ProcessingBacklog
    MetricName: NumberOfObjects
    Namespace: AWS/S3
    Dimensions:
      - Name: BucketName
        Value: csv-processing-{account-id}
      - Name: FilterId
        Value: ProcessingFiles
    Statistic: Average
    Period: 600
    EvaluationPeriods: 2
    Threshold: 50
    ComparisonOperator: GreaterThanThreshold
```

## 6. コスト最適化設計

### 6.1 ストレージクラス戦略

| データタイプ | 初期クラス | 移行先クラス | 移行タイミング | 削除タイミング |
|-------------|-----------|-------------|---------------|---------------|
| 全データ | STANDARD | STANDARD_IA | 7日後 | 30日後 |
| 処理済みファイル | STANDARD | - | - | 7日後 |

### 6.2 コスト見積もり（月額）

- **ストレージ**: 
  - STANDARD: 100GB × $0.025 = $2.50
  - STANDARD_IA: 400GB × $0.0138 = $5.52
- **リクエスト**: 
  - PUT: 10,000 × $0.0047/1000 = $0.047
  - GET: 50,000 × $0.00037/1000 = $0.019
- **データ転送**: 10GB × $0.114 = $1.14
- **合計**: 約$9.25/月

## 7. セキュリティ設計

### 7.1 暗号化

- **デフォルト**: SSE-S3（AES256）を使用
- **バケットキー**: 有効化によりKMS呼び出しコストを削減

### 7.2 アクセス制御マトリクス

| ロール | input/incoming | input/processing | input/processed | input/failed | output/* |
|--------|---------------|-----------------|----------------|-------------|----------|
| 外部システム | PUT | - | - | - | - |
| Step Functions | GET | GET/PUT | PUT | PUT | PUT |
| Lambda関数 | GET | GET/PUT/DELETE | PUT/DELETE | PUT | PUT |
| 管理者 | FULL | FULL | FULL | FULL | FULL |

### 7.3 データ分類とタグ付け

```json
{
  "TagSet": [
    {"Key": "DataClassification", "Value": "Internal"},
    {"Key": "Project", "Value": "CSV-Processing"},
    {"Key": "Environment", "Value": "Production"},
    {"Key": "CostCenter", "Value": "IT-Operations"},
    {"Key": "Owner", "Value": "data-platform-team"}
  ]
}
```

## 8. 運用手順

### 8.1 バケット作成手順

```bash
# バケット作成
aws s3api create-bucket \
  --bucket csv-processing-123456789012 \
  --region ap-northeast-1 \
  --create-bucket-configuration LocationConstraint=ap-northeast-1

# バージョニング有効化
aws s3api put-bucket-versioning \
  --bucket csv-processing-123456789012 \
  --versioning-configuration Status=Enabled

# 暗号化設定
aws s3api put-bucket-encryption \
  --bucket csv-processing-123456789012 \
  --server-side-encryption-configuration file://encryption.json

# ライフサイクル設定
aws s3api put-bucket-lifecycle-configuration \
  --bucket csv-processing-123456789012 \
  --lifecycle-configuration file://lifecycle.json

# イベント通知設定
aws s3api put-bucket-notification-configuration \
  --bucket csv-processing-123456789012 \
  --notification-configuration file://notification.json
```

### 8.2 ディレクトリ初期化

```bash
# 必要なプレフィックスの作成（空オブジェクト）
aws s3api put-object \
  --bucket csv-processing-123456789012 \
  --key input/incoming/

aws s3api put-object \
  --bucket csv-processing-123456789012 \
  --key output/results/
```

## 9. トラブルシューティング

### 9.1 よくある問題と対処法

| 問題 | 原因 | 対処法 |
|------|------|--------|
| アップロード失敗 | 権限不足 | IAMロールのinput/incoming/*への権限確認 |
| イベント未発火 | プレフィックス設定ミス | input/incoming/プレフィックス確認 |
| ファイル削除されない | ライフサイクル設定ミス | ルールのプレフィックス確認 |
| アクセス拒否 | バケットポリシー | リソースパスとプリンシパル確認 |

### 9.2 パフォーマンスチューニング

- **マルチパートアップロード**: 100MB以上のファイルで使用
- **リクエストレート**: 必要に応じてプレフィックスのシャーディング
- **並列処理**: 複数ファイルの並列アップロード/ダウンロード

## 10. 移行時の注意事項

### 10.1 既存システムからの移行

1. 新バケットの作成と設定
2. アプリケーション設定の更新
3. 並行稼働期間の設定
4. データ移行の実施
5. 旧バケットの削除

### 10.2 バックアップ方針

- 30日間の保存期間内でのリストア対応
- 重要データは外部システム側でバックアップ
- 処理結果は必要に応じて外部システムへ転送

この設計により、シンプルで効率的なS3バケット運用を実現する。