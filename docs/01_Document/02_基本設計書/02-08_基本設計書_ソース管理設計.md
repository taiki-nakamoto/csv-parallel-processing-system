# ソース管理設計書

## 1. 概要

### 1.1 目的
CSVファイル並列処理システムのソースコード管理、バージョン管理、ブランチ戦略、継続的インテグレーション・デプロイメント（CI/CD）の設計を定義する。

### 1.2 設計方針
- **GitHubによる分散型バージョン管理**: GitHub Enterpriseまたは GitHub.comを使用
- **Git Flowブランチ戦略**: 構造化されたブランチ管理によるコード品質向上
- **モノレポ構成**: SAM Lambda関数、Terraform Infrastructure、ドキュメントを一元管理
- **適材適所のツール選択**: SAM（Lambda）+ Terraform（インフラ）の組み合わせ
- **自動化**: 段階的CI/CDパイプラインによるテスト・デプロイ自動化

### 1.3 対象範囲
- Lambda関数ソースコード（TypeScript with SAM）
- Infrastructure as Code（Terraform + SAM）
- 設計・運用ドキュメント
- テストコード（単体・統合・E2E）
- 設定ファイル（samconfig.toml、terraform.tfvars）

## 2. リポジトリ構成

### 2.1 SAM + Terraform モノレポ構成図
```
csv-parallel-processing-system/
├── .github/                      # GitHub Actions設定
│   ├── workflows/                # CI/CDワークフロー
│   │   ├── pr-check.yml         # プルリクエスト検証
│   │   ├── dev-deploy.yml       # 開発環境デプロイ
│   │   ├── prod-deploy.yml      # 本番環境デプロイ
│   │   └── security-scan.yml    # セキュリティスキャン
│   ├── ISSUE_TEMPLATE/          # Issueテンプレート
│   └── PULL_REQUEST_TEMPLATE.md # PRテンプレート
├── docs/                        # ドキュメント
│   ├── design/                  # 設計書
│   ├── operations/              # 運用手順書
│   └── api/                     # API仕様書
├── terraform/                   # Terraform Infrastructure
│   ├── environments/            # 環境別設定
│   │   ├── dev/
│   │   │   ├── main.tf
│   │   │   ├── variables.tf
│   │   │   └── terraform.tfvars
│   │   └── prod/
│   │       ├── main.tf
│   │       ├── variables.tf
│   │       └── terraform.tfvars
│   ├── modules/                 # Terraformモジュール
│   │   ├── network/             # VPC、Subnet、SG
│   │   ├── database/            # Aurora、DynamoDB
│   │   ├── storage/             # S3
│   │   ├── iam/                 # IAMロール、ポリシー
│   │   ├── security/            # KMS、Secrets Manager
│   │   └── orchestration/       # Step Functions、EventBridge
│   └── outputs.tf               # SAMで参照する値
├── sam/                         # SAM Lambda Functions
│   ├── template.yaml            # SAMテンプレート
│   ├── samconfig.toml          # SAM設定
│   ├── src/                    # Lambda関数ソースコード
│   │   ├── functions/          # Lambda関数（統合）
│   │   │   └── csv-processor/  # 統合Lambda関数
│   │   │       ├── index.ts    # エントリーポイント
│   │   │       ├── handler.ts  # イベント振り分け
│   │   │       ├── controllers/ # Presentation Layer
│   │   │       ├── services/   # Application Service Layer
│   │   │       ├── domain/     # Domain Layer（DIP適用）
│   │   │       ├── infrastructure/ # Infrastructure Layer
│   │   │       └── utils/      # 関数内ユーティリティ
│   │   ├── layers/             # Lambda Layers
│   │   │   ├── common-layer/   # 共通ライブラリ
│   │   │   ├── business-layer/ # ビジネスロジック
│   │   │   └── infrastructure-layer/ # インフラ実装
│   │   └── shared/             # 全体共通
│   │       ├── types/
│   │       ├── constants/
│   │       └── schemas/
│   └── tests/                  # テストコード
│       ├── unit/              # 単体テスト
│       ├── integration/       # 統合テスト
│       ├── fixtures/          # テストデータ
│       └── mocks/             # モック定義
├── scripts/                     # デプロイスクリプト
│   ├── deploy-infrastructure.sh # Terraformデプロイ
│   ├── deploy-lambda.sh        # SAMデプロイ
│   └── deploy-all.sh           # 全体デプロイ
│   └── shared/                  # 共通ライブラリ
│       ├── types/               # 型定義
│       ├── utils/               # ユーティリティ
│       ├── errors/              # エラー定義
│       └── config/              # 設定管理
├── tests/                       # 統合テスト
│   ├── integration/             # 統合テスト
│   ├── e2e/                     # E2Eテスト
│   └── fixtures/                # テストデータ
├── .gitignore                   # Git除外設定
├── .gitattributes               # Git属性設定
├── package.json                 # プロジェクト設定
├── tsconfig.json                # TypeScript設定
├── jest.config.js               # Jest設定
├── eslint.config.js             # ESLint設定
├── prettier.config.js           # Prettier設定
└── README.md                    # プロジェクト概要
```

### 2.2 ブランチ構成
```mermaid
gitgraph
    commit id: "Initial"
    
    branch develop
    checkout develop
    commit id: "Dev Setup"
    
    branch feature/csv-validator
    checkout feature/csv-validator
    commit id: "CSV Validator"
    
    checkout develop
    merge feature/csv-validator
    
    branch release/v1.0.0
    checkout release/v1.0.0
    commit id: "Release Prep"
    
    checkout main
    merge release/v1.0.0
    commit id: "v1.0.0" tag: "v1.0.0"
    
    checkout develop
    merge release/v1.0.0
    
    branch hotfix/critical-fix
    checkout hotfix/critical-fix
    commit id: "Critical Fix"
    
    checkout main
    merge hotfix/critical-fix
    commit id: "v1.0.1" tag: "v1.0.1"
    
    checkout develop
    merge hotfix/critical-fix
```

## 3. Git Flowブランチ戦略

### 3.1 ブランチタイプ定義

| ブランチタイプ | 説明 | 派生元 | マージ先 | 命名規則 |
|----------------|------|--------|----------|----------|
| **main** | 本番リリース用 | - | - | `main` |
| **develop** | 開発統合用 | main | main (via release) | `develop` |
| **feature** | 機能開発用 | develop | develop | `feature/{issue-number}-{feature-name}` |
| **release** | リリース準備用 | develop | main, develop | `release/{version}` |
| **hotfix** | 本番緊急修正用 | main | main, develop | `hotfix/{issue-number}-{fix-name}` |

### 3.2 ブランチ運用ルール

#### 3.2.1 mainブランチ
```yaml
MainBranch:
  Purpose: "本番環境にデプロイされるコード"
  Protection:
    - RequireStatusChecks: true
    - RequirePullRequestReviews: true
    - RequireCodeOwnerReviews: true
    - DismissStaleReviews: true
    - RequireLinearHistory: true
    - EnforceAdmins: true
  AutoDeploy:
    - Environment: "Production"
    - TriggerOn: "push to main"
    - ApprovalRequired: true
```

#### 3.2.2 developブランチ
```yaml
DevelopBranch:
  Purpose: "開発中機能の統合とテスト"
  Protection:
    - RequireStatusChecks: true
    - RequirePullRequestReviews: true
    - DismissStaleReviews: false
  AutoDeploy:
    - Environment: "Development"
    - TriggerOn: "push to develop"
    - ApprovalRequired: false
```

#### 3.2.3 featureブランチ
```yaml
FeatureBranch:
  NamingConvention: "feature/{issue-number}-{feature-name}"
  Examples:
    - "feature/123-csv-validator-implementation"
    - "feature/456-step-functions-error-handling"
    - "feature/789-dynamodb-audit-logging"
  
  Workflow:
    - Create: "develop ブランチから作成"
    - Development: "機能開発とテスト実装"
    - Testing: "単体テスト実行"
    - PullRequest: "develop ブランチへのPR作成"
    - Review: "コードレビュー実施"
    - Merge: "develop ブランチへマージ"
    - Delete: "マージ後にブランチ削除"
```

#### 3.2.4 releaseブランチ
```yaml
ReleaseBranch:
  NamingConvention: "release/{semantic-version}"
  Examples:
    - "release/1.0.0"
    - "release/1.1.0"
    - "release/2.0.0"
  
  Workflow:
    - Create: "develop ブランチから作成"
    - Preparation: "バージョン番号更新、ドキュメント更新"
    - Testing: "統合テスト、E2Eテスト実行"
    - BugFix: "リリース阻害要因の修正"
    - MergeToMain: "main ブランチへマージ（タグ付き）"
    - MergeToDevelop: "develop ブランチへマージ"
    - Delete: "マージ後にブランチ削除"
```

#### 3.2.5 hotfixブランチ
```yaml
HotfixBranch:
  NamingConvention: "hotfix/{issue-number}-{fix-name}"
  Examples:
    - "hotfix/999-memory-leak-fix"
    - "hotfix/888-security-vulnerability"
  
  Workflow:
    - Create: "main ブランチから作成"
    - Fix: "緊急修正とテスト"
    - Testing: "修正内容の検証"
    - MergeToMain: "main ブランチへマージ（パッチバージョンアップ）"
    - MergeToDevelop: "develop ブランチへマージ"
    - Delete: "マージ後にブランチ削除"
```

### 3.3 コミットメッセージ規約

#### 3.3.1 Conventional Commits
```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

#### 3.3.2 タイプ定義
```yaml
CommitTypes:
  feat: "新機能追加"
  fix: "バグ修正"
  docs: "ドキュメント更新"
  style: "コードスタイル修正"
  refactor: "リファクタリング"
  perf: "性能改善"
  test: "テスト追加・修正"
  chore: "雑務（依存関係更新など）"
  ci: "CI/CD設定変更"
  build: "ビルドシステム変更"
  revert: "コミット取り消し"
```

#### 3.3.3 スコープ定義
```yaml
Scopes:
  csv-validator: "CSV検証関数"
  user-processor: "ユーザーログ処理関数"
  audit-logger: "監査ログ関数"
  result-aggregator: "結果集約関数"
  infra: "インフラストラクチャ"
  docs: "ドキュメント"
  tests: "テスト"
  shared: "共通モジュール"
```

#### 3.3.4 コミット例
```bash
# 新機能
feat(csv-validator): add CSV format validation logic

# バグ修正
fix(user-processor): resolve memory leak in database connection

# ドキュメント更新
docs(api): update API specification for error responses

# インフラ変更
infra(cdk): add CloudWatch alarms for Lambda functions

# 破壊的変更
feat(shared)!: change error response format

BREAKING CHANGE: error response format changed from string to object
```

## 4. CI/CD参照

CI/CDパイプラインの詳細設計については、以下の専用設計書を参照してください：

- **02-09_基本設計書_CI-CD設計書.md**
  - GitHub Actions ワークフロー設計
  - AWS CodePipeline設計  
  - Branch Protection Rule設定
  - 環境管理とデプロイメント戦略
  - 品質ゲートとテスト戦略

## 4. コード品質管理

### 4.1 静的解析ツール

#### 4.1.1 ESLint設定
```javascript
// eslint.config.js
module.exports = [
  {
    files: ['src/**/*.ts'],
    languageOptions: {
      parser: '@typescript-eslint/parser',
      parserOptions: {
        ecmaVersion: 2022,
        sourceType: 'module',
        project: './tsconfig.json'
      }
    },
    plugins: {
      '@typescript-eslint': require('@typescript-eslint/eslint-plugin'),
      'security': require('eslint-plugin-security'),
      'import': require('eslint-plugin-import')
    },
    rules: {
      '@typescript-eslint/no-unused-vars': 'error',
      '@typescript-eslint/explicit-function-return-type': 'error',
      '@typescript-eslint/no-explicit-any': 'error',
      'security/detect-object-injection': 'error',
      'import/no-unresolved': 'error'
    }
  }
];
```

#### 4.1.2 Prettier設定
```javascript
// prettier.config.js
module.exports = {
  semi: true,
  trailingComma: 'es5',
  singleQuote: true,
  printWidth: 100,
  tabWidth: 2,
  useTabs: false,
  bracketSpacing: true,
  arrowParens: 'always'
};
```

#### 4.1.3 TypeScript設定
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "node",
    "lib": ["ES2022"],
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist",
    "resolveJsonModule": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "**/*.test.ts"]
}
```

### 4.2 テスト戦略

#### 4.2.1 Jest設定
```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src'],
  testMatch: ['**/__tests__/**/*.ts', '**/?(*.)+(spec|test).ts'],
  transform: {
    '^.+\\.ts$': 'ts-jest'
  },
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/**/*.test.ts',
    '!src/**/index.ts'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },
  setupFilesAfterEnv: ['<rootDir>/tests/setup.ts']
};
```

#### 4.2.2 テスト分類
```yaml
TestLevels:
  Unit:
    Location: "src/**/*.test.ts"
    Coverage: "> 80%"
    Command: "npm run test:unit"
    
  Integration:
    Location: "tests/integration/"
    Coverage: "主要フロー"
    Command: "npm run test:integration"
    
  E2E:
    Location: "tests/e2e/"
    Coverage: "ユーザーシナリオ"
    Command: "npm run test:e2e"
```

### 4.3 プルリクエスト規約

#### 4.3.1 PRテンプレート
```markdown
## 変更概要
<!-- 変更内容の概要を記載 -->

## 変更タイプ
- [ ] 新機能
- [ ] バグ修正
- [ ] ドキュメント更新
- [ ] リファクタリング
- [ ] テスト追加

## 関連Issue
Closes #

## テスト結果
- [ ] 単体テスト: 成功
- [ ] 統合テスト: 成功
- [ ] E2Eテスト: 成功

## 確認項目
- [ ] コードレビューガイドライン準拠
- [ ] セキュリティ要件確認
- [ ] 性能影響評価完了
- [ ] ドキュメント更新完了

## スクリーンショット
<!-- UIに関わる変更の場合 -->

## 追加コメント
<!-- その他注意事項 -->
```

#### 4.3.2 コードレビューガイドライン
```yaml
ReviewChecklist:
  Code_Quality:
    - "SOLID原則への準拠"
    - "適切な抽象化レベル"
    - "可読性とメンテナンス性"
    - "エラーハンドリングの適切性"
    
  Security:
    - "入力値検証の実装"
    - "機密情報の適切な取り扱い"
    - "SQLインジェクション対策"
    - "XSS対策"
    
  Performance:
    - "メモリ使用量の最適化"
    - "実行時間の最適化"
    - "リソース使用量の確認"
    
  Testing:
    - "テストカバレッジの確認"
    - "境界値テストの実装"
    - "異常系テストの実装"
```

## 5. セキュリティ管理

### 5.1 脆弱性スキャン

#### 5.1.1 依存関係スキャン
```yaml
# .github/workflows/security-scan.yml
name: Security Scan

on:
  schedule:
    - cron: '0 2 * * 1'  # 毎週月曜日 2:00 AM
  pull_request:
    branches: [main, develop]

jobs:
  dependency-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        
      - name: Snyk Dependency Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
```

#### 5.1.2 コードスキャン
```yaml
  code-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
```

### 5.2 シークレット管理

#### 5.2.1 .gitignore設定
```gitignore
# Dependencies
node_modules/
npm-debug.log*

# Build outputs
dist/
*.tsbuildinfo

# Environment variables
.env
.env.local
.env.*.local

# AWS
.aws/
*.pem

# CDK
cdk.out/
*.cdk.staging

# IDE
.vscode/
.idea/

# OS
.DS_Store
Thumbs.db

# Logs
logs/
*.log

# Coverage
coverage/
.nyc_output/

# Temporary files
*.tmp
*.temp
```

#### 5.2.2 git-secrets設定
```bash
# git-secrets初期化
git secrets --install
git secrets --register-aws

# カスタムパターン追加
git secrets --add 'private_key'
git secrets --add '[A-Za-z0-9/+=]{40}'  # Base64エンコードキー
git secrets --add '[0-9a-fA-F]{32}'     # MD5ハッシュ
```

## 6. 運用手順

### 6.1 リリースプロセス

#### 6.1.1 リリース準備
```bash
# 1. release ブランチ作成
git checkout develop
git pull origin develop
git checkout -b release/1.0.0

# 2. バージョン更新
npm version minor --no-git-tag-version

# 3. ドキュメント更新
# - CHANGELOG.md更新
# - README.md更新
# - パッケージ情報更新

# 4. 最終テスト実行
npm run test:all
npm run build
```

#### 6.1.2 リリース実行
```bash
# 1. main ブランチへマージ
git checkout main
git merge --no-ff release/1.0.0
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin main --tags

# 2. develop ブランチへマージ
git checkout develop
git merge --no-ff release/1.0.0
git push origin develop

# 3. release ブランチ削除
git branch -d release/1.0.0
git push origin --delete release/1.0.0
```

### 6.2 ホットフィックスプロセス

#### 6.2.1 ホットフィックス準備
```bash
# 1. hotfix ブランチ作成
git checkout main
git pull origin main
git checkout -b hotfix/critical-security-fix

# 2. 修正とテスト
# - 修正実装
# - テスト実行
# - 動作確認

# 3. バージョン更新
npm version patch --no-git-tag-version
```

#### 6.2.2 ホットフィックス実行
```bash
# 1. main ブランチへマージ
git checkout main
git merge --no-ff hotfix/critical-security-fix
git tag -a v1.0.1 -m "Hotfix version 1.0.1"
git push origin main --tags

# 2. develop ブランチへマージ
git checkout develop
git merge --no-ff hotfix/critical-security-fix
git push origin develop

# 3. hotfix ブランチ削除
git branch -d hotfix/critical-security-fix
git push origin --delete hotfix/critical-security-fix
```

### 6.3 トラブルシューティング

#### 6.3.1 よくある問題と対処法

| 問題 | 症状 | 対処法 |
|------|------|--------|
| **コンフリクト発生** | マージ時にコンフリクト | `git merge --abort` → 手動解決 → 再マージ |
| **CI/CD失敗** | テスト・デプロイ失敗 | ログ確認 → 修正 → 再実行 |
| **依存関係の脆弱性** | セキュリティアラート | `npm audit fix` → 手動更新 |
| **ブランチ保護エラー** | プッシュ失敗 | PR経由でのマージ |

#### 6.3.2 緊急時対応手順
```yaml
EmergencyProcedure:
  Critical_Bug:
    - "main ブランチからhotfixブランチ作成"
    - "最小限の修正実装"
    - "緊急リリース実行"
    - "事後報告書作成"
    
  Security_Incident:
    - "影響範囲の特定"
    - "一時的なサービス停止（必要に応じて）"
    - "セキュリティパッチ適用"
    - "セキュリティチーム報告"
```

このソース管理設計により、個人開発から企業レベルまでスケーラブルな開発・運用体制を構築し、コード品質とセキュリティを維持しながら効率的な開発を実現します。