# DynamoDB用途分析

## 1. システム構成図におけるDynamoDBの役割

### 1.1 配置場所と接続関係
- Lambda関数（並列処理実行）から処理結果の保存先として利用
- 複数のLambdaインスタンスから同時アクセスされる構成

### 1.2 DynamoDBの具体的用途

#### 1.2.1 処理状態管理
- **目的**: 各チャンクの処理状況をリアルタイムで追跡
- **格納データ例**:
  ```json
  {
    "ChunkId": "chunk-001",
    "Status": "processing|completed|failed",
    "ProcessedRows": 1000,
    "ErrorCount": 5,
    "StartTime": "2025-08-02T10:00:00Z",
    "EndTime": "2025-08-02T10:05:00Z",
    "ErrorDetails": "Row 10: Invalid format"
  }
  ```

#### 1.2.2 並列処理における一意性制御
- **重複処理防止**: 同じチャンクが複数回処理されることを防ぐ
- **条件付き書き込み**: DynamoDBの条件付きPutItemで排他制御

#### 1.2.3 処理結果の中間保存
- **部分結果の蓄積**: 各チャンクの処理結果を段階的に保存
- **障害復旧**: 処理途中での障害時に、完了済みチャンクの結果を保持

#### 1.2.4 進捗監視とログ
- **リアルタイム監視**: 処理全体の進捗状況を外部システムから監視可能
- **統計情報**: 処理速度、エラー率等の統計データを蓄積

## 2. DynamoDBを使用する利点

### 2.1 高性能・高可用性
- **低レイテンシ**: ミリ秒単位の応答時間
- **自動スケーリング**: 処理量に応じた自動的な容量調整
- **99.999%の可用性**: 高い可用性保証

### 2.2 並列処理との親和性
- **並行アクセス**: 複数のLambda関数から同時アクセス可能
- **ACID準拠**: トランザクション機能による整合性保証
- **条件付き操作**: 競合状態の回避

## 3. 代替手段との比較

### 3.1 RDSとの比較
| 項目 | DynamoDB | RDS |
|------|----------|-----|
| レイテンシ | 数ミリ秒 | 数十ミリ秒 |
| 同時接続数 | 無制限 | 制限あり |
| 管理負荷 | 低（フルマネージド） | 高（設定・保守必要） |
| コスト | 使用量課金 | インスタンス課金 |

### 3.2 S3との比較
- **S3**: 最終結果の永続化に適している
- **DynamoDB**: リアルタイムな状態管理に適している

## 4. 実装上の考慮事項

### 4.1 テーブル設計
```json
{
  "TableName": "CSV-Processing-Status",
  "KeySchema": [
    {
      "AttributeName": "ExecutionId",
      "KeyType": "HASH"
    },
    {
      "AttributeName": "ChunkId", 
      "KeyType": "RANGE"
    }
  ]
}
```

### 4.2 容量計画
- **読み込み容量**: 並列実行数 × アクセス頻度を考慮
- **書き込み容量**: チャンク数 × 更新頻度を考慮
- **オンデマンド課金**: 予測困難な場合は推奨

### 4.3 TTL設定
- **自動削除**: 処理完了後の古いレコードを自動削除
- **コスト最適化**: 不要なデータの蓄積を防止

## 5. まとめ

DynamoDBは本システムにおいて以下の重要な役割を果たす：

1. **処理状態の一元管理**: 全チャンクの処理状況をリアルタイム管理
2. **並列処理の制御**: 重複処理防止と排他制御
3. **監視とトラブルシューティング**: 処理の透明性と障害時の対応
4. **高性能・高可用性**: 大規模並列処理に適した性能特性

この用途により、Step Functions分散マップの処理効率と信頼性が大幅に向上する。