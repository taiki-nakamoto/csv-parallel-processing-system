# SAM拡張性ディレクトリ構成設計

## 1. 概要

AWS SAMとTerraformの併用構成において、複数のLambda関数を効率的に管理し、将来的な機能拡張にも対応できるスケーラブルなディレクトリ構成を設計します。

## 2. 改善されたディレクトリ構成

### 2.1 全体構成
```
csv-parallel-processing/
├── terraform/                    # Terraformコード
│   ├── environments/
│   │   ├── dev/
│   │   │   ├── main.tf
│   │   │   ├── variables.tf
│   │   │   └── terraform.tfvars
│   │   └── prod/
│   │       ├── main.tf
│   │       ├── variables.tf
│   │       └── terraform.tfvars
│   ├── modules/
│   │   ├── network/             # VPC、Subnet、SG
│   │   ├── database/            # Aurora、DynamoDB
│   │   ├── storage/             # S3
│   │   ├── iam/                 # IAMロール、ポリシー
│   │   ├── security/            # KMS、Secrets Manager
│   │   └── orchestration/       # Step Functions、EventBridge
│   └── outputs.tf               # SAMで参照する値を出力
│
├── sam/                         # SAMコード
│   ├── template.yaml            # SAMテンプレート
│   ├── samconfig.toml          # SAM設定
│   ├── src/                    # Lambda関数ソースコード
│   │   ├── functions/          # Lambda関数（拡張予定）
│   │   │   ├── csv-processor/  # CSVメイン処理Lambda関数
│   │   │   │   ├── index.ts    # エントリーポイント
│   │   │   │   ├── handler.ts  # Lambda handler
│   │   │   │   ├── services/   # 各機能のサービス層
│   │   │   │   │   ├── csv-validator.ts      # CSV検証機能
│   │   │   │   │   ├── csv-chunk-processor.ts # チャンク処理機能
│   │   │   │   │   ├── csv-audit-logger.ts   # 監査ログ機能
│   │   │   │   │   ├── csv-result-aggregator.ts # 結果集約機能
│   │   │   │   │   └── csv-error-handler.ts  # エラーハンドリング機能
│   │   │   │   ├── controllers/ # 機能別コントローラー
│   │   │   │   │   ├── validation-controller.ts
│   │   │   │   │   ├── processing-controller.ts
│   │   │   │   │   ├── audit-controller.ts
│   │   │   │   │   ├── aggregation-controller.ts
│   │   │   │   │   └── error-controller.ts
│   │   │   │   ├── utils/      # 関数内共通ユーティリティ
│   │   │   │   │   ├── event-parser.ts
│   │   │   │   │   └── response-formatter.ts
│   │   │   │   └── package.json # 関数の依存関係
│   │   │   └── function-xxx/   # 将来の拡張用Lambda関数
│   │   ├── layers/             # Lambda Layers
│   │   │   ├── common-layer/   # 共通ライブラリレイヤー
│   │   │   │   ├── nodejs/
│   │   │   │   │   ├── node_modules/
│   │   │   │   │   └── package.json
│   │   │   │   └── layer.yaml  # Layer固有設定
│   │   │   ├── business-layer/ # ビジネスロジックレイヤー
│   │   │   │   ├── nodejs/
│   │   │   │   │   ├── lib/
│   │   │   │   │   │   ├── services/
│   │   │   │   │   │   ├── repositories/
│   │   │   │   │   │   └── models/
│   │   │   │   │   └── package.json
│   │   │   │   └── layer.yaml
│   │   │   └── infrastructure-layer/ # インフラレイヤー
│   │   │       ├── nodejs/
│   │   │       │   ├── lib/
│   │   │       │   │   ├── aws/
│   │   │       │   │   ├── config/
│   │   │       │   │   └── utils/
│   │   │       │   └── package.json
│   │   │       └── layer.yaml
│   │   └── shared/             # 共通コード（型定義など）
│   │       ├── types/          # 共通型定義
│   │       │   ├── aws.ts
│   │       │   ├── domain.ts
│   │       │   └── index.ts
│   │       ├── constants/      # 定数定義
│   │       │   ├── csv.ts
│   │       │   ├── aws.ts
│   │       │   └── index.ts
│   │       ├── schemas/        # バリデーションスキーマ
│   │       │   ├── csv.ts
│   │       │   ├── user.ts
│   │       │   └── index.ts
│   │       └── interfaces/     # インターフェース定義
│   │           ├── repositories.ts
│   │           ├── services.ts
│   │           └── index.ts
│   ├── tests/                  # テストコード
│   │   ├── unit/              # 単体テスト
│   │   │   ├── functions/
│   │   │   │   ├── csv-validator/
│   │   │   │   │   ├── handler.test.ts
│   │   │   │   │   └── service.test.ts
│   │   │   │   ├── csv-chunk-processor/
│   │   │   │   │   ├── handler.test.ts
│   │   │   │   │   └── service.test.ts
│   │   │   │   └── [other-functions]/
│   │   │   ├── layers/
│   │   │   │   ├── business-layer/
│   │   │   │   └── infrastructure-layer/
│   │   │   └── shared/
│   │   ├── integration/       # 統合テスト
│   │   │   ├── workflows/
│   │   │   └── end-to-end/
│   │   ├── fixtures/          # テストデータ
│   │   │   ├── csv/
│   │   │   ├── users/
│   │   │   └── events/
│   │   ├── mocks/             # モック定義
│   │   │   ├── aws-services.ts
│   │   │   ├── repositories.ts
│   │   │   └── external-apis.ts
│   │   └── helpers/           # テストヘルパー
│   │       ├── builders/
│   │       ├── setup.ts
│   │       └── utils.ts
│   ├── scripts/               # ビルド・デプロイスクリプト
│   │   ├── build-layers.sh
│   │   ├── build-functions.sh
│   │   ├── deploy-dev.sh
│   │   └── deploy-prod.sh
│   └── configs/               # 設定ファイル
│       ├── jest.config.js
│       ├── tsconfig.json
│       ├── .eslintrc.json
│       └── .prettierrc
│
├── scripts/                     # デプロイスクリプト
│   ├── deploy-infrastructure.sh # Terraformデプロイ
│   ├── deploy-lambda.sh        # SAMデプロイ
│   └── deploy-all.sh           # 全体デプロイ
│
└── docs/                        # ドキュメント
```

## 3. 主な改善点

### 3.1 統合Lambda関数構成への変更
- 複数の機能を1つのLambda関数内に統合
- イベントタイプによる機能の振り分け
- 関数内での明確な責任分離（Controller → Service層）

### 3.2 Lambda関数の構造化
単一のLambda関数内に複数の機能を統合した構造を持ちます：

```typescript
// functions/csv-processor/
├── index.ts        // エントリーポイント（エクスポート）
├── handler.ts      // Lambda handler（イベント振り分け）
├── services/       // 各機能のサービス層
│   ├── csv-validator.ts      # CSV検証機能
│   ├── csv-chunk-processor.ts # チャンク処理機能
│   ├── csv-audit-logger.ts   # 監査ログ機能
│   ├── csv-result-aggregator.ts # 結果集約機能
│   └── csv-error-handler.ts  # エラーハンドリング機能
├── controllers/    // 機能別コントローラー
│   ├── validation-controller.ts
│   ├── processing-controller.ts
│   ├── audit-controller.ts
│   ├── aggregation-controller.ts
│   └── error-controller.ts
├── utils/          // 関数内共通ユーティリティ
│   ├── event-parser.ts
│   └── response-formatter.ts
└── package.json    // 関数の依存関係
```

### 3.3 レイヤー戦略の充実
- **common-layer**: AWS SDK、共通ユーティリティ
- **business-layer**: ドメインロジック、サービス層
- **infrastructure-layer**: AWS クライアント、設定管理

### 3.4 拡張性の向上
- 新しい機能をController/Serviceとして追加可能
- 単一Lambda関数内での機能統合による運用コスト削減
- レイヤーによるコード再利用
- 統一されたテスト構造
- 新しいLambda関数も将来的に追加可能（function-xxx/）

## 4. 実装例

### 4.1 Lambda関数の実装例

#### 4.1.1 index.ts（エントリーポイント）
```typescript
// functions/csv-processor/index.ts
export { handler } from './handler';
```

#### 4.1.2 handler.ts（Lambda handler - イベント振り分け）
```typescript
// functions/csv-processor/handler.ts
import { Context } from 'aws-lambda';
import { ValidationController } from './controllers/validation-controller';
import { ProcessingController } from './controllers/processing-controller';
import { AuditController } from './controllers/audit-controller';
import { AggregationController } from './controllers/aggregation-controller';
import { ErrorController } from './controllers/error-controller';
import { EventParser } from './utils/event-parser';
import { ResponseFormatter } from './utils/response-formatter';
import { Logger } from '/opt/nodejs/lib/utils/logger';

export const handler = async (event: any, context: Context) => {
  const logger = new Logger(context.awsRequestId);
  
  try {
    // イベントタイプを解析
    const eventType = EventParser.parseEventType(event);
    
    logger.info('Processing event', { eventType, event });

    let result;
    
    switch (eventType) {
      case 'CSV_VALIDATION':
        const validationController = new ValidationController(logger);
        result = await validationController.validate(event);
        break;
        
      case 'CSV_CHUNK_PROCESSING':
        const processingController = new ProcessingController(logger);
        result = await processingController.processChunk(event);
        break;
        
      case 'AUDIT_LOGGING':
        const auditController = new AuditController(logger);
        result = await auditController.logAudit(event);
        break;
        
      case 'RESULT_AGGREGATION':
        const aggregationController = new AggregationController(logger);
        result = await aggregationController.aggregateResults(event);
        break;
        
      default:
        throw new Error(`Unknown event type: ${eventType}`);
    }
    
    logger.info('Processing completed', { result });
    return ResponseFormatter.success(result);
    
  } catch (error) {
    logger.error('Processing failed', { error });
    const errorController = new ErrorController(logger);
    return errorController.handleError(error, event);
  }
};
```

#### 4.1.3 ValidationController（CSV検証コントローラー）
```typescript
// functions/csv-processor/controllers/validation-controller.ts
import { CsvValidatorService } from '../services/csv-validator';
import { Logger } from '/opt/nodejs/lib/utils/logger';

export class ValidationController {
  private csvValidatorService: CsvValidatorService;

  constructor(private logger: Logger) {
    this.csvValidatorService = new CsvValidatorService(logger);
  }

  async validate(event: any) {
    this.logger.info('Starting CSV validation');
    return await this.csvValidatorService.validate(event);
  }
}
```

#### 4.1.4 CsvValidatorService（CSV検証サービス）
```typescript
// functions/csv-processor/services/csv-validator.ts
import { S3Repository } from '/opt/nodejs/lib/repositories/s3-repository';
import { ValidationResult } from '/opt/nodejs/lib/models/validation-result';
import { CsvValidator } from '/opt/nodejs/lib/services/csv-validator';
import { Logger } from '/opt/nodejs/lib/utils/logger';

export class CsvValidatorService {
  private s3Repository: S3Repository;
  private csvValidator: CsvValidator;

  constructor(private logger: Logger) {
    this.s3Repository = new S3Repository();
    this.csvValidator = new CsvValidator();
  }

  async validate(event: any): Promise<ValidationResult> {
    const bucket = event.Records[0].s3.bucket.name;
    const key = event.Records[0].s3.object.key;

    this.logger.info('Starting CSV validation', { bucket, key });

    // S3からCSVファイルを取得
    const csvContent = await this.s3Repository.getObject(bucket, key);

    // CSV検証を実行
    const validationResult = await this.csvValidator.validate(csvContent);

    this.logger.info('CSV validation result', { validationResult });

    return validationResult;
  }
}
```

#### 4.1.5 package.json（関数の依存関係）
```json
{
  "name": "csv-processor-function",
  "version": "1.0.0",
  "description": "CSV processing Lambda function with multiple capabilities",
  "main": "index.js",
  "dependencies": {
    "csv-parser": "^3.0.0",
    "zod": "^3.22.0"
  },
  "devDependencies": {
    "@types/aws-lambda": "^8.10.0",
    "typescript": "^5.3.0"
  },
  "scripts": {
    "build": "tsc",
    "test": "jest"
  }
}
```

### 4.2 レイヤー実装例

#### 4.2.1 common-layer/package.json
```json
{
  "name": "csv-common-layer",
  "version": "1.0.0",
  "dependencies": {
    "@aws-sdk/client-s3": "^3.x.x",
    "@aws-sdk/client-dynamodb": "^3.x.x",
    "@aws-sdk/client-rds-data": "^3.x.x",
    "@aws-sdk/client-secrets-manager": "^3.x.x"
  }
}
```

#### 4.2.2 business-layer構成
```
business-layer/nodejs/lib/
├── services/
│   ├── csv-validation-service.ts
│   ├── user-processing-service.ts
│   └── error-management-service.ts
├── repositories/
│   ├── user-repository.ts
│   ├── audit-log-repository.ts
│   └── s3-repository.ts
└── models/
    ├── user.ts
    ├── processing-log.ts
    └── validation-result.ts
```

#### 4.2.3 infrastructure-layer構成
```
infrastructure-layer/nodejs/lib/
├── aws/
│   ├── dynamodb-client.ts
│   ├── aurora-client.ts
│   └── s3-client.ts
├── config/
│   └── environment.ts
└── utils/
    ├── logger.ts
    ├── error-handler.ts
    └── retry-util.ts
```

### 4.3 SAMテンプレート例
```yaml
# sam/template.yaml
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: CSV Parallel Processing Lambda Functions

Globals:
  Function:
    Runtime: nodejs22.x
    Architectures: [arm64]
    Timeout: 300
    MemorySize: 512
    Environment:
      Variables:
        NODE_ENV: production
        LOG_LEVEL: INFO
        NODE_PATH: /opt/nodejs/lib:/opt/nodejs/node_modules

Resources:
  # レイヤー定義
  CommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: csv-common-layer
      ContentUri: src/layers/common-layer/
      CompatibleRuntimes: [nodejs22.x]
      CompatibleArchitectures: [arm64]
    Metadata:
      BuildMethod: nodejs22.x

  BusinessLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: csv-business-layer
      ContentUri: src/layers/business-layer/
      CompatibleRuntimes: [nodejs22.x]
      CompatibleArchitectures: [arm64]
    DependsOn: [CommonLayer]
    Metadata:
      BuildMethod: nodejs22.x

  InfrastructureLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: csv-infrastructure-layer
      ContentUri: src/layers/infrastructure-layer/
      CompatibleRuntimes: [nodejs22.x]
      CompatibleArchitectures: [arm64]
    DependsOn: [CommonLayer]
    Metadata:
      BuildMethod: nodejs22.x

  # Lambda関数定義（単一の統合関数）
  CsvProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: csv-processor
      CodeUri: src/functions/csv-processor/
      Handler: index.handler
      Layers:
        - !Ref CommonLayer
        - !Ref BusinessLayer
        - !Ref InfrastructureLayer
      VpcConfig:
        SecurityGroupIds: [!Ref LambdaSecurityGroupId]
        SubnetIds: !Ref PrivateSubnetIds
      Environment:
        Variables:
          INPUT_BUCKET_NAME: !Ref InputBucketName
          OUTPUT_BUCKET_NAME: !Ref OutputBucketName
          AURORA_SECRET_ARN: !Ref AuroraSecretArn
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTableName
      ReservedConcurrentExecutions: 5
      Timeout: 900  # 15分（複数機能を含むため長めに設定）
      MemorySize: 1024  # 複数機能のため多めに設定
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node22
        Sourcemap: true
        External: ["@aws-sdk/*"]
```

### 4.4 ビルドスクリプト例

#### 4.4.1 build-layers.sh
```bash
#!/bin/bash
# scripts/build-layers.sh

set -e

echo "Building Lambda Layers..."

# 各レイヤーのビルド
for layer_dir in src/layers/*/; do
  layer_name=$(basename "$layer_dir")
  echo "Building layer: $layer_name"
  
  cd "$layer_dir"
  
  # package.jsonが存在する場合、npm install実行
  if [ -f "nodejs/package.json" ]; then
    cd nodejs
    npm install --production --no-optional
    cd ..
  fi
  
  # TypeScriptコンパイル
  if [ -f "nodejs/tsconfig.json" ]; then
    cd nodejs
    npx tsc
    cd ..
  fi
  
  cd - > /dev/null
done

echo "Layer build completed!"
```

#### 4.4.2 build-functions.sh
```bash
#!/bin/bash
# scripts/build-functions.sh

set -e

echo "Building Lambda Functions..."

# 各関数のビルド
for func_dir in src/functions/*/; do
  func_name=$(basename "$func_dir")
  echo "Building function: $func_name"
  
  cd "$func_dir"
  
  # 依存関係のインストール
  if [ -f "package.json" ]; then
    npm install
  fi
  
  # TypeScriptコンパイル（関数固有の設定がある場合）
  if [ -f "tsconfig.json" ]; then
    npx tsc
  fi
  
  cd - > /dev/null
done

echo "Function build completed!"
```

## 5. テスト構成

### 5.1 単体テストの例
```typescript
// tests/unit/functions/csv-validator/service.test.ts
import { CsvValidationService } from '../../../../src/functions/csv-validator/service';
import { Logger } from '../../../../src/layers/infrastructure-layer/nodejs/lib/utils/logger';

describe('CsvValidationService', () => {
  let service: CsvValidationService;
  let mockLogger: jest.Mocked<Logger>;

  beforeEach(() => {
    mockLogger = {
      info: jest.fn(),
      error: jest.fn(),
      warn: jest.fn(),
      debug: jest.fn(),
    } as any;
    
    service = new CsvValidationService(mockLogger);
  });

  describe('validate', () => {
    it('should validate CSV successfully', async () => {
      // テスト実装
    });
  });
});
```

### 5.2 統合テストの例
```typescript
// tests/integration/workflows/csv-processing.test.ts
import { S3Client } from '@aws-sdk/client-s3';
import { LambdaClient } from '@aws-sdk/client-lambda';

describe('CSV Processing Workflow', () => {
  let s3Client: S3Client;
  let lambdaClient: LambdaClient;

  beforeAll(() => {
    s3Client = new S3Client({ region: 'ap-northeast-1' });
    lambdaClient = new LambdaClient({ region: 'ap-northeast-1' });
  });

  it('should process CSV file end-to-end', async () => {
    // 統合テスト実装
  });
});
```

## 6. 運用・保守の考慮事項

### 6.1 デプロイメント
- 段階的デプロイ: レイヤー → 関数 → インフラ更新
- Blue/Green デプロイメント対応
- ロールバック戦略の実装

### 6.2 監視・ログ
- 各関数の統一されたログフォーマット
- CloudWatch Logsによる集約監視
- X-Rayによる分散トレーシング

### 6.3 セキュリティ
- 関数ごとの最小権限IAMロール
- レイヤーを通じた共通セキュリティ実装
- 依存関係の脆弱性管理

## 7. まとめ

この拡張性ディレクトリ構成により、以下の利点を実現できます：

1. **スケーラビリティ**: 新機能の追加が容易
2. **保守性**: 明確な責任分界と統一された構造
3. **テスタビリティ**: 体系的なテスト構成
4. **開発効率**: レイヤーによるコード再利用
5. **運用性**: 統一された監視・デプロイメント

Lambda開発標準仕様書の設計思想と完全に整合し、企業レベルでの開発・運用に対応できる堅牢な構成となっています。