# S3イベント通知で起動可能なAWSリソース一覧

S3イベント通知は、S3バケット内でオブジェクトの作成、削除、復元などのイベントが発生した際に、他のAWSサービスを自動的に起動する機能です。本ドキュメントでは、S3イベント通知から直接起動可能なAWSリソースとその特徴、使い分けについて詳しく解説します。

## 1. S3イベント通知で起動可能なAWSリソース

### 1.1 直接起動可能なリソース一覧

S3イベント通知から直接起動できるAWSリソースは以下の通りです：

1. **AWS Lambda**
2. **Amazon SQS (Simple Queue Service)**
3. **Amazon SNS (Simple Notification Service)**
4. **Amazon EventBridge**

これら4つのサービスのみがS3イベント通知の直接的な宛先として設定可能です。Step Functionsを含む他のAWSサービスを起動したい場合は、これらのサービスを経由する必要があります。

### 1.2 各リソースの詳細と特徴

#### 1.2.1 AWS Lambda

**概要：**
- サーバーレスコンピューティングサービス
- S3イベントを受け取り、カスタムコードを実行
- 最も一般的なS3イベント処理の選択肢

**主な特徴：**
- **同期処理：** イベント発生と同時に即座に処理を開始
- **自動スケーリング：** 並列実行数に応じて自動的にスケール
- **15分までの処理：** 最大実行時間は15分
- **メモリ：** 128MB〜10,240MB（10GB）まで設定可能

**使用例：**
```json
{
  "LambdaFunctionConfigurations": [{
    "Id": "ObjectCreatedEvents",
    "LambdaFunctionArn": "arn:aws:lambda:region:account-id:function:function-name",
    "Events": ["s3:ObjectCreated:*"],
    "Filter": {
      "Key": {
        "FilterRules": [{
          "Name": "prefix",
          "Value": "documents/"
        }, {
          "Name": "suffix",
          "Value": ".pdf"
        }]
      }
    }
  }]
}
```

**適したユースケース：**
- 画像のサムネイル生成
- ファイル形式の変換
- データの検証や変換処理
- 他のAWSサービスの起動（Step Functions、ECS、Batchなど）

#### 1.2.2 Amazon SQS

**概要：**
- フルマネージドメッセージキューイングサービス
- イベントをキューに格納し、非同期処理を実現

**主な特徴：**
- **非同期処理：** イベントをキューに保存し、後で処理
- **メッセージ保持期間：** 1分〜14日間
- **配信保証：** 少なくとも1回の配信を保証
- **FIFO対応：** 順序保証が必要な場合はFIFOキューを使用可能

**標準キューとFIFOキューの違い：**

| 特徴 | 標準キュー | FIFOキュー |
|------|-----------|------------|
| スループット | ほぼ無制限 | 300 TPS（バッチで3,000） |
| 順序保証 | ベストエフォート | 厳密な順序保証 |
| 重複排除 | なし | あり |
| 料金 | 安価 | やや高価 |

**使用例：**
```json
{
  "QueueConfigurations": [{
    "Id": "1",
    "QueueArn": "arn:aws:sqs:region:account-id:queue-name",
    "Events": ["s3:ObjectCreated:Put"],
    "Filter": {
      "Key": {
        "FilterRules": [{
          "Name": "prefix",
          "Value": "incoming/"
        }]
      }
    }
  }]
}
```

**適したユースケース：**
- バッチ処理のためのイベント収集
- 処理の平準化（ピーク時の負荷分散）
- 複数のコンシューマーによる並列処理
- エラー時の再処理が必要なケース

#### 1.2.3 Amazon SNS

**概要：**
- フルマネージドなpub/subメッセージングサービス
- 複数の宛先に同時にメッセージを配信

**主な特徴：**
- **ファンアウト：** 1つのイベントを複数の宛先に配信
- **多様な宛先：** Lambda、SQS、HTTP/S、Email、SMSなど
- **フィルタリング：** メッセージ属性に基づくフィルタリング
- **配信再試行：** 自動的な再試行メカニズム

**サポートされる宛先：**
- AWS Lambda
- Amazon SQS
- HTTP/HTTPS エンドポイント
- Email
- SMS
- モバイルプッシュ通知
- Amazon Kinesis Data Firehose

**使用例：**
```json
{
  "TopicConfigurations": [{
    "Id": "ObjectCreatedEvents",
    "TopicArn": "arn:aws:sns:region:account-id:topic-name",
    "Events": ["s3:ObjectCreated:*", "s3:ObjectRemoved:*"],
    "Filter": {
      "Key": {
        "FilterRules": [{
          "Name": "prefix",
          "Value": "logs/"
        }]
      }
    }
  }]
}
```

**適したユースケース：**
- 複数のシステムへの同時通知
- イベントの配信と処理の分離
- 通知システムの構築
- マイクロサービス間の疎結合な連携

#### 1.2.4 Amazon EventBridge

**概要：**
- サーバーレスイベントバスサービス
- より高度なルーティングとフィルタリング機能を提供

**主な特徴：**
- **高度なフィルタリング：** コンテンツベースのルーティング
- **スキーマレジストリ：** イベントスキーマの管理
- **豊富な宛先：** 20以上のAWSサービスに直接接続
- **クロスアカウント：** 異なるAWSアカウント間でのイベント共有

**EventBridgeから直接起動可能な主要サービス：**
- AWS Lambda
- Amazon SQS
- Amazon SNS
- AWS Step Functions
- Amazon Kinesis
- AWS Batch
- Amazon ECS（タスク）
- AWS CodeBuild
- AWS CodePipeline
- Amazon SageMaker Pipeline
- AWS Systems Manager
- その他多数

**使用例：**
```json
{
  "EventBridgeConfiguration": {}
}
```
※ S3でEventBridge通知を有効にすると、すべてのイベントがデフォルトイベントバスに送信されます

**EventBridgeルールの例：**
```json
{
  "Source": ["aws.s3"],
  "DetailType": ["Object Created"],
  "Detail": {
    "bucket": {
      "name": ["my-bucket"]
    },
    "object": {
      "key": [{
        "prefix": "uploads/"
      }]
    }
  }
}
```

**適したユースケース：**
- 複雑なイベントルーティングが必要な場合
- Step Functionsを直接起動したい場合
- 複数のAWSサービスを連携させたワークフロー
- イベント駆動型アーキテクチャの中核

## 2. 各リソースの比較と使い分け

### 2.1 機能比較表

| 機能/特徴 | Lambda | SQS | SNS | EventBridge |
|-----------|--------|-----|-----|-------------|
| 処理タイプ | 同期 | 非同期 | 非同期 | 非同期 |
| スケーラビリティ | 自動 | 自動 | 自動 | 自動 |
| 複数宛先への配信 | × | × | ○ | ○ |
| メッセージ保持 | × | ○（最大14日） | × | ○（24時間） |
| 順序保証 | × | ○（FIFO） | × | × |
| フィルタリング | 基本的 | × | ○ | 高度 |
| 再試行 | ○ | ○ | ○ | ○ |
| DLQ対応 | ○ | ○ | △ | ○ |
| コスト | 実行時間ベース | メッセージ数ベース | 配信数ベース | ルール数ベース |

### 2.2 ユースケース別の推奨構成

#### 2.2.1 即座に処理を実行したい場合
**推奨：Lambda**
```
S3 → Lambda → (処理実行)
```
- 最もシンプルで低レイテンシ
- 15分以内で完了する処理に最適

#### 2.2.2 Step Functionsを起動したい場合

**オプション1：Lambda経由**
```
S3 → Lambda → Step Functions
```
- 最も一般的なパターン
- Lambdaで前処理やパラメータ調整が可能

**オプション2：EventBridge経由**
```
S3 → EventBridge → Step Functions
```
- Lambdaのコード管理が不要
- EventBridgeのルールで柔軟なルーティング

#### 2.2.3 大量のイベントを効率的に処理したい場合
**推奨：SQS + Lambda/EC2**
```
S3 → SQS → Lambda (ポーリング)
      ↓
     EC2/ECS (ポーリング)
```
- バッファリングによる負荷平準化
- 処理失敗時の再試行が容易

#### 2.2.4 複数のシステムに通知したい場合
**推奨：SNS**
```
S3 → SNS → Lambda
      ↓
     SQS
      ↓
    Email/SMS
```
- 1つのイベントを複数の宛先に配信
- 各宛先で独立した処理が可能

#### 2.2.5 複雑なワークフローを構築したい場合
**推奨：EventBridge**
```
S3 → EventBridge → Step Functions
         ↓
       Lambda
         ↓
       SQS
```
- 条件に応じた複雑なルーティング
- 複数のAWSサービスとの統合が容易

## 3. 設定時の注意点とベストプラクティス

### 3.1 共通の注意点

1. **イベント通知の重複**
   - S3イベント通知は「少なくとも1回」の配信を保証
   - 同じイベントが複数回配信される可能性があるため、冪等性を考慮した設計が必要

2. **フィルタリングの活用**
   - プレフィックスとサフィックスフィルターを使用して、不要なイベントを削減
   - 処理コストとパフォーマンスの最適化

3. **エラーハンドリング**
   - 各サービスでDLQ（Dead Letter Queue）を設定
   - ログとモニタリングの実装

### 3.2 サービス別のベストプラクティス

#### Lambda使用時
- 同時実行数の制限を設定してダウンストリームサービスを保護
- 環境変数でS3バケット名などの設定を管理
- エラー時の再試行回数を適切に設定

#### SQS使用時
- 可視性タイムアウトを処理時間より長く設定
- メッセージの重複排除が必要な場合はFIFOキューを使用
- DLQを設定して処理失敗メッセージを隔離

#### SNS使用時
- サブスクリプションフィルターを活用して配信を最適化
- 配信の再試行ポリシーを適切に設定
- クロスリージョン配信の場合はリージョン間のレイテンシを考慮

#### EventBridge使用時
- ルールのターゲット数は5個以内に抑える（パフォーマンスのため）
- イベントパターンはできるだけ具体的に記述
- アーカイブとリプレイ機能を活用してテストを効率化

## 4. コスト比較

### 4.1 各サービスの料金体系

| サービス | 料金体系 | 無料枠 |
|----------|----------|--------|
| Lambda | リクエスト数 + 実行時間（GB-秒） | 月100万リクエスト、40万GB-秒 |
| SQS | リクエスト数 | 月100万リクエスト |
| SNS | 配信数 | 月100万件（HTTP/S配信） |
| EventBridge | イベント数 | カスタムイベントは有料、AWSサービスイベントは無料 |

### 4.2 コスト最適化のポイント

1. **小規模・低頻度の処理**
   - Lambda直接実行が最もコスト効率的

2. **大規模・高頻度の処理**
   - SQSでバッファリングしてバッチ処理
   - EventBridgeでフィルタリングして必要なイベントのみ処理

3. **複数宛先への配信**
   - SNSまたはEventBridgeを使用（重複したLambda実行を避ける）

## 5. まとめ

S3イベント通知から直接起動できるAWSリソースは、Lambda、SQS、SNS、EventBridgeの4つです。それぞれに特徴があり、ユースケースに応じて適切に選択することが重要です。

- **シンプルな処理**: Lambda
- **負荷平準化**: SQS
- **複数宛先への配信**: SNS
- **複雑なルーティング**: EventBridge

Step Functionsを含む他のAWSサービスを起動したい場合は、これらのサービスを経由する必要がありますが、それぞれの特性を理解して活用することで、スケーラブルで信頼性の高いイベント駆動型アーキテクチャを構築できます。