# 監視・ログ設計項目抽出結果

## 1. 抽出対象ファイル

以下のファイルから監視・ログに関する設計項目を抽出しました：

- `/home/naka/claude_code/2508_CSV_Batch/01_Document/03-01_詳細設計書_インフラ詳細設計.md`
- `/home/naka/claude_code/2508_CSV_Batch/01_Document/03-02_詳細設計書_Step Functions詳細設計.md`
- `/home/naka/claude_code/2508_CSV_Batch/01_Document/03-06_詳細設計書_CSV検証関数.md`
- `/home/naka/claude_code/2508_CSV_Batch/01_Document/03-07_詳細設計書_CSV分割関数.md`
- `/home/naka/claude_code/2508_CSV_Batch/01_Document/03-08_詳細設計書_エラーハンドリング関数.md`
- `/home/naka/claude_code/2508_CSV_Batch/01_Document/03-09_詳細設計書_チャンク処理関数.md`
- `/home/naka/claude_code/2508_CSV_Batch/01_Document/03-10_詳細設計書_結果集約関数.md`

## 2. CloudWatch Logs設定詳細

### 2.1 インフラレベルのログ設定

**Lambda関数共通のログ設定：**
```yaml
LoggingConfig:
  ApplicationLogLevel: INFO
  LogFormat: JSON
  LogGroup: !Sub '/aws/lambda/${AWS::StackName}-${FunctionName}'
  SystemLogLevel: INFO
```

**Step Functionsログ設定：**
```yaml
LoggingConfiguration:
  Level: ALL
  IncludeExecutionData: true
  Destinations:
    - CloudWatchLogsLogGroup:
        LogGroupArn: !GetAtt StepFunctionsLogGroup.Arn
```

### 2.2 Lambda関数別ロググループ

| 関数名 | ロググループ | 保持期間 |
|--------|--------------|----------|
| csv-validator | /aws/lambda/csv-validator | 30日 |
| csv-splitter | /aws/lambda/csv-splitter | 30日 |
| error-handler | /aws/lambda/error-handler | 14日 |
| csv-chunk-processor | /aws/lambda/csv-chunk-processor | 30日 |
| csv-result-aggregator | /aws/lambda/csv-result-aggregator | 30日 |

### 2.3 VPCフローログ設定

```yaml
VPCFlowLog:
  ResourceType: VPC
  ResourceId: !Ref CsvProcessingVPC
  TrafficType: ALL
  LogDestinationType: cloud-watch-logs
  LogGroupName: /aws/vpc/flowlogs
  DeliverLogsPermissionArn: !GetAtt FlowLogRole.Arn
```

## 3. メトリクス設定

### 3.1 Step Functions分散マップメトリクス

**カスタムメトリクス定義：**
```typescript
export const STEP_FUNCTIONS_METRICS = {
  ExecutionDuration: {
    namespace: 'CsvProcessing/StepFunctions',
    metricName: 'ExecutionDuration',
    unit: 'Milliseconds'
  },
  DistributedMapSuccess: {
    namespace: 'CsvProcessing/StepFunctions',
    metricName: 'DistributedMapSuccess',
    unit: 'Count'
  },
  DistributedMapFailures: {
    namespace: 'CsvProcessing/StepFunctions',
    metricName: 'DistributedMapFailures',
    unit: 'Count'
  },
  ConcurrentExecutions: {
    namespace: 'CsvProcessing/StepFunctions',
    metricName: 'ConcurrentExecutions',
    unit: 'Count'
  }
};
```

### 3.2 Lambda関数別メトリクス

**CSV検証関数メトリクス：**
```typescript
export const CSV_VALIDATOR_METRICS = {
  ValidationDuration: {
    namespace: 'CsvProcessing/Validator',
    metricName: 'ValidationDuration',
    unit: 'Milliseconds'
  },
  RowsValidated: {
    namespace: 'CsvProcessing/Validator',
    metricName: 'RowsValidated',
    unit: 'Count'
  },
  ValidationErrors: {
    namespace: 'CsvProcessing/Validator',
    metricName: 'ValidationErrors',
    unit: 'Count'
  },
  FileSizeProcessed: {
    namespace: 'CsvProcessing/Validator',
    metricName: 'FileSizeProcessed',
    unit: 'Bytes'
  }
};
```

**チャンク処理関数メトリクス：**
```typescript
export const USER_LOG_PROCESSOR_METRICS = {
  ProcessingDuration: {
    namespace: 'CsvProcessing/UserLogProcessor',
    metricName: 'ProcessingDuration',
    unit: 'Milliseconds'
  },
  RecordsProcessed: {
    namespace: 'CsvProcessing/UserLogProcessor',
    metricName: 'RecordsProcessed',
    unit: 'Count'
  },
  ProcessingErrors: {
    namespace: 'CsvProcessing/UserLogProcessor',
    metricName: 'ProcessingErrors',
    unit: 'Count'
  },
  DatabaseConnections: {
    namespace: 'CsvProcessing/UserLogProcessor',
    metricName: 'DatabaseConnections',
    unit: 'Count'
  },
  AuditLogWrites: {
    namespace: 'CsvProcessing/UserLogProcessor',
    metricName: 'AuditLogWrites',
    unit: 'Count'
  }
};
```

**結果集約関数メトリクス：**
```typescript
export const RESULT_AGGREGATOR_METRICS = {
  AggregationDuration: {
    namespace: 'CsvProcessing/ResultAggregator',
    metricName: 'AggregationDuration',
    unit: 'Milliseconds'
  },
  AggregatedRecords: {
    namespace: 'CsvProcessing/ResultAggregator',
    metricName: 'AggregatedRecords',
    unit: 'Count'
  },
  OverallSuccessRate: {
    namespace: 'CsvProcessing/ResultAggregator',
    metricName: 'OverallSuccessRate',
    unit: 'Percent'
  },
  GeneratedReports: {
    namespace: 'CsvProcessing/ResultAggregator',
    metricName: 'GeneratedReports',
    unit: 'Count'
  }
};
```

## 4. ログフォーマット・構造

### 4.1 共通ログフォーマット

**Step Functionsログ構造：**
```json
{
  "timestamp": "2025-01-15T10:30:00.000Z",
  "level": "INFO",
  "service": "step-functions",
  "executionName": "csv-processing-20250115-103000",
  "executionArn": "arn:aws:states:ap-northeast-1:123456789012:execution:csv-processing:csv-processing-20250115-103000",
  "stateName": "DistributedMap",
  "stateType": "Map",
  "message": "Distributed map processing started",
  "details": {
    "inputS3": {
      "bucket": "csv-processing-input",
      "key": "uploads/users_20250115.csv"
    },
    "mapConfig": {
      "maxConcurrency": 5,
      "itemBatchSize": 100
    }
  }
}
```

**Lambda関数ログ構造：**
```json
{
  "timestamp": "2025-01-15T10:30:00.000Z",
  "level": "INFO",
  "service": "csv-chunk-processor",
  "requestId": "12345678-1234-1234-1234-123456789012",
  "executionId": "csv-processing-20250115-103000",
  "batchId": "batch-001",
  "message": "User log processing started",
  "metadata": {
    "userId": "U00001",
    "recordsProcessed": 100,
    "dbOperations": 150,
    "processingTimeMs": 2500,
    "memoryUsed": 128,
    "error": {
      "type": "USER_NOT_FOUND",
      "message": "User U99999 does not exist",
      "stack": "..."
    }
  }
}
```

### 4.2 エラー詳細ログ構造

**エラー処理関数ログ：**
```json
{
  "timestamp": "2025-01-15T10:35:00.000Z",
  "level": "ERROR",
  "service": "error-handler",
  "errorCategory": "PROCESSING_ERROR",
  "executionId": "csv-processing-20250115-103000",
  "message": "Batch processing failed",
  "errorDetails": {
    "errorType": "DATABASE_CONNECTION_ERROR",
    "errorCode": "DB_CONN_TIMEOUT",
    "originalError": {
      "name": "ConnectionTimeoutError",
      "message": "Connection timeout after 5000ms",
      "stack": "..."
    },
    "context": {
      "batchId": "batch-003",
      "attemptNumber": 2,
      "retryable": true,
      "affectedRecords": 50
    },
    "resolution": {
      "action": "RETRY_WITH_BACKOFF",
      "nextRetryAt": "2025-01-15T10:36:00.000Z",
      "maxRetries": 3
    }
  }
}
```

## 5. 監視閾値・アラート設定

### 5.1 Step Functions監視

| アラート名 | メトリクス | 条件 | 閾値 | アクション |
|-----------|-----------|------|------|----------|
| StepFunctionsExecutionFailure | ExecutionsFailed | Sum | > 0 | 即時通知 |
| StepFunctionsLongExecution | ExecutionTime | Average | > 300秒 | 調査通知 |
| DistributedMapHighFailureRate | ExecutionsFailed/ExecutionsStarted | Percentage | > 10% | 即時調査 |

### 5.2 Lambda関数監視

| 関数名 | アラート名 | メトリクス | 閾値 | 重要度 |
|--------|-----------|-----------|------|--------|
| csv-validator | ValidationTimeout | Duration | > 25秒 | High |
| csv-validator | HighValidationErrors | ValidationErrors | > 100件 | Medium |
| csv-chunk-processor | ProcessingTimeout | Duration | > 25秒 | High |
| csv-chunk-processor | LowProcessingRate | RecordsProcessed/Duration | < 10件/秒 | Medium |
| csv-chunk-processor | DatabaseConnectionFailure | DatabaseConnections | = 0 | Critical |
| csv-result-aggregator | LowSuccessRate | OverallSuccessRate | < 90% | High |
| csv-result-aggregator | ReportGenerationFailure | GeneratedReports | = 0 | Critical |

### 5.3 インフラ監視

| リソース | アラート名 | メトリクス | 閾値 | アクション |
|----------|-----------|-----------|------|----------|
| Aurora Cluster | DatabaseConnections | DatabaseConnections | > 80% | スケール調査 |
| Aurora Cluster | CPUUtilization | CPUUtilization | > 80% | パフォーマンス調査 |
| DynamoDB | UserErrors | UserErrors | > 0 | 即時調査 |
| DynamoDB | ThrottledRequests | ThrottledRequests | > 0 | 容量増加検討 |
| S3 Bucket | 4xxErrors | 4xxErrors | > 10 | アクセス調査 |

## 6. ログ保持期間・アーカイブ設定

### 6.1 CloudWatch Logs保持期間

| ロググループ | 保持期間 | アーカイブ先 | アーカイブ条件 |
|-------------|----------|-------------|---------------|
| /aws/lambda/csv-validator | 30日 | S3 (logs/validator/) | 7日後 |
| /aws/lambda/csv-splitter | 30日 | S3 (logs/splitter/) | 7日後 |
| /aws/lambda/error-handler | 14日 | S3 (logs/error-handler/) | 3日後 |
| /aws/lambda/csv-chunk-processor | 30日 | S3 (logs/chunk-processor/) | 7日後 |
| /aws/lambda/csv-result-aggregator | 30日 | S3 (logs/result-aggregator/) | 7日後 |
| /aws/stepfunctions/csv-processing | 90日 | S3 (logs/stepfunctions/) | 30日後 |
| /aws/vpc/flowlogs | 7日 | S3 (logs/vpc-flow/) | 1日後 |

### 6.2 DynamoDB監査ログ保持設定

```typescript
// DynamoDB TTL設定（30日）
const auditLogTTL = Math.floor(Date.now() / 1000) + (30 * 24 * 60 * 60);

const auditLogItem = {
  PK: `EXECUTION#${executionId}`,
  SK: `BATCH#${batchId}#USER#${userId}#${timestamp}`,
  executionId: executionId,
  batchId: batchId,
  userId: userId,
  status: status,
  details: details,
  timestamp: timestamp,
  ttl: auditLogTTL // 30日後に自動削除
};
```

### 6.3 S3ログアーカイブライフサイクル

```yaml
LogArchiveBucket:
  Type: AWS::S3::Bucket
  Properties:
    BucketName: !Sub '${AWS::StackName}-log-archive'
    LifecycleConfiguration:
      Rules:
        - Id: LogArchiveLifecycle
          Status: Enabled
          Transitions:
            - StorageClass: STANDARD_IA
              TransitionInDays: 30
            - StorageClass: GLACIER
              TransitionInDays: 90
            - StorageClass: DEEP_ARCHIVE
              TransitionInDays: 365
          ExpirationInDays: 2555 # 7年保持
```

## 7. パフォーマンス監視項目

### 7.1 処理性能監視

**Step Functions分散マップ監視項目：**
- 総実行時間
- 並列実行数
- バッチ処理時間の分散
- 成功率・失敗率
- スループット（レコード/秒）

**Lambda関数監視項目：**
- 実行時間（平均・最大・最小）
- メモリ使用量
- 同時実行数
- エラー率
- リトライ回数

### 7.2 データベース監視項目

**Aurora PostgreSQL監視：**
- 接続数
- CPU使用率
- メモリ使用率
- ディスクI/O
- クエリ実行時間
- トランザクション数

**DynamoDB監視：**
- 読み込み/書き込み容量ユニット使用率
- スロットリング発生回数
- レスポンス時間
- エラー率

### 7.3 ダッシュボード監視項目

**リアルタイム監視ダッシュボード：**
```typescript
// ダッシュボードデータ構造
interface DashboardData {
  overview: {
    totalRecords: number;
    successRate: number;
    averageProcessingTime: number;
    throughput: number;
    status: 'SUCCESS' | 'WARNING' | 'ERROR';
  };
  performance: {
    processingTimeChart: ChartData;
    throughputChart: ChartData;
  };
  errors: {
    errorsByType: PieChartData;
    errorRate: GaugeData;
  };
  timeline: TimelineData[];
  recommendations: string[];
}
```

## 8. 監視アラート通知設定

### 8.1 通知チャネル設定

```yaml
# SNS Topic設定
CriticalAlertsTopicArn: 'arn:aws:sns:ap-northeast-1:123456789012:csv-processing-critical'
WarningAlertsTopicArn: 'arn:aws:sns:ap-northeast-1:123456789012:csv-processing-warning'

# CloudWatch Alarm Actions
AlarmActions:
  - !Ref CriticalAlertsTopic  # Critical: 即時通知
  - !Ref WarningAlertsTopic   # Warning: 集約通知
```

### 8.2 エスカレーション設定

| 重要度 | 初回通知 | 2回目通知 | 3回目通知 | 解決まで |
|--------|----------|----------|----------|----------|
| Critical | 即時 | 15分後 | 30分後 | 1時間毎 |
| High | 即時 | 30分後 | 1時間後 | 2時間毎 |
| Medium | 5分後 | 1時間後 | 4時間後 | 12時間毎 |
| Low | 30分後 | 4時間後 | 12時間後 | 24時間毎 |

## 9. ログ検索・分析設定

### 9.1 CloudWatch Insights クエリ例

**エラー分析クエリ：**
```sql
fields @timestamp, service, executionId, batchId, message, metadata.error
| filter level = "ERROR"
| stats count() by metadata.error.type
| sort count desc
```

**パフォーマンス分析クエリ：**
```sql
fields @timestamp, service, metadata.processingTimeMs, metadata.recordsProcessed
| filter service = "csv-chunk-processor"
| stats avg(metadata.processingTimeMs), avg(metadata.recordsProcessed) by bin(5m)
```

### 9.2 X-Rayトレーシング設定

```yaml
TracingConfig:
  Mode: Active
```

**分散トレーシング項目：**
- Step Functions実行フロー
- Lambda関数間連携
- データベース接続・クエリ実行
- S3読み込み・書き込み操作
- DynamoDB監査ログ書き込み

## 10. まとめ

### 10.1 監視項目優先度

| 優先度 | 監視項目カテゴリ | 主要項目 |
|--------|-----------------|----------|
| 1 | システム可用性 | Step Functions実行成功率、Lambda関数エラー率 |
| 2 | データ処理品質 | レコード処理成功率、データ整合性 |
| 3 | パフォーマンス | 処理時間、スループット、リソース使用率 |
| 4 | 運用効率 | ログ可読性、アラート精度、ダッシュボード活用 |

### 10.2 継続改善項目

- メトリクス閾値の定期見直し
- ログフォーマットの標準化推進
- ダッシュボード表示項目の最適化
- アラート通知の精度向上
- ログ保持期間・コストの最適化

この監視・ログ設計により、CSV並列処理システムの安定稼働と継続的な改善が可能になります。