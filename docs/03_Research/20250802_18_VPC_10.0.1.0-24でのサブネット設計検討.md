# VPC 10.0.1.0/24でのサブネット設計検討

## 1. 概要

VPCを10.0.1.0/24（256 IP）で構築する場合のサブネット分割設計を検討します。小規模システム向けの効率的なネットワーク設計を目指します。

## 2. 10.0.1.0/24 VPC基本情報

### 2.1 利用可能IPアドレス範囲
```
VPC CIDR: 10.0.1.0/24
├── ネットワークアドレス: 10.0.1.0
├── 利用可能IP範囲: 10.0.1.1 - 10.0.1.254 (254個)
└── ブロードキャストアドレス: 10.0.1.255

AWS予約IP（各サブネットで5個予約）:
- 10.0.1.0: ネットワークアドレス
- 10.0.1.1: VPCルーター用
- 10.0.1.2: DNS用
- 10.0.1.3: 将来利用用
- 10.0.1.255: ブロードキャスト用
```

### 2.2 サブネット分割オプション

#### オプション1: /26分割（4サブネット × 64 IP）
```
10.0.1.0/24 → 4つの/26サブネット

サブネット1: 10.0.1.0/26   (10.0.1.1   - 10.0.1.62)   → 59個利用可能
サブネット2: 10.0.1.64/26  (10.0.1.65  - 10.0.1.126)  → 59個利用可能  
サブネット3: 10.0.1.128/26 (10.0.1.129 - 10.0.1.190)  → 59個利用可能
サブネット4: 10.0.1.192/26 (10.0.1.193 - 10.0.1.254)  → 59個利用可能
```

#### オプション2: /27分割（8サブネット × 32 IP）
```
10.0.1.0/24 → 8つの/27サブネット

サブネット1: 10.0.1.0/27   (10.0.1.1   - 10.0.1.30)   → 27個利用可能
サブネット2: 10.0.1.32/27  (10.0.1.33  - 10.0.1.62)   → 27個利用可能
サブネット3: 10.0.1.64/27  (10.0.1.65  - 10.0.1.94)   → 27個利用可能
サブネット4: 10.0.1.96/27  (10.0.1.97  - 10.0.1.126)  → 27個利用可能
サブネット5: 10.0.1.128/27 (10.0.1.129 - 10.0.1.158)  → 27個利用可能
サブネット6: 10.0.1.160/27 (10.0.1.161 - 10.0.1.190)  → 27個利用可能
サブネット7: 10.0.1.192/27 (10.0.1.193 - 10.0.1.222)  → 27個利用可能
サブネット8: 10.0.1.224/27 (10.0.1.225 - 10.0.1.254)  → 27個利用可能
```

#### オプション3: /28分割（16サブネット × 16 IP）
```
10.0.1.0/24 → 16つの/28サブネット

サブネット1:  10.0.1.0/28   (10.0.1.1   - 10.0.1.14)   → 11個利用可能
サブネット2:  10.0.1.16/28  (10.0.1.17  - 10.0.1.30)   → 11個利用可能
サブネット3:  10.0.1.32/28  (10.0.1.33  - 10.0.1.46)   → 11個利用可能
サブネット4:  10.0.1.48/28  (10.0.1.49  - 10.0.1.62)   → 11個利用可能
...
サブネット16: 10.0.1.240/28 (10.0.1.241 - 10.0.1.254)  → 11個利用可能
```

## 3. CSVユーザーログ処理システム向け設計

### 3.1 システム要件再確認
- Aurora ServerlessV2（Primary + Reader）
- Lambda関数（VPC接続）
- VPCエンドポイント（S3、DynamoDB）
- NAT Gateway（インターネット接続用）
- 個人開発、小規模システム

### 3.2 推奨設計: /27分割（8サブネット）

#### 3.2.1 サブネット配置設計
```
VPC: 10.0.1.0/24

AZ: ap-northeast-1a
├── Private Subnet 1a: 10.0.1.0/27   (DB Primary + Lambda)
└── Public Subnet 1a:  10.0.1.32/27  (NAT Gateway)

AZ: ap-northeast-1c  
├── Private Subnet 1c: 10.0.1.64/27  (DB Reader + Lambda)
└── Public Subnet 1c:  10.0.1.96/27  (NAT Gateway Backup)

Reserved/Future:
├── Private Subnet 2a: 10.0.1.128/27 (将来拡張用)
├── Private Subnet 2c: 10.0.1.160/27 (将来拡張用)
├── Management Net:    10.0.1.192/27 (運用・管理用)
└── Spare:             10.0.1.224/27 (予備)
```

#### 3.2.2 各サブネットの詳細設計

##### Private Subnet 1a (10.0.1.0/27)
```
用途: Aurora Primary + Lambda Functions (AZ-1a)
CIDR: 10.0.1.0/27
利用可能IP: 10.0.1.1 - 10.0.1.30 (27個)

IP割り当て:
- 10.0.1.10: Aurora Primary固定IP
- 10.0.1.11-20: Lambda ENI用（10個確保）
- 10.0.1.21-30: 将来拡張用（10個確保）
```

##### Public Subnet 1a (10.0.1.32/27)
```
用途: NAT Gateway + Internet Gateway
CIDR: 10.0.1.32/27
利用可能IP: 10.0.1.33 - 10.0.1.62 (27個)

IP割り当て:
- 10.0.1.40: NAT Gateway固定IP
- 10.0.1.41-50: EIP用予備（10個確保）
- 10.0.1.51-62: 将来拡張用（12個確保）
```

##### Private Subnet 1c (10.0.1.64/27)
```
用途: Aurora Reader + Lambda Functions (AZ-1c)
CIDR: 10.0.1.64/27
利用可能IP: 10.0.1.65 - 10.0.1.94 (27個)

IP割り当て:
- 10.0.1.70: Aurora Reader固定IP
- 10.0.1.71-80: Lambda ENI用（10個確保）
- 10.0.1.81-94: 将来拡張用（14個確保）
```

##### Public Subnet 1c (10.0.1.96/27)
```
用途: NAT Gateway Backup (災害対策)
CIDR: 10.0.1.96/27
利用可能IP: 10.0.1.97 - 10.0.1.126 (27個)

IP割り当て:
- 10.0.1.100: NAT Gateway Backup固定IP
- 10.0.1.101-110: EIP用予備（10個確保）
- 10.0.1.111-126: 将来拡張用（16個確保）
```

### 3.3 ルートテーブル設計

#### 3.3.1 Private Route Tables
```
Private Route Table 1a:
├── 10.0.1.0/24 → Local
└── 0.0.0.0/0   → NAT Gateway 1a (10.0.1.40)

Private Route Table 1c:
├── 10.0.1.0/24 → Local  
└── 0.0.0.0/0   → NAT Gateway 1c (10.0.1.100)
```

#### 3.3.2 Public Route Tables
```
Public Route Table:
├── 10.0.1.0/24 → Local
└── 0.0.0.0/0   → Internet Gateway
```

### 3.4 VPCエンドポイント配置

#### 3.4.1 Gateway型エンドポイント
```
S3 Gateway Endpoint:
├── VPC: 10.0.1.0/24
├── Route Tables: Private Route Table 1a, 1c
└── Policy: CSV処理用S3バケットアクセス

DynamoDB Gateway Endpoint:
├── VPC: 10.0.1.0/24
├── Route Tables: Private Route Table 1a, 1c  
└── Policy: ProcessingLogsテーブルアクセス
```

#### 3.4.2 Interface型エンドポイント（必要時）
```
Lambda Interface Endpoint (オプション):
├── Subnets: Private Subnet 1a, 1c
├── IP: 10.0.1.15, 10.0.1.75
└── 用途: Step Functions → Lambda呼び出し最適化
```

## 4. 代替設計案の比較

### 4.1 /26分割案（4サブネット）

#### メリット
- 各サブネットに59個の豊富なIP
- 将来的な大規模拡張に対応
- 設計がシンプル

#### デメリット
- サブネット数が少ない（4個のみ）
- AZ分散の柔軟性が低い
- 小規模システムにはオーバースペック

#### 設計例
```
VPC: 10.0.1.0/24

├── Private Subnet 1a: 10.0.1.0/26   (Aurora Primary + Lambda)
├── Private Subnet 1c: 10.0.1.64/26  (Aurora Reader + Lambda) 
├── Public Subnet:     10.0.1.128/26 (NAT Gateway両AZ)
└── Reserved:          10.0.1.192/26 (将来拡張用)
```

### 4.2 /28分割案（16サブネット）

#### メリット
- 非常に細かい制御が可能
- マイクロサービス向け
- セキュリティゾーン分離

#### デメリット
- 各サブネットのIP数が少ない（11個）
- Lambdaスケーリング時にIP不足リスク
- 管理複雑性が高い

#### 設計例
```
VPC: 10.0.1.0/24

├── DB Primary Subnet:    10.0.1.0/28   (Aurora Primary専用)
├── DB Reader Subnet:     10.0.1.16/28  (Aurora Reader専用)
├── Lambda Subnet 1a:     10.0.1.32/28  (Lambda専用 AZ-1a)
├── Lambda Subnet 1c:     10.0.1.48/28  (Lambda専用 AZ-1c)
├── Public Subnet 1a:     10.0.1.64/28  (NAT Gateway AZ-1a)
├── Public Subnet 1c:     10.0.1.80/28  (NAT Gateway AZ-1c)
└── Management Subnets:   10.0.1.96/28 - 10.0.1.240/28 (10個予備)
```

## 5. 推奨設計の詳細実装

### 5.1 CloudFormationテンプレート例

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: 'CSV Processing System VPC - 10.0.1.0/24'

Resources:
  # VPC
  MainVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.1.0/24
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: csv-processing-vpc

  # Private Subnets
  PrivateSubnet1a:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MainVPC
      CidrBlock: 10.0.1.0/27
      AvailabilityZone: ap-northeast-1a
      Tags:
        - Key: Name
          Value: Private-1a-DB-Lambda

  PrivateSubnet1c:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MainVPC
      CidrBlock: 10.0.1.64/27
      AvailabilityZone: ap-northeast-1c
      Tags:
        - Key: Name
          Value: Private-1c-DB-Lambda

  # Public Subnets
  PublicSubnet1a:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MainVPC
      CidrBlock: 10.0.1.32/27
      AvailabilityZone: ap-northeast-1a
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public-1a-NAT

  PublicSubnet1c:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MainVPC
      CidrBlock: 10.0.1.96/27
      AvailabilityZone: ap-northeast-1c
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Public-1c-NAT

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: csv-processing-igw

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref MainVPC
      InternetGatewayId: !Ref InternetGateway

  # NAT Gateways
  NATGateway1a:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIP1a.AllocationId
      SubnetId: !Ref PublicSubnet1a
      Tags:
        - Key: Name
          Value: NAT-1a

  EIP1a:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: NAT-EIP-1a

  NATGateway1c:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIP1c.AllocationId
      SubnetId: !Ref PublicSubnet1c
      Tags:
        - Key: Name
          Value: NAT-1c

  EIP1c:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: NAT-EIP-1c
```

### 5.2 セキュリティグループ設計

```yaml
  # Aurora Security Group
  AuroraSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Aurora PostgreSQL Security Group
      VpcId: !Ref MainVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: Lambda to Aurora
      Tags:
        - Key: Name
          Value: aurora-sg

  # Lambda Security Group  
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Lambda Functions Security Group
      VpcId: !Ref MainVPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          DestinationSecurityGroupId: !Ref AuroraSecurityGroup
          Description: Lambda to Aurora
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS outbound
      Tags:
        - Key: Name
          Value: lambda-sg
```

## 6. 運用考慮事項

### 6.1 IP使用量監視

```python
# IP使用量監視スクリプト
def monitor_ip_usage():
    subnets = {
        '10.0.1.0/27': 'Private-1a',
        '10.0.1.32/27': 'Public-1a', 
        '10.0.1.64/27': 'Private-1c',
        '10.0.1.96/27': 'Public-1c'
    }
    
    for cidr, name in subnets.items():
        available_ips = get_available_ips(cidr)
        used_ips = 27 - available_ips
        usage_rate = (used_ips / 27) * 100
        
        print(f"{name}: {used_ips}/27 used ({usage_rate:.1f}%)")
        
        if usage_rate > 80:
            send_alert(f"IP usage high in {name}: {usage_rate:.1f}%")
```

### 6.2 拡張シナリオ

#### シナリオ1: Lambda同時実行数増加
```
現在の設計: Private Subnet各27個IP
最大Lambda ENI: 10個/AZ = 20個総計
Lambda同時実行: 約100-200並列対応

拡張時の対応:
1. 使用していない/27サブネット（10.0.1.128/27）を追加
2. Lambda ENI数を増加
3. 必要時は/26に再設計
```

#### シナリオ2: Aurora接続数増加
```
現在の設計: Aurora専用IP確保済み
接続プール: Lambda → Aurora ServerlessV2

拡張時の対応:
1. Aurora ProxyやPgBouncerの導入検討
2. Auroraの追加エンドポイント作成
3. 接続プール最適化
```

### 6.3 コスト効率性

```
VPC 10.0.1.0/24の月間コスト:
├── NAT Gateway: $45/月 × 2AZ = $90/月
├── EIP: $3.6/月 × 2個 = $7.2/月  
├── VPCエンドポイント: $7.2/月 × 2個 = $14.4/月
└── 合計: 約$112/月

コスト削減オプション:
├── NAT Gateway 1つのみ: $45/月削減
├── S3/DynamoDB Endpointのみ: Interface EP削減
└── 開発時のNAT停止: 夜間・週末停止で30%削減
```

## 7. まとめ

### 7.1 推奨設計: /27分割
- **VPC**: 10.0.1.0/24
- **サブネット**: 8つの/27サブネット
- **構成**: 2AZ × (Private + Public) + 4予備
- **IP効率**: 各サブネット27個、適度な拡張性

### 7.2 この設計の利点
1. **適度なサイズ**: 小規模システムに最適
2. **AZ冗長性**: 2AZ分散で高可用性
3. **拡張性**: 4つの予備サブネットで将来対応
4. **運用性**: 管理しやすいサブネット数
5. **コスト効率**: 無駄のないIP配分

### 7.3 注意点
- Lambda大規模スケーリング時のIP不足監視が必要
- 将来的な要件変更時は/26への再設計を検討
- NAT Gateway冗長化によるコスト増加

この設計により、CSVユーザーログ処理システムに最適なネットワーク環境を効率的に構築できます。