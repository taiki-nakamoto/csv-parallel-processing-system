# 設計書修正ポイント洗い出し

## 1. 概要

以下の2つの調査結果に基づいて、01_Document配下の基本設計書（02_*）と詳細設計書（03_*）の修正ポイントを洗い出します。

### 参考ドキュメント
- **20250804_03_Lambda開発標準仕様書_アーキテクチャ分析.md**: DIP適用レイヤードアーキテクチャ
- **20250804_02_SAM拡張性ディレクトリ構成設計.md**: AWS SAMとTerraformを前提とした構成

### 修正の基本方針
1. **DIP適用**: 依存性逆転の原則に基づくレイヤードアーキテクチャに変更
2. **Lambda統合**: 複数Lambda関数を1つのLambda関数に統合
3. **SAM構成**: AWS SAMを前提としたディレクトリ構成に変更
4. **Terraform連携**: Terraformでインフラ管理、SAMでLambda管理の分離

## 2. 修正対象ドキュメント一覧

### 2.1 基本設計書（02_*）
1. **02-01_基本設計書_Lambda開発標準仕様書.md** 🔴 **大幅修正**
2. **02-02_基本設計書_Lambda関数基本設計.md** 🔴 **大幅修正**
3. **02-03_基本設計書_EventBridgeルール基本設計.md** 🟡 **一部修正**
4. **02-04_基本設計書_Step Functions基本設計.md** 🟡 **一部修正**
5. **02-05_基本設計書_S3バケット設計.md** 🟢 **軽微修正**
6. **02-06_基本設計書_監視・ログ設計.md** 🟡 **一部修正**
7. **02-07_基本設計書_エラーハンドリング基本設計.md** 🟡 **一部修正**
8. **02-08_基本設計書_ソース管理設計.md** 🔴 **大幅修正**
9. **02-09_基本設計書_CI-CD設計書.md** 🔴 **大幅修正**
10. **02-10_基本設計書_命名規則ガイドライン.md** 🟡 **一部修正**

### 2.2 詳細設計書（03_*）
1. **03-01_詳細設計書_インフラ詳細設計.md** 🟡 **一部修正**
2. **03-02_詳細設計書_Step Functions詳細設計.md** 🟡 **一部修正**
3. **03-03_詳細設計書_エラー処理フロー詳細設計.md** 🟡 **一部修正**
4. **03-04_詳細設計書_再試行設定詳細設計.md** 🟢 **軽微修正**
5. **03-05_詳細設計書_分散マップ詳細設計.md** 🟡 **一部修正**
6. **03-06_詳細設計書_CSV検証関数.md** 🔴 **大幅修正**
7. **03-07_詳細設計書_CSV分割関数.md** 🔴 **削除または統合**
8. **03-08_詳細設計書_エラーハンドリング関数.md** 🔴 **大幅修正**
9. **03-09_詳細設計書_チャンク処理関数.md** 🔴 **大幅修正**
10. **03-10_詳細設計書_結果集約関数.md** 🔴 **大幅修正**
11. **03-11_詳細設計書_セキュリティ詳細設計.md** 🟢 **軽微修正**

## 3. 詳細修正ポイント

### 3.1 【最優先】02-01_基本設計書_Lambda開発標準仕様書.md

#### 現在の問題点
- インターフェースがRepositories層に定義されている
- 通常のレイヤードアーキテクチャ（DIP未適用）
- CDK前提の記述

#### 修正内容
```diff
# レイヤー構成の変更
- src/
-   ├── handlers/
-   ├── services/
-   ├── repositories/      # インターフェース定義場所が間違い
-   ├── models/
-   ├── infrastructure/
-   └── shared/

+ src/
+   ├── handlers/           # Presentation Layer
+   ├── services/          # Application Service Layer
+   ├── domain/            # Domain Layer（新設）
+   │   ├── models/        # ドメインモデル
+   │   ├── interfaces/    # ドメインインターフェース
+   │   └── services/      # ドメインサービス
+   ├── infrastructure/    # Infrastructure Layer
+   │   ├── repositories/ # 実装（ドメインに依存）
+   │   └── aws/
+   └── shared/
```

#### 実装例の変更
```typescript
// 修正前（問題のあるパターン）
// repositories/IUserRepository.ts でインターフェース定義

// 修正後（DIP適用）
// domain/interfaces/IUserRepository.ts でインターフェース定義
// infrastructure/repositories/UserRepository.ts で実装
```

#### 開発環境の変更
```diff
- 開発環境: AWS CDK前提
+ 開発環境: AWS SAM + Terraform前提
- デプロイ: CDK Deploy
+ デプロイ: SAM Deploy（Lambda）+ Terraform Apply（インフラ）
```

### 3.2 【最優先】02-02_基本設計書_Lambda関数基本設計.md

#### 現在の問題点
- 複数のLambda関数として設計（csv-validator、user-log-processor）
- 各関数が独立したアーキテクチャ

#### 修正内容
```diff
# Lambda関数構成の変更
- csv-validator（CSV検証関数）
- user-log-processor（ユーザーログ処理関数）

+ csv-processor（統合Lambda関数）
+   ├── CSV検証機能
+   ├── チャンク処理機能
+   ├── 監査ログ機能
+   ├── 結果集約機能
+   └── エラーハンドリング機能
```

#### 関数内部構成の変更
```typescript
// 修正前: 独立したLambda関数
export const csvValidatorHandler = async (event, context) => {
  // CSV検証のみ
};

export const userLogProcessorHandler = async (event, context) => {
  // ユーザーログ処理のみ
};

// 修正後: 統合Lambda関数
export const csvProcessorHandler = async (event, context) => {
  const eventType = EventParser.parseEventType(event);
  
  switch (eventType) {
    case 'CSV_VALIDATION':
      return await validationController.validate(event);
    case 'CSV_CHUNK_PROCESSING':
      return await processingController.processChunk(event);
    case 'AUDIT_LOGGING':
      return await auditController.logAudit(event);
    // ...
  }
};
```

### 3.3 【重要】02-08_基本設計書_ソース管理設計.md

#### 現在の問題点
- CDK前提のディレクトリ構成
- モノレポでもSAM構成を考慮していない

#### 修正内容
```diff
# リポジトリ構成の変更
csv-parallel-processing-system/
├── .github/
- ├── infrastructure/          # CDK Infrastructure
- │   ├── lib/
- │   ├── bin/
- │   └── test/
- ├── lambda/                  # Lambda Functions
- │   ├── csv-validator/
- │   ├── user-log-processor/
- │   └── shared/

+ ├── terraform/               # Terraform Infrastructure
+ │   ├── environments/
+ │   ├── modules/
+ │   └── outputs.tf
+ ├── sam/                     # SAM Lambda Functions
+ │   ├── template.yaml
+ │   ├── src/
+ │   │   ├── functions/
+ │   │   │   └── csv-processor/  # 統合Lambda関数
+ │   │   ├── layers/
+ │   │   └── shared/
+ │   └── tests/
+ ├── scripts/                 # デプロイスクリプト
```

### 3.4 【重要】02-09_基本設計書_CI-CD設計書.md

#### 現在の問題点
- CDK Deploy中心のパイプライン
- Lambda関数の個別デプロイ

#### 修正内容
```diff
# CI/CDパイプラインの変更
- CDK Deploy（All-in-One）
+ 段階的デプロイ：
+   1. Terraform Apply（インフラ）
+   2. SAM Deploy（Lambda）
+   3. Terraform Apply（Lambda ARN更新）

# デプロイフロー
- GitHub Actions → AWS CodePipeline → CDK Deploy
+ GitHub Actions → AWS CodePipeline → 
+   1. Terraform Plan/Apply
+   2. SAM Build/Deploy
+   3. Integration Test
```

### 3.5 【重要】03-06〜03-10_詳細設計書_各Lambda関数.md

#### 現在の問題点
- 各機能が独立したLambda関数として設計
- 機能間の連携が複雑

#### 修正内容
```diff
# ドキュメント統合
- 03-06_詳細設計書_CSV検証関数.md
- 03-07_詳細設計書_CSV分割関数.md
- 03-08_詳細設計書_エラーハンドリング関数.md
- 03-09_詳細設計書_チャンク処理関数.md
- 03-10_詳細設計書_結果集約関数.md

+ 03-06_詳細設計書_CSV統合処理関数.md
+   ├── CSV検証機能詳細設計
+   ├── チャンク処理機能詳細設計
+   ├── 監査ログ機能詳細設計
+   ├── 結果集約機能詳細設計
+   └── エラーハンドリング機能詳細設計
```

#### 内部アーキテクチャの変更
```typescript
// 修正前: 独立した関数設計
// CSV検証関数、チャンク処理関数、エラーハンドリング関数...

// 修正後: 統合関数内での機能分離（DIP適用）
functions/csv-processor/
├── controllers/          # Presentation Layer
│   ├── validation-controller.ts
│   ├── processing-controller.ts
│   └── error-controller.ts
├── services/            # Application Service Layer
│   ├── csv-validation-service.ts
│   └── user-processing-service.ts
├── domain/              # Domain Layer
│   ├── models/
│   │   ├── User.ts
│   │   └── ValidationResult.ts
│   └── interfaces/      # ドメインインターフェース
│       ├── IUserRepository.ts
│       └── IS3Repository.ts
└── infrastructure/      # Infrastructure Layer
    └── repositories/    # 実装
        ├── UserRepository.ts
        └── S3Repository.ts
```

## 4. 修正優先度とロードマップ

### 4.1 Phase 1: アーキテクチャ基盤（高優先度）
1. ✅ **02-01_Lambda開発標準仕様書.md**: DIP適用アーキテクチャ
2. ✅ **02-02_Lambda関数基本設計.md**: 統合Lambda関数設計
3. ✅ **02-08_ソース管理設計.md**: SAM+Terraform構成

### 4.2 Phase 2: デプロイメント（高優先度）
1. ✅ **02-09_CI-CD設計書.md**: SAM+Terraformデプロイパイプライン
2. ✅ **03-01_インフラ詳細設計.md**: Terraform構成への更新

### 4.3 Phase 3: 機能統合（中優先度）
1. ✅ **03-06〜03-10_各Lambda関数.md**: 統合関数詳細設計
2. ✅ **02-04_Step Functions基本設計.md**: 統合Lambda対応
3. ✅ **02-07_エラーハンドリング基本設計.md**: 統合エラー処理

### 4.4 Phase 4: 周辺機能（低優先度）
1. **02-03_EventBridgeルール基本設計.md**: 軽微な更新
2. **02-06_監視・ログ設計.md**: 統合Lambda監視設計
3. **02-10_命名規則ガイドライン.md**: SAM構成対応

## 5. 具体的な作業手順

### 5.1 修正作業の流れ
1. **Phase 1実行**: アーキテクチャ基盤ドキュメントの修正
2. **整合性確認**: 修正したドキュメント間の整合性チェック
3. **Phase 2実行**: デプロイメント関連ドキュメントの修正
4. **統合テスト**: 全体設計の整合性確認
5. **Phase 3実行**: 機能統合ドキュメントの修正
6. **最終チェック**: 要件定義書との整合性確認

### 5.2 各Phaseでの成果物確認
- **Phase 1完了時**: DIP適用+統合Lambda+SAM構成の基本設計確立
- **Phase 2完了時**: 実装可能なデプロイメント設計完成
- **Phase 3完了時**: 詳細実装レベルでの設計完成
- **Phase 4完了時**: 運用まで含めた全体設計完成

### 5.3 注意事項
1. **要件定義書は変更しない**: 01-01、01-02は現在の要件を満たす範囲で実装方法のみ変更
2. **段階的な修正**: 一度に全ドキュメントを修正せず、Phase単位で進める
3. **整合性の維持**: 修正したドキュメント間で矛盾が生じないよう注意
4. **実装可能性の確保**: 理論的な設計に留まらず、実装可能な設計とする

## 6. 期待される効果

### 6.1 アーキテクチャ改善効果
- **テスタビリティ向上**: DIP適用によるモック化の容易さ
- **保守性向上**: 関心の分離による影響範囲の限定
- **拡張性向上**: 新機能追加時の既存コードへの影響最小化

### 6.2 運用改善効果
- **デプロイ効率化**: SAM+Terraformによる適材適所のツール活用
- **コスト削減**: 統合Lambda関数による実行コスト削減
- **管理効率化**: 単一Lambda関数による運用管理の簡素化

### 6.3 開発効率改善効果
- **開発環境統一**: SAM CLIによるローカル開発環境の標準化
- **CI/CD最適化**: 機能別のテスト・デプロイ戦略
- **ドキュメント整理**: 設計書の整合性向上と保守性確保

この修正により、理論的に優れた設計と実装・運用面での効率性を両立したシステム設計が実現できます。