# ローカル開発環境AWS代替サービス調査

## 1. 調査概要

### 1.1 目的
CSVファイル並列処理システムの開発において、以下のAWSサービスをローカル環境（Docker）で再現するための代替手段を調査する。

### 1.2 調査対象サービス
- S3 → MinIO
- EventBridge → AWS SAM or 代替手段
- Step Functions → AWS SAM or 代替手段
- Lambda → AWS SAM
- DynamoDB → AWS SAM
- Aurora → PostgreSQL

### 1.3 調査結果サマリー

| AWSサービス | ローカル代替手段 | 推奨度 | 主な特徴 |
|-------------|------------------|--------|----------|
| S3 | MinIO | ⭐⭐⭐⭐⭐ | 高いS3 API互換性、Dockerで簡単構築 |
| EventBridge | LocalStack | ⭐⭐⭐⭐ | SAM非対応、LocalStackで高機能 |
| Step Functions | LocalStack | ⭐⭐⭐ | SAM限定的、LocalStackが実用的 |
| Lambda | AWS SAM Local | ⭐⭐⭐⭐⭐ | 公式サポート、Docker統合優秀 |
| DynamoDB | DynamoDB Local | ⭐⭐⭐⭐⭐ | AWS公式、SAM統合良好 |
| Aurora | PostgreSQL + local-data-api | ⭐⭐⭐⭐ | Data API対応、Serverless模擬可能 |

## 2. S3 → MinIO

### 2.1 概要
MinIOは高いS3 API互換性を持つオブジェクトストレージソリューション。

### 2.2 Docker構成例
```yaml
# docker-compose.yml
version: '3.8'
services:
  minio:
    image: minio/minio:latest
    container_name: csv-minio
    ports:
      - "9000:9000"     # API
      - "9001:9001"     # Console
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: admin123456
      MINIO_DEFAULT_BUCKETS: csv-input-files,csv-processed-files,csv-error-files
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

volumes:
  minio_data:
```

### 2.3 S3 API互換性
#### 対応機能
- ✅ バケット操作（作成、削除、一覧）
- ✅ オブジェクト操作（PUT、GET、DELETE）
- ✅ プリサインドURL
- ✅ Multipart Upload
- ✅ CORS設定
- ✅ バケットポリシー
- ✅ イベント通知（Webhook、MQTT、AMQP）

#### 制限事項
- ❌ S3バージョニング（シングルサーバーモード）
- ❌ オブジェクトロック
- ❌ Cross-Region Replication
- ❌ S3 Select（一部制限）

### 2.4 設定方法
```bash
# バケット作成とポリシー設定
docker exec csv-minio mc alias set local http://localhost:9000 admin admin123456
docker exec csv-minio mc mb local/csv-input-files
docker exec csv-minio mc mb local/csv-processed-files
docker exec csv-minio mc mb local/csv-error-files

# 匿名読み取り許可
docker exec csv-minio mc anonymous set public local/csv-processed-files
```

## 3. EventBridge

### 3.1 AWS SAM Local対応状況
- ❌ **AWS SAM Local**: EventBridge直接サポートなし
- ⚠️ SAMでは`Events`プロパティでEventBridge Ruleは定義可能だが、ローカル実行不可

### 3.2 推奨代替手段: LocalStack
LocalStackはEventBridge APIを包括的にサポート。

#### Docker構成
```yaml
services:
  localstack:
    image: localstack/localstack:3.0
    container_name: csv-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=events,stepfunctions,lambda,dynamodb,s3
      - DEBUG=1
      - PERSISTENCE=1
      - LAMBDA_EXECUTOR=docker
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - ./localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
```

#### EventBridge機能対応
- ✅ カスタムイベントバス
- ✅ ルールとターゲット
- ✅ イベントパターンマッチング
- ✅ Lambda、Step Functions連携
- ⚠️ EventBridge Pipes（入力変換、同時実行数制限あり）

#### 使用例
```bash
# イベントルール作成
aws --endpoint-url=http://localhost:4566 events put-rule \
  --name csv-processing-rule \
  --event-pattern '{"source":["aws.s3"],"detail-type":["Object Created"]}'

# Lambda関数をターゲット設定
aws --endpoint-url=http://localhost:4566 events put-targets \
  --rule csv-processing-rule \
  --targets "Id"="1","Arn"="arn:aws:lambda:us-east-1:000000000000:function:csv-processor"
```

### 3.3 軽量代替手段: カスタムEventBridge
```typescript
// local-eventbridge.ts
interface EventBridgeEvent {
  source: string;
  'detail-type': string;
  detail: any;
}

class LocalEventBridge {
  private rules: Map<string, Function[]> = new Map();

  putRule(pattern: string, handler: Function) {
    if (!this.rules.has(pattern)) {
      this.rules.set(pattern, []);
    }
    this.rules.get(pattern)!.push(handler);
  }

  putEvent(event: EventBridgeEvent) {
    this.rules.forEach((handlers, pattern) => {
      if (this.matchPattern(event, pattern)) {
        handlers.forEach(handler => handler(event));
      }
    });
  }
}
```

## 4. Step Functions

### 4.1 AWS SAM Local対応状況
- ⚠️ **限定的サポート**: 基本的な状態遷移のみ
- ❌ **分散マップ**: サポートなし
- ❌ **複雑なASL**: 一部機能制限
- ❌ **AWS公式Step Functions Local**: 2024年現在「unsupported」マーク

### 4.2 推奨代替手段: LocalStack
LocalStackのStep Functions実装が最も実用的。

#### 2024年新機能
- ✅ JSONata式サポート
- ✅ 変数（Variables）機能
- ✅ 分散マップ（Distributed Map）基本サポート
- ✅ Express Workflow
- ✅ Standard Workflow

#### 使用例
```bash
# ステートマシン作成
aws --endpoint-url=http://localhost:4566 stepfunctions create-state-machine \
  --name csv-processing-workflow \
  --definition file://state-machine.json \
  --role-arn arn:aws:iam::000000000000:role/StepFunctionsRole

# 実行開始
aws --endpoint-url=http://localhost:4566 stepfunctions start-execution \
  --state-machine-arn arn:aws:states:us-east-1:000000000000:stateMachine:csv-processing-workflow \
  --name execution-1 \
  --input '{"inputFile": "test.csv"}'
```

#### ASL例（分散マップ対応）
```json
{
  "Comment": "CSV Parallel Processing with Distributed Map",
  "StartAt": "DistributedMap",
  "States": {
    "DistributedMap": {
      "Type": "Map",
      "ItemProcessor": {
        "ProcessorConfig": {
          "Mode": "DISTRIBUTED",
          "ExecutionType": "EXPRESS"
        },
        "StartAt": "ProcessChunk",
        "States": {
          "ProcessChunk": {
            "Type": "Task",
            "Resource": "arn:aws:lambda:us-east-1:000000000000:function:csv-processor",
            "End": true
          }
        }
      },
      "ItemsPath": "$.chunks",
      "End": true
    }
  }
}
```

### 4.3 制限事項
- ⚠️ LocalStack Pro機能（一部高度な機能）
- ⚠️ AWS Step Functions固有の最適化なし
- ⚠️ 完全な分散マップパフォーマンス再現不可

## 5. Lambda → AWS SAM Local

### 5.1 概要
AWS SAM LocalはLambda開発において最も優秀なローカル環境。

### 5.2 主要機能
#### 2024年新機能
- ✅ コンテナイメージサポート（最大10GB）
- ✅ アーキテクチャ固有ビルド（x86_64/arm64）
- ✅ Terraform連携強化
- ✅ 改良されたホットリロード

#### SAMコマンド例
```bash
# ローカル関数実行
sam local invoke csv-processor --event events/s3-event.json

# APIゲートウェイ模擬
sam local start-api --port 3000

# Lambda実行環境模擬
sam local start-lambda --port 3001
```

### 5.3 Docker統合
```yaml
# template.yaml抜粋
Resources:
  CsvProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: index.handler
      Runtime: nodejs18.x
      Environment:
        Variables:
          DYNAMODB_ENDPOINT: http://dynamodb:8000
          S3_ENDPOINT: http://minio:9000
      Events:
        S3Event:
          Type: S3
          Properties:
            Bucket: !Ref S3Bucket
            Events: s3:ObjectCreated:*
```

### 5.4 制限事項
- ⚠️ イベントソースが実際のAWSと異なる場合がある
- ⚠️ VPC設定の完全な再現不可
- ⚠️ IAMロール・ポリシーの実際の動作と差異

## 6. DynamoDB → DynamoDB Local

### 6.1 概要
Amazon DynamoDB LocalはAWS公式のローカル開発ツール。

### 6.2 Docker構成
```yaml
services:
  dynamodb:
    image: amazon/dynamodb-local:2.0.0
    container_name: csv-dynamodb
    ports:
      - "8000:8000"
    environment:
      - JAVA_OPTS=-Xmx1G
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb", "-inMemory", "-port", "8000"]
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/shell/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
```

### 5.3 SAM統合
```yaml
# samconfig.toml
[default.local_start_api.parameters]
docker_network = "csv-local-network"

[default.local_start_lambda.parameters]
docker_network = "csv-local-network"
```

#### ネットワーク設定
```bash
# Docker カスタムネットワーク作成
docker network create csv-local-network

# DynamoDBをネットワークに接続
docker run --network csv-local-network --name csv-dynamodb -p 8000:8000 amazon/dynamodb-local
```

### 6.4 テーブル初期化
```bash
# テーブル作成
aws dynamodb create-table \
  --endpoint-url http://localhost:8000 \
  --table-name csv_audit_logs \
  --attribute-definitions \
    AttributeName=execution_id,AttributeType=S \
    AttributeName=timestamp,AttributeType=S \
  --key-schema \
    AttributeName=execution_id,KeyType=HASH \
    AttributeName=timestamp,KeyType=RANGE \
  --billing-mode PAY_PER_REQUEST
```

### 6.5 2024年新機能
- ✅ インメモリモード（高速化）
- ✅ Java 17サポート
- ✅ パフォーマンス改善

## 7. Aurora → PostgreSQL + local-data-api

### 7.1 概要
Aurora ServerlessのData APIをローカルで模擬するソリューション。

### 7.2 Docker Compose構成
```yaml
services:
  postgres:
    image: postgres:15-alpine
    container_name: csv-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: csv_processing
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  local-data-api:
    image: koxudaxi/local-data-api:latest
    container_name: csv-data-api
    ports:
      - "8080:80"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: csv_processing
      RESOURCE_ARN: 'arn:aws:rds:us-east-1:123456789012:cluster:csv-cluster'
      SECRET_ARN: 'arn:aws:secretsmanager:us-east-1:123456789012:secret:csv-secret'
    depends_on:
      - postgres

volumes:
  postgres_data:
```

### 7.3 Data API使用例
```typescript
// Aurora Data API互換の使用方法
import { RDSDataClient, ExecuteStatementCommand } from '@aws-sdk/client-rds-data';

const client = new RDSDataClient({
  endpoint: 'http://localhost:8080',
  region: 'us-east-1',
  credentials: {
    accessKeyId: 'test',
    secretAccessKey: 'test'
  }
});

const command = new ExecuteStatementCommand({
  resourceArn: 'arn:aws:rds:us-east-1:123456789012:cluster:csv-cluster',
  secretArn: 'arn:aws:secretsmanager:us-east-1:123456789012:secret:csv-secret',
  database: 'csv_processing',
  sql: 'SELECT * FROM processing_jobs WHERE status = :status',
  parameters: [
    {
      name: 'status',
      value: { stringValue: 'processing' }
    }
  ]
});

const result = await client.send(command);
```

### 7.4 初期化スクリプト例
```sql
-- init.sql
CREATE TABLE processing_jobs (
    id SERIAL PRIMARY KEY,
    execution_id VARCHAR(255) NOT NULL,
    file_name VARCHAR(500) NOT NULL,
    total_records INTEGER,
    processed_records INTEGER DEFAULT 0,
    error_records INTEGER DEFAULT 0,
    status VARCHAR(50) DEFAULT 'pending',
    started_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_processing_jobs_execution_id ON processing_jobs(execution_id);
CREATE INDEX idx_processing_jobs_status ON processing_jobs(status);
```

### 7.5 Aurora Serverless v2との違い
- ❌ Scale-to-zero機能なし（2024年現在Aurora Serverless v2も非対応）
- ❌ 自動スケーリング機能なし
- ✅ Data API完全互換
- ✅ PostgreSQL標準機能すべて使用可能

## 8. 統合Docker Compose構成

### 8.1 全サービス統合例
```yaml
version: '3.8'
services:
  # S3代替: MinIO
  minio:
    image: minio/minio:latest
    container_name: csv-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: admin123456
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - csv-local-network

  # EventBridge + Step Functions代替: LocalStack
  localstack:
    image: localstack/localstack:3.0
    container_name: csv-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=events,stepfunctions,lambda,s3
      - DEBUG=1
      - PERSISTENCE=1
      - LAMBDA_EXECUTOR=docker
    volumes:
      - ./localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - csv-local-network

  # DynamoDB Local
  dynamodb:
    image: amazon/dynamodb-local:2.0.0
    container_name: csv-dynamodb
    ports:
      - "8000:8000"
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb", "-inMemory", "-port", "8000"]
    networks:
      - csv-local-network

  # Aurora代替: PostgreSQL
  postgres:
    image: postgres:15-alpine
    container_name: csv-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: csv_processing
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - csv-local-network

  # Aurora Data API代替
  local-data-api:
    image: koxudaxi/local-data-api:latest
    container_name: csv-data-api
    ports:
      - "8080:80"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: csv_processing
      RESOURCE_ARN: 'arn:aws:rds:us-east-1:123456789012:cluster:csv-cluster'
      SECRET_ARN: 'arn:aws:secretsmanager:us-east-1:123456789012:secret:csv-secret'
    depends_on:
      - postgres
    networks:
      - csv-local-network

volumes:
  minio_data:
  postgres_data:

networks:
  csv-local-network:
    driver: bridge
```

### 8.2 SAM統合設定
```toml
# samconfig.toml
[default.local_start_api.parameters]
docker_network = "csv-local-network"
env_vars = "env.json"

[default.local_start_lambda.parameters]
docker_network = "csv-local-network"
env_vars = "env.json"

[default.local_invoke.parameters]
docker_network = "csv-local-network"
env_vars = "env.json"
```

```json
// env.json
{
  "CsvProcessorFunction": {
    "S3_ENDPOINT": "http://minio:9000",
    "DYNAMODB_ENDPOINT": "http://dynamodb:8000",
    "POSTGRES_ENDPOINT": "http://local-data-api:80",
    "EVENTBRIDGE_ENDPOINT": "http://localstack:4566",
    "STEPFUNCTIONS_ENDPOINT": "http://localstack:4566"
  }
}
```

## 9. 開発ワークフロー

### 9.1 起動手順
```bash
# 1. Docker Compose起動
docker-compose up -d

# 2. MinIOバケット初期化
./scripts/init-minio.sh

# 3. DynamDBテーブル作成
./scripts/init-dynamodb.sh

# 4. PostgreSQL初期データ投入
./scripts/init-postgres.sh

# 5. LocalStack EventBridge/Step Functions設定
./scripts/init-localstack.sh

# 6. SAM Lambda起動
sam local start-api --docker-network csv-local-network
```

### 9.2 テスト実行
```bash
# Lambda単体テスト
sam local invoke csv-processor --event events/s3-create-event.json --docker-network csv-local-network

# API経由テスト
curl -X POST http://localhost:3000/api/process \
  -H "Content-Type: application/json" \
  -d '{"bucket": "csv-input-files", "key": "test.csv"}'

# Step Functions実行テスト
aws --endpoint-url=http://localhost:4566 stepfunctions start-execution \
  --state-machine-arn arn:aws:states:us-east-1:000000000000:stateMachine:csv-processing-workflow \
  --input '{"inputFile": "test.csv"}'
```

## 10. 制限事項とベストプラクティス

### 10.1 全体的な制限事項
- **パフォーマンス**: 実際のAWSより低速
- **スケーリング**: 単一マシン制限
- **ネットワーク**: レイテンシー・スループット特性の違い
- **IAM**: 完全な権限制御の再現不可
- **監視**: CloudWatch相当の監視機能なし

### 10.2 推奨ベストプラクティス
1. **段階的テスト**: ローカル → 開発環境 → 本番環境
2. **設定外部化**: 環境変数・設定ファイルでエンドポイント切り替え
3. **モックデータ**: 実際のデータ構造を模擬した開発用データ作成
4. **CI/CD統合**: GitHub ActionsでもLocalStack使用
5. **定期同期**: 本物のAWS環境との差分確認

### 10.3 コスト効果
- **開発コスト削減**: 約80-90%のAWS利用料削減
- **開発効率**: 迅速なフィードバックループ
- **学習コスト**: 各ツールの学習時間要
- **メンテナンス**: Docker環境の管理コスト

## 11. 結論

### 11.1 推奨構成
```
ローカル開発環境 = MinIO + LocalStack + AWS SAM Local + DynamoDB Local + PostgreSQL + local-data-api
```

### 11.2 実装優先度
1. **Phase 1**: AWS SAM Local + DynamoDB Local + PostgreSQL（基本Lambda開発）
2. **Phase 2**: MinIO追加（S3連携テスト）
3. **Phase 3**: LocalStack追加（EventBridge + Step Functions統合）
4. **Phase 4**: local-data-api追加（Aurora Data API対応）

### 11.3 期待効果
- 📈 **開発効率**: 50-70%向上
- 💰 **コスト削減**: 80-90%削減
- 🚀 **フィードバック**: 実時間テスト可能
- 🔧 **デバッグ**: ローカルデバッグ環境