# 監査ログ保存：DynamoDB vs Aurora比較検討

## 1. 比較概要

CSVユーザーログ処理の監査ログ（processing_logs）について、DynamoDBとAurora PostgreSQLのどちらが適しているかを比較検討します。

## 2. DynamoDBでの監査ログ保存

### 2.1 メリット

#### 2.1.1 コスト効率
- **オンデマンド課金**: 実際の読み書き操作のみ課金
- **低頻度アクセス**: 監査ログは書き込み中心で読み取り少ない
- **TTL機能**: 自動削除でストレージコスト削減
- **予想コスト**: 月額$1-3程度（個人開発規模）

#### 2.1.2 運用の簡素化
- **サーバーレス**: インフラ管理不要
- **自動スケーリング**: トラフィック変動に自動対応
- **TTL自動削除**: アーカイブ処理の実装不要
- **バックアップ**: ポイントインタイムリカバリ標準装備

#### 2.1.3 パフォーマンス
- **高速書き込み**: レイテンシ数ミリ秒
- **無制限スケール**: 同時書き込み性能に制限なし
- **パーティション分散**: ホットパーティション回避可能

#### 2.1.4 AWS統合性
- **ネイティブ統合**: Step Functions、Lambdaから直接アクセス
- **IAM統合**: きめ細かい権限制御
- **CloudWatch統合**: メトリクス・アラーム標準対応

### 2.2 デメリット

#### 2.2.1 クエリ制限
- **複雑クエリ不可**: JOINやサブクエリ不可
- **検索制限**: パーティションキー・ソートキーでの検索のみ
- **集計処理困難**: COUNT、SUMなどの集計処理が複雑
- **全テーブルスキャン**: 非効率で高コスト

#### 2.2.2 データ型制限
- **スキーマ柔軟性**: 構造化データの表現が複雑
- **データ型制限**: 数値の精度制限あり
- **NULL値**: 特殊な扱いが必要

#### 2.2.3 分析・レポート
- **BI ツール連携**: 直接連携が困難
- **SQL不可**: 標準SQLが使用不可
- **データエクスポート**: 分析時にS3経由が必要

### 2.3 DynamoDB設計例

```json
{
  "TableName": "ProcessingLogs",
  "KeySchema": [
    {"AttributeName": "executionName", "KeyType": "HASH"},
    {"AttributeName": "timestamp", "KeyType": "RANGE"}
  ],
  "AttributeDefinitions": [
    {"AttributeName": "executionName", "AttributeType": "S"},
    {"AttributeName": "timestamp", "AttributeType": "S"},
    {"AttributeName": "userId", "AttributeType": "S"}
  ],
  "GlobalSecondaryIndexes": [
    {
      "IndexName": "UserIdIndex",
      "KeySchema": [
        {"AttributeName": "userId", "KeyType": "HASH"},
        {"AttributeName": "timestamp", "KeyType": "RANGE"}
      ]
    }
  ],
  "BillingMode": "ON_DEMAND",
  "TimeToLiveSpecification": {
    "AttributeName": "ttl",
    "Enabled": true
  }
}
```

#### サンプルデータ
```json
{
  "executionName": "user-log-20250802-093000",
  "timestamp": "2025-08-02T09:30:15.123Z",
  "userId": "U00001",
  "processingType": "login_update",
  "oldValue": 10,
  "newValue": 12,
  "status": "success",
  "ttl": 1740787815  // 6ヶ月後の自動削除
}
```

## 3. Aurora PostgreSQLでの監査ログ保存

### 3.1 メリット

#### 3.1.1 データベース機能
- **SQL標準**: 複雑なクエリ・分析が可能
- **ACID特性**: トランザクション整合性保証
- **複雑クエリ**: JOIN、サブクエリ、ウィンドウ関数
- **集計処理**: GROUP BY、統計関数が豊富

#### 3.1.2 分析・レポート機能
- **BI ツール連携**: Tableau、Power BI等と直接連携
- **アドホッククエリ**: 柔軟な検索・分析
- **データ可視化**: グラフ・レポート作成が容易
- **統計分析**: 傾向分析、異常検知が可能

#### 3.1.3 データ管理
- **スキーマ設計**: 正規化、外部キー制約
- **データ型豊富**: JSON、配列、地理情報等
- **インデックス最適化**: パフォーマンスチューニング可能
- **ビュー機能**: 複雑なデータアクセスを簡素化

#### 3.1.4 運用・保守
- **バックアップ**: 自動バックアップ、ポイントインタイムリカバリ
- **パフォーマンス監視**: 詳細なメトリクス
- **アップグレード**: マイナーバージョン自動更新

### 3.2 デメリット

#### 3.2.1 コスト
- **固定コスト**: 最小ACU課金（Serverless V2でも0.5ACU）
- **ストレージ課金**: データ量に比例
- **バックアップ課金**: バックアップストレージ料金
- **予想コスト**: 月額$20-50程度（個人開発でも）

#### 3.2.2 運用複雑性
- **パフォーマンスチューニング**: インデックス設計が必要
- **容量管理**: 手動でのアーカイブ・削除処理
- **接続管理**: コネクションプール設定
- **セキュリティ**: VPC、セキュリティグループ設定

#### 3.2.3 スケーラビリティ
- **同時接続制限**: 最大接続数の制限
- **書き込み性能**: 大量同時書き込み時のボトルネック
- **リードレプリカ**: 読み取り専用レプリカが必要な場合

#### 3.2.4 AWS統合
- **VPC必須**: Lambda VPC接続で複雑性増加
- **コールドスタート**: VPC Lambda の起動遅延
- **ネットワーク設定**: ENI作成時間

## 4. 使用パターン別比較

### 4.1 書き込みパフォーマンス

| 項目 | DynamoDB | Aurora |
|------|----------|--------|
| 同時書き込み | 無制限 | 制限あり |
| レイテンシ | 1-10ms | 5-20ms |
| スループット | 無制限 | ACU依存 |
| バッチ処理 | BatchWriteItem | COPY文 |

### 4.2 読み取り・分析パフォーマンス

| 項目 | DynamoDB | Aurora |
|------|----------|--------|
| 単純検索 | 高速 | 高速 |
| 複雑クエリ | 困難 | 優秀 |
| 集計処理 | 制限あり | 豊富 |
| 全件検索 | 高コスト | 効率的 |

### 4.3 コスト比較（月額）

#### 想定条件
- 1日2,000レコード書き込み
- 月間60,000レコード
- データサイズ: 約15MB/月

| 項目 | DynamoDB | Aurora Serverless V2 |
|------|----------|---------------------|
| データ保存 | $1.5/月 | $1.5/月 |
| 最小課金 | $0 | $43/月（0.5ACU） |
| 読み書き | $0.5/月 | ACUに含む |
| バックアップ | $0.3/月 | $3/月 |
| **合計** | **約$2.3/月** | **約$47.5/月** |

## 5. 具体的な使用シーン別評価

### 5.1 シンプルな監査ログ（推奨：DynamoDB）

**要件**:
- エラー調査時の基本情報確認
- 処理履歴の記録
- 複雑な分析不要

**理由**:
- コスト効率が圧倒的
- TTL自動削除で運用が簡単
- Step Functionsから直接書き込み可能

### 5.2 詳細分析が必要（推奨：Aurora）

**要件**:
- ユーザー行動分析
- 統計レポート作成
- BI ツール連携
- 複雑な検索・集計

**理由**:
- SQL による柔軟な分析
- BI ツール直接連携
- 複雑クエリ対応

### 5.3 ハイブリッドアプローチ（推奨：用途による）

```python
# 基本ログ：DynamoDB（6ヶ月TTL）
basic_log = {
    'executionName': execution_name,
    'timestamp': timestamp,
    'userId': user_id,
    'status': status,
    'ttl': six_months_later
}
dynamodb.put_item(Item=basic_log)

# 分析用データ：Aurora（重要な変更のみ）
if status == 'success' and significant_change:
    aurora_log = {
        'execution_name': execution_name,
        'user_id': user_id,
        'old_value': old_value,
        'new_value': new_value,
        'change_amount': new_value - old_value
    }
    aurora.insert(aurora_log)
```

## 6. 推奨アプローチ

### 6.1 個人開発・小規模システム
**推奨：DynamoDB単体**
- 理由：コスト効率、運用簡素化
- 制限：複雑分析は別途ETL処理

### 6.2 中規模・分析重視システム
**推奨：ハイブリッドアプローチ**
- DynamoDB：全ログ（TTL 3ヶ月）
- Aurora：集計・分析用データ

### 6.3 大規模・企業システム
**推奨：Aurora単体（または + データレイク）**
- 理由：分析機能、トランザクション整合性
- 拡張：S3 + Athena での長期保存

## 7. 決定要因チェックリスト

| 要因 | DynamoDB優位 | Aurora優位 |
|------|-------------|-----------|
| 予算制約 | ✓ | |
| 運用工数削減 | ✓ | |
| 複雑な分析需要 | | ✓ |
| BI ツール連携 | | ✓ |
| SQL必須 | | ✓ |
| 高頻度書き込み | ✓ | |
| 長期保存 | | ✓ |
| トランザクション整合性 | | ✓ |

## まとめ

**個人開発のCSVユーザーログ処理システムの場合**：

1. **第一推奨：DynamoDB**
   - 月額$2-3で十分な監査機能
   - 運用負荷ゼロ
   - Step Functions直接統合

2. **Aurora検討条件**：
   - 月$50程度の予算確保可能
   - 詳細な分析・レポート機能が必要
   - SQL経験豊富

3. **ハイブリッド検討条件**：
   - 基本監査はシンプルに、分析は必要時のみ
   - 段階的なシステム成長を想定

コスト対効果を重視する個人開発では、**DynamoDB単体での監査ログ実装**が最も実用的な選択となります。