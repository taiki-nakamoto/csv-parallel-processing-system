# AWS開発環境のローカル構築調査

## 概要
AWSサービスをローカルでシミュレートするためのDockerベースの開発環境の調査結果をまとめる。各サービスの代替ソリューション、Docker設定、制限事項について詳細に記載する。

## 1. S3 - MinIO

### 概要
MinIOは高性能なS3互換オブジェクトストレージで、GNU AGPLv3ライセンスの下でオープンソース化されている。2024年現在でも最も信頼性の高いS3代替ソリューション。

### Docker設定

#### 基本的なDocker実行
```bash
docker run -p 9000:9000 -p 9001:9001 \
  quay.io/minio/minio server /data --console-address ":9001"
```

#### Docker Compose設定
```yaml
version: '3.7'
services:
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - ~/minio/data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
```

#### 分散構成のDocker Compose
```yaml
version: '3.7'
x-minio-common: &minio-common
  image: minio/minio:RELEASE.2025-04-22T22-12-26Z-cpuv1
  command: server --console-address ":9001" http://minio{1...2}/data{1...2}
  expose:
    - "9000"
    - "9001"
  environment:
    MINIO_ROOT_USER: admin
    MINIO_ROOT_PASSWORD: changeme
  healthcheck:
    test: ["CMD", "mc", "ready", "local"]
    interval: 5s
    timeout: 5s
    retries: 5

services:
  minio1:
    <<: *minio-common
    hostname: minio1
    volumes:
      - data1-1:/data1
      - data1-2:/data2

  minio2:
    <<: *minio-common
    hostname: minio2
    volumes:
      - data2-1:/data1
      - data2-2:/data2

volumes:
  data1-1:
  data1-2:
  data2-1:
  data2-2:
```

### S3 API互換性
- 豊富なS3 API サポート - 地球上で最も豊富なS3 APIサポートを提供
- PyTorch、Icebergなどの全AIスタックで動作
- 既存のS3ツールとの seamless integration
- 同じコードでAmazon S3とも使用可能

### 制限事項（2024年時点）

#### シングルサーバー構成の制限
- バージョニング、オブジェクトロック、バケットレプリケーションは動作しない
- これらの機能には分散配置（Erasure Coding）が必要
- 最小4ドライブ構成が推奨

#### API制限
- ListMultipartUploadsは正確なオブジェクト名をプレフィックスとして要求
- AbortIncompleteMultipartUpload lifecycle actionはPutBucketLifecycleでサポートされていない

#### ユーザー報告の課題
- 複雑なドキュメント
- 扱いにくいユーザーインターフェース
- 時々の安定性の懸念

### 推奨用途
- 本格的な開発・テスト環境
- DevOpsシナリオ
- S3 APIとの完全互換性が必要な場合

## 2. EventBridge

### AWS SAM Localサポート
AWS SAM単体ではEventBridgeを直接サポートしていないため、LocalStackまたはカスタムソリューションが必要。

### LocalStackによるEventBridge

#### Docker設定
```yaml
version: '3.8'
services:
  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=events,lambda,sqs,sns
      - DEBUG=1
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
```

#### EventBridge設定例
```bash
# イベントバス作成
aws events --endpoint-url http://localhost:4566 create-event-bus --name custom-event-bus

# イベントルール作成
aws events --endpoint-url http://localhost:4566 put-rule \
  --name send-events-to-queue-rule \
  --event-bus-name custom-event-bus \
  --event-pattern '{"detail-type": ["Account Created"]}'

# ターゲット設定
aws events --endpoint-url http://localhost:4566 put-targets \
  --event-bus-name custom-event-bus \
  --rule send-events-to-queue-rule \
  --targets "Id"="MyQueue","Arn"="arn:aws:sqs:eu-central-1:000000000000:MyQueue"
```

### SAMとLocalStackの統合
```yaml
# template.yaml での DockerNetwork設定
Globals:
  Function:
    Environment:
      Variables:
        AWS_ENDPOINT_URL: http://localstack:4566
```

### 機能サポート
- イベントバスとルール作成
- EventBridge Pipes (SQS、Kinesisサポート)
- イベントフィルタリング
- Lambdaによるイベント エンリッチメント

### 制限事項（2024年）
EventBridge Pipesの制限：
- Input transformersの欠如
- 並行性サポートの欠如（ParallelizationFactor）
- 高スループットシナリオでの処理速度低下
- パイプ状態のライフサイクル管理の欠如

## 3. Step Functions

### LocalStackによるStep Functions

#### サポート機能
- ステートマシンの作成、実行、更新、削除
- AWSサービス統合
- JSONataとvariablesサポート（2024年新機能）
- モックサービス統合

#### Docker設定
```yaml
version: '3.8'
services:
  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=stepfunctions,lambda,sqs,sns
      - DEBUG=1
      - STEPFUNCTIONS_LAMBDA_ENDPOINT=http://localhost:3001
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
```

#### 2024年の新機能
- JSONataサポート - JSONPathより豊富な機能
- Variables サポート - データの受渡しを簡素化
- Day zero access to new AWS capabilities

### AWS Step Functions Local（公式）

#### 重要な注意事項
- AWS公式だが「unsupported」で機能パリティなし
- サードパーティソリューション推奨

#### Docker設定
```bash
docker run -p 8083:8083 amazon/aws-stepfunctions-local
```

#### SAMとの統合
```yaml
# docker-compose.yml
version: '3.8'
services:
  step-functions-local:
    image: amazon/aws-stepfunctions-local
    ports:
      - "8083:8083"
    environment:
      - LAMBDA_ENDPOINT=http://sam-local:3001
  
  sam-local:
    build: .
    ports:
      - "3001:3001"
    command: sam local start-lambda --host 0.0.0.0 --port 3001
```

### 推奨アプローチ
2024年現在、LocalStackが最も活発に保守されており、新しいAWS Step Functions機能への迅速な対応を提供している。

## 4. Lambda

### AWS SAM Localの機能

#### 核心機能
- ローカルDockerコンテナでのLambda関数構築
- AWS Lambdaに似たローカル環境をコンテナとして提供
- サーバーレスアプリケーションの構築、テスト、デバッグ

#### 主要テストコマンド
```bash
# 個別関数のテスト
sam local invoke

# ローカルHTTPサーバーでのAPI Gatewayシミュレーション
sam local start-api

# AWS CLIとSDK経由でのLambda呼び出し
sam local start-lambda
```

#### コンテナイメージサポート
- 最大10GBのコンテナイメージとしてのLambda関数パッケージング
- sam build での container image 管理

#### Docker設定オプション
```bash
# アーキテクチャサポートの設定（Linux）
docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

# カスタムDockerネットワーク
sam local start-api --docker-network my-network

# ホスト名とIPマッピング
sam local invoke --add-host example.com:127.0.0.1
```

#### 2024年の更新
- AWS SAM CLI version 1.47.0以降でDocker runtime代替サポート
- host.docker.internal を使用したコンテナ間通信
- arm64関数のx86_64マシンでの実行サポート

### ベストプラクティス
- .aws-samディレクトリがある場合は、コード更新時に毎回 sam build 実行
- sam build 後に sam local start-lambda でテスト
- コンテナベースイメージ使用時は docker build によるDockerfileの使用

### 制限事項
- AWS サービスの挙動は完全にクラウドと同一ではない
- S3トリガー、DynamoDBストリーム、SQSキューなどのイベントソースは異なる挙動

## 5. DynamoDB

### AWS SAM LocalとDynamoDB

#### Docker設定

##### 基本的な実行
```bash
docker run -p 8000:8000 amazon/dynamodb-local
```

##### Docker Compose設定
```yaml
version: '3.8'
services:
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: dynamodb-local
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath ./data"
    ports:
      - "8000:8000"
    volumes:
      - "./docker/dynamodb:/home/dynamodblocal/data"
    working_dir: /home/dynamodblocal
```

#### ネットワーク設定

##### Dockerネットワーク作成
```bash
docker network create local-dev
```

##### DynamoDB起動（ネットワーク付き）
```bash
docker run -d -v "$PWD":/dynamodb_local_db -p 8000:8000 \
  --network local-dev --network-alias=dynamodb --name dynamodb \
  amazon/dynamodb-local
```

##### SAM起動（ネットワーク付き）
```bash
sam local start-api --docker-network local-dev
```

#### Lambda関数でのDynamoDB接続

##### Python例
```python
import os
import boto3

if os.getenv("AWS_SAM_LOCAL"):
    votes_table = boto3.resource(
        'dynamodb', 
        endpoint_url="http://host.docker.internal:8000/"
    ).Table("spaces-tabs-votes")
else:
    votes_table = boto3.resource('dynamodb').Table(os.getenv('TABLE_NAME'))
```

##### Node.js例
```javascript
if(process.env.AWS_SAM_LOCAL) {
    options.endpoint = new AWS.Endpoint('http://dynamodb:8000')
}
```

#### テスト確認
```bash
aws dynamodb list-tables --endpoint-url http://localhost:8000
```

### 2024年の考慮事項

#### パフォーマンス最適化
LocalStackでは環境変数 `DYNAMODB_IN_MEMORY=1` でインメモリ実行可能（永続化なし）

#### ネットワークエイリアス
ユーザー定義ネットワークでのみエイリアス動作（デフォルトブリッジでは動作しない）

#### 認証情報
ローカル実行時は有効なAWSキーは不要だが、アクセスキーとシークレットキーの指定は必要

## 6. Aurora/PostgreSQL

### Aurora Serverless ローカルシミュレーション

#### local-data-api（推奨ソリューション）

##### 概要
- koxudaxiによるオープンソースプロジェクト
- MySQLとPostgreSQLサーバーでのローカルテスト実行
- RESTfulリクエストをSQL文に変換する「プロキシサーバー」として動作

##### Docker設定
```bash
docker run --rm -it --name my-data-api -p 8080:80 \
  -e ENGINE=PostgreSQLJDBC \
  -e POSTGRES_HOST=<YOUR_POSTGRESQL_HOSTNAME> \
  -e POSTGRES_PORT=<YOUR_POSTGRESQL_PORT> \
  -e POSTGRES_USER=<YOUR_POSTGRESQL_USERNAME> \
  -e POSTGRES_PASSWORD=<YOUR_POSTGRESQL_PASSWORD> \
  -e RESOURCE_ARN=arn:aws:rds:us-east-1:123456789012:cluster:dummy \
  -e SECRET_ARN=arn:aws:secretsmanager:us-east-1:123456789012:secret:dummy \
  koxudaxi/local-data-api
```

##### Docker Compose設定
```yaml
version: '3.1'
services:
  local-data-api:
    image: koxudaxi/local-data-api
    restart: always
    environment:
      ENGINE: PostgreSQLJDBC
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: example
      RESOURCE_ARN: 'arn:aws:rds:us-east-1:123456789012:cluster:dummy'
      SECRET_ARN: 'arn:aws:secretsmanager:us-east-1:123456789012:secret:dummy'
    ports:
      - "8080:80"
    depends_on:
      - db
  
  db:
    image: postgres:13-alpine
    restart: always
    environment:
      POSTGRES_PASSWORD: example
      POSTGRES_DB: test
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### PostgreSQL Docker設定

#### スタンドアロンPostgreSQL
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:13
    container_name: local-postgres
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

volumes:
  postgres_data:
```

### Aurora Serverless v2 (2024年更新)

#### 重要な変更点
- スケールゼロのサポート終了
- 最小容量0.5 ACUでアイドル時も維持
- コスト影響への考慮が必要

#### 開発フレームワークサポート
SSTフレームワークではdev modeでAuroraデプロイをスキップし、ローカルPostgresに接続可能

### ローカル/Aurora間の移行

#### 開発上の利点
- HTTP経由のData API接続（永続接続なし）
- VPNやSSHトンネル不要
- Kotlin（JDBC driver使用）による実際のData API動作の忠実な再現

#### 制限事項
- Dockerコンテナは再起動時に終了
- Data API特有の接続方式への対応が必要

## 統合Docker Compose例

### 完全な開発環境構成
```yaml
version: '3.8'
services:
  # MinIO (S3代替)
  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

  # LocalStack (EventBridge、Step Functions)
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      - SERVICES=events,stepfunctions,lambda,sqs,sns,secretsmanager
      - DEBUG=1
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - localstack_data:/tmp/localstack

  # DynamoDB Local
  dynamodb:
    image: amazon/dynamodb-local:latest
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath ./data"
    volumes:
      - dynamodb_data:/home/dynamodblocal/data

  # PostgreSQL (Aurora代替)
  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Local Data API (Aurora Serverless Data API代替)
  local-data-api:
    image: koxudaxi/local-data-api
    ports:
      - "8080:80"
    environment:
      ENGINE: PostgreSQLJDBC
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      RESOURCE_ARN: 'arn:aws:rds:us-east-1:123456789012:cluster:dummy'
      SECRET_ARN: 'arn:aws:secretsmanager:us-east-1:123456789012:secret:dummy'
    depends_on:
      - postgres

volumes:
  minio_data:
  localstack_data:
  dynamodb_data:
  postgres_data:

networks:
  default:
    name: aws-local-dev
```

## まとめと推奨事項

### 各サービスの推奨ソリューション

1. **S3**: MinIO - 最も成熟した S3 代替、本格的な開発に適している
2. **EventBridge**: LocalStack - 活発な開発、豊富な機能サポート
3. **Step Functions**: LocalStack - 2024年新機能への迅速対応
4. **Lambda**: AWS SAM Local - 公式サポート、豊富なテスト機能
5. **DynamoDB**: DynamoDB Local - AWS公式、SAMとの優秀な統合
6. **Aurora/PostgreSQL**: PostgreSQL + local-data-api - Data API互換性

### 開発環境構築の考慮事項

#### ネットワーク設定
- カスタムDockerネットワークの使用を推奨
- コンテナ間通信には service name や network alias を使用
- SAM Local使用時は `--docker-network` オプション必須

#### パフォーマンス最適化
- 本格的な負荷テストには分散MinIO構成
- DynamoDB Local のインメモリオプション活用
- 必要なサービスのみを起動してリソース節約

#### セキュリティと認証
- ローカル環境では簡易な認証情報で動作
- 本番環境への移行時は適切な認証設定に変更必要

この調査結果を基に、プロジェクトの要件に応じて最適な構成を選択し、段階的に開発環境を構築することを推奨する。